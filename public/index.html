<!DOCTYPE html>
<html>

<head>
    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

    
    <title>Homepage - Semantic</title>
    <link rel="stylesheet" type="text/css" href="/static/css/semantic.min.css">
    <style type="text/css">
        .hidden.menu {
            display: none;
        }
        
        .masthead.segment {
            min-height: 200px;
            padding: 1em 0em;
        }
        
        .masthead .logo.item img {
            margin-right: 1em;
        }
        
        .masthead .ui.menu .ui.button {
            margin-left: 0.5em;
        }
        
        @font-face {
            font-family: 'myHan';
            src: URL('/static/fonts/HYGuoQiangXingShuW-1.ttf') format('truetype');
        }
        
        .han {
            font-weight: normal;
            font-family: "myHan";
        }
        
        .masthead h1.ui.header {
            margin-top: 1em;
            margin-bottom: 0em;
            font-size: 2.33em;
        }
        
        .masthead h2 {
            font-size: 1.7em;
        }
        
        .ui.vertical.stripe {
            padding: 8em 0em;
        }
        
        .ui.vertical.stripe h3 {
            font-size: 2em;
        }
        
        .ui.vertical.stripe .button+h3,
        .ui.vertical.stripe p+h3 {
            margin-top: 3em;
        }
        
        .ui.vertical.stripe .floated.image {
            clear: both;
        }
        
        .ui.vertical.stripe p {
            font-size: 1.33em;
        }
        
        .ui.vertical.stripe .horizontal.divider {
            margin: 3em 0em;
        }
        
        .quote.stripe.segment {
            padding: 0em;
        }
        
        .quote.stripe.segment .grid .column {
            padding-top: 5em;
            padding-bottom: 5em;
        }
        
        .footer.segment {
            padding: 5em 0em;
        }
        
        .secondary.pointing.menu .toc.item {
            display: none;
        }
        
        @media only screen and (max-width: 700px) {
            .ui.fixed.menu {
                display: none !important;
            }
            .secondary.pointing.menu .item,
            .secondary.pointing.menu .menu {
                display: none;
            }
            .secondary.pointing.menu .toc.item {
                display: block;
            }
            .masthead.segment {
                min-height: 350px;
            }
            .masthead h1.ui.header {
                font-size: 2em;
                margin-top: 1.5em;
            }
            .masthead h2 {
                margin-top: 0.5em;
                font-size: 1.5em;
            }
        }
    </style>

    <script src="/static/js/jquery.min.js"></script>
    <script src="/static/js/semantic.js"></script>
    <script>
        $(document)
            .ready(function() {

                
                $('.masthead')
                    .visibility({
                        once: false,
                        onBottomPassed: function() {
                            $('.fixed.menu').transition('fade in');
                        },
                        onBottomPassedReverse: function() {
                            $('.fixed.menu').transition('fade out');
                        }
                    });

                
                $('.ui.sidebar')
                    .sidebar('attach events', '.toc.item');

            });
    </script>
</head>

<body>

    
    <div class="ui large top fixed hidden menu">
        <div class="ui container nav">
            <a class="active item">é¦–é¡µ</a></a>
            <a class="item">Category</a>
            <a class="item">æ ‡ç­¾</a>
            <a class="item">About</a>
            <div class="right item">
                <div class="ui animated fade button" tabindex="0">
                    <div class="visible content">èµ‹æ­¤é—´ä¸€æŠ¹ä¸¹ç ‚</div>
                    <div class="hidden content"><a href="">æ¸…ç‹‚</a></div>
                </div>
            </div>
        </div>
    </div>

    
    <div class="ui vertical inverted sidebar menu">
        <a class="active item">é¦–é¡µ</a>
        <a class="item">å½’æ¡£</a>
        <a class="item">æ ‡ç­¾</a>
        <a class="item">å…³äº</a>
    </div>


    
    <div class="pusher">
        <div class="ui inverted vertical masthead center aligned segment">

            <div class="ui container">
                <div class="ui large secondary inverted pointing menu">
                    <a class="toc item">
                        <i class="sidebar icon"></i>
                    </a>
                    <div class="left item">
                        <a class="ui inverted button" href="/">æ¸… | ç‹‚</a>
                    </div>
                    <div class="right item">
                        <a class="active item" href="/">Home</a>
                        <a class="item">åˆ†ç±»</a>
                        <a class="item">Tags</a>
                        <a class="item">å…³äºæˆ‘</a>

                    </div>
                </div>
            </div>

            <div class="ui text container">
                <h1 class="ui inverted header">
                    <span class="han">
                    ä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œå°±æ˜¯è¦å†™ä¸€å¥è¯æ”¾è¿™é‡Œ!
                    </span>
                </h1>
                <h2 class="han">Do whatever you want when you want to.</h2>
            </div>

        </div>

        <div class="ui vertical stripe segment">
            <div class="ui text container">
                
                <h3 class="ui header">(ç¿»è¯‘)writing a Static Blog Generator in Go</h3>
                <div class="postContent">
                    <p>ç¿»è¯‘åŸæ–‡ï¼š<a href="https://zupzup.org/static-blog-generator-go/?utm_source=golangweekly&amp;utm_medium=emai">https://zupzup.org/static-blog-generator-go/?utm_source=golangweekly&amp;utm_medium=emai</a></p>

<h1>Writing a Static Blog Generator in Go ä½¿ç”¨Goå†™ä¸€ä¸ªé™æ€åšå®¢ç”Ÿæˆå™¨</h1>

<p>A static-site-generator is a tool which, given some input (e.g. markdown) generates a fully static website using HTML, CSS and JavaScript.</p>

<p>ä¸€ä¸ªé™æ€ç½‘ç«™ç”Ÿæˆå™¨æ˜¯ä¸€ä¸ªä½¿ç”¨HTML, CSS and JavaScript,å°†ç»™äºˆçš„è¾“å…¥æ–‡ä»¶ï¼ˆä¾‹å¦‚markdownï¼‰ç”Ÿæˆå®Œæ•´çš„é™æ€ç½‘ç«™</p>

<p>Why is this cool? Well, for one itâ€™s a lot easier to host a static site and itâ€™s also (usually) quite a bit faster and resource-friendly. Static sites arenâ€™t the best choice for all use-cases, but for mostly non-interactive websites such as blogs they are great.</p>

<p>ä¸ºä»€ä¹ˆè¿™å¾ˆCoolï¼Ÿæ˜¯çš„ï¼Œå¯¹äºä¸€ä¸ªäººæ¥è¯´ï¼Œä¸»æŒä¸€ä¸ªé™æ€çš„ç½‘ç«™è¦å®¹æ˜“å¾—å¤šï¼Œè€Œä¸”(é€šå¸¸)ä¹Ÿä¼šæ›´å¿«ï¼Œè€Œä¸”èµ„æºæ›´å‹å¥½ã€‚é™æ€ç½‘ç«™ä¸æ˜¯å¯¹æ‰€æœ‰æƒ…å†µéƒ½æ˜¯æœ€å¥½çš„é€‰æ‹©ï¼Œä½†æ˜¯å¯¹äºå¤§å¤šæ•°éäº¤äº’ç½‘ç«™æ¯”å¦‚åšå®¢ï¼Œæ˜¯éå¸¸å¥½çš„ã€‚</p>

<p>In this post, I will describe the static blog generator I wrote in Go, which powers this blog.</p>

<p>åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†æè¿°æˆ‘ä½¿ç”¨Goç¼–å†™çš„é™æ€åšå®¢ç”Ÿæˆå™¨ï¼Œå®ƒä¸ºè¿™ä¸ªåšå®¢æä¾›äº†å¼ºå¤§çš„åŠŸèƒ½ã€‚</p>

<h2>Motivation åŠ¨æœº</h2>

<p>You might be familiar with static-site-generators like the great Hugo, which has just about all the features one could hope for in regards to static site generation.</p>

<p>ä½ å¯èƒ½å¯¹åƒHugoè¿™æ ·çš„é™æ€ç«™ç‚¹ç”Ÿæˆå™¨å¾ˆç†Ÿæ‚‰ï¼Œå®ƒæ‹¥æœ‰å…³äºé™æ€ç«™ç‚¹ç”Ÿæˆçš„æ‰€æœ‰ç‰¹æ€§ã€‚</p>

<p>So why would I write another tool just like it with fewer capabilities? The reason was twofold.</p>

<p>æ‰€ä»¥æˆ‘ä¸ºä»€ä¹ˆå†™å¦å¤–ä¸€ä¸ªåƒå®ƒä¸€æ ·ä½†åŠŸèƒ½æ›´å°‘çš„å·¥å…·ï¼ŸåŸå› æœ‰ä¸¤ä¸ªã€‚</p>

<p>One reason was that I wanted to dive deeper into Go and a command-line-based static-site-generator seemed like a great playground to hone my skills.</p>

<p>ä¸€ä¸ªåŸå› æ˜¯æˆ‘æƒ³è¦æ·±å…¥å­¦ä¹ Goï¼Œä¸€ä¸ªåŸºäºå‘½ä»¤è¡Œçš„é™æ€åšå®¢ç”Ÿæˆå™¨ä¼¼ä¹æ˜¯ä¸€ä¸ªç£¨ç»ƒæˆ‘æŠ€èƒ½çš„å¥½åœ°æ–¹ã€‚</p>

<p>The second reason was simply that I had never done it before. Iâ€™ve done my fair share of web-development, but I never created a static-site-generator.</p>

<p>ç¬¬äºŒä¸ªåŸå› æ˜¯ï¼Œæˆ‘ä»¥å‰ä»æœªåšè¿‡è¿™ä¸ªã€‚æˆ‘åšè¿‡æˆ‘çš„webå¼€å‘çš„åˆ†äº«ï¼Œä½†æˆ‘ä»æœªåˆ›å»ºè¿‡é™æ€ç«™ç‚¹ç”Ÿæˆå™¨ã€‚</p>

<p>This made it intriguing because I theoretically had all the prerequisites and skills to build such a tool with my background in web-development, but I had never tried doing it.</p>

<p>è¿™å¾ˆæœ‰è¶£ï¼Œå› ä¸ºæˆ‘åœ¨ç†è®ºä¸Šå…·å¤‡äº†åœ¨webå¼€å‘èƒŒæ™¯ä¸‹æ„å»ºè¿™æ ·ä¸€ä¸ªå·¥å…·çš„æ‰€æœ‰å…ˆå†³æ¡ä»¶å’ŒæŠ€èƒ½ï¼Œä½†æˆ‘ä»æœªå°è¯•è¿‡è¿™æ ·åšã€‚</p>

<p>I was hooked, implemented it within about 2 weeks and had a great time doing it. I used my blog-generator for creating this blog and it worked great so far. :)</p>

<p>æˆ‘è¢«è¿·ä½äº†ï¼Œåœ¨å¤§çº¦ä¸¤å‘¨çš„æ—¶é—´å†…å®ç°äº†å®ƒï¼Œåœ¨å®ç°çš„æ—¶å€™æˆ‘å¾ˆé«˜å…´ã€‚æˆ‘ç”¨æˆ‘çš„åšå®¢ç”Ÿæˆå™¨åˆ›å»ºäº†è¿™ä¸ªåšå®¢ï¼Œåˆ°ç›®å‰ä¸ºæ­¢æ•ˆæœå¾ˆå¥½ã€‚:)</p>

<h2>Concept æ¦‚å¿µ</h2>

<p>Early on, I decided to write my blog posts in markdown and keep them in a GitHub Repo. The posts are structured in folders, which represent the url of the blog post.</p>

<p>æ—©äº›æ—¶å€™ï¼Œæˆ‘å†³å®šä½¿ç”¨markdownå†™æˆ‘çš„åšå®¢æ–‡ç« ï¼Œå¹¶å°†ä»–ä»¬æ”¾åœ¨githubçš„ä»“åº“ï¼ˆrepoï¼‰ä¸­ã€‚æ–‡ç« ä»¥æ–‡ä»¶å¤¹ä¸ºç»“æ„ï¼Œä»£è¡¨äº†åšå®¢æ–‡ç« çš„url</p>

<p>For metadata, such as publication date, tags, title and subtitle I decided on keeping a meta.yml file with each post.md file with the following format:</p>

<p>è‡³äºmetadataï¼Œä¾‹å¦‚å‘å¸ƒæ—¥æœŸï¼Œæ ‡ç­¾ï¼Œæ ‡é¢˜å’Œå‰¯æ ‡é¢˜ï¼Œæˆ‘å†³å®šä½¿ç”¨meta.ymlï¼Œæ¯ä¸ªå¸–å­éƒ½æœ‰ä»¥ä¸‹çš„æ ¼å¼ï¼š</p>

<pre><code>title: Playing Around with BoltDB 
short: &#34;Looking for a simple key/value store for your Go applications? Look no further!&#34;
date: 20.04.2017
tags:
    - golang
    - go
    - boltdb
    - bolt
</code></pre>

<p>This allowed me to separate the content from the metadata, but still keep everything in the same place, where Iâ€™d find it later.</p>

<p>è¿™å…è®¸æˆ‘åis allowed me to separate the content from the metadata, but still keep everything in the same place, where Iâ€™d find it later.</p>

<p>è¿™å…è®¸æˆ‘å°†å†…å®¹ä»metadataä¸­åˆ†ç¦»ï¼Œä½†æ˜¯éœ€è¦å°†æ‰€æœ‰ä¸œè¥¿æ”¾åœ¨åŒä¸€ä¸ªåœ°æ–¹ï¼Œè®©æˆ‘èƒ½å¾…ä¼šå„¿èƒ½æ‰¾åˆ°å®ƒã€‚</p>

<p>The GitHub Repo was my data source. The next step was to think about features and I came up with this List:</p>

<p>github repoæ˜¯æˆ‘çš„æ•°æ®æ¥æºã€‚ä¸‹ä¸€æ­¥æ˜¯è€ƒè™‘ç‰¹æ€§ï¼Œæˆ‘æƒ³åˆ°äº†ä»¥ä¸‹å†…å®¹ï¼š</p>

<ul>
<li>Very Lean (landing page should be 1 Request &lt; 10K gzipped)éå¸¸è½»é‡ã€‚ï¼ˆç™»å½•é¡µé¢åº”è¯¥1ä¸ªè¯·æ±‚å°äº10kï¼‰</li>
<li>Listing for the landing page and an Archive å±•ç¤º</li>
<li>Possibility to use syntax-highlighted Code and Images within Blog Posts åœ¨æ–‡ç« ä¸­èƒ½å¤Ÿä½¿ç”¨è¯­æ³•é«˜äº®ä»£ç ï¼Œå›¾ç‰‡</li>
<li>Tags æ ‡ç­¾</li>
<li>RSS feed (index.xml) RSSè®¢é˜…</li>
<li>Optional Static Pages (e.g. About) å¯é€‰çš„é™æ€é¡µé¢ï¼ˆä¾‹å¦‚ï¼šAboutï¼‰</li>
<li>High Maintainability - use the least amount of templates possible é«˜å¯ç»´æŠ¤æ€§-ä½¿å°½å¯èƒ½å°‘çš„æ¨¡æ¿</li>
<li>sitemap.xml for SEO ç”¨äºSEOçš„sitemap.xml</li>
<li>Local preview of the whole blog (a simple run.sh script)æœ¬åœ°çš„æ•´ä¸ªåšå®¢çš„é¢„è§ˆ(ç®€å•çš„run.shè„šæœ¬)</li>
</ul>

<p>Quite a healthy feature set. What was very important for me from the start, was to keep everything simple, fast and clean - without any third-party trackers or ads, which compromise privacy and slow everything down.</p>

<p>ç›¸å½“å¥å£®çš„ç‰¹æ€§é›†.å¯¹æˆ‘æ¥è¯´æœ€å¼€å§‹æœ€é‡è¦çš„ï¼Œæ˜¯ä¿æŒæ‰€æœ‰çš„ä¸œè¥¿éƒ½è¦ç®€å•ï¼Œå¿«é€Ÿå’Œå¹²å‡€ â€“ æ²¡æœ‰ä»»ä½•ç¬¬ä¸‰æ–¹çš„è·Ÿè¸ªå™¨å’Œå¹¿å‘Šï¼Œä¿è¯éšç§å’Œä½¿æ‰€æœ‰äº‹æƒ…éƒ½æ”¾ç¼“ã€‚</p>

<p>Based on these ideas, I started making a rough plan of the architecture and started coding.</p>

<p>åŸºäºè¿™äº›æƒ³æ³•ï¼Œæˆ‘å¼€å§‹å¯¹æ¶æ„è¿›è¡Œç²—ç•¥çš„è§„åˆ’ï¼Œå¹¶å¼€å§‹ç¼–å†™ä»£ç ã€‚</p>

<h2>Architectural Overview æ¶æ„æ¦‚è¿°</h2>

<p>The application is simple enough. The high-level elements are:</p>

<p>ç¨‹åºè¶³å¤Ÿç®€å•ã€‚é«˜ç­‰çº§çš„å…ƒç´ å¦‚ä¸‹ï¼š</p>

<ul>
<li>CLI å‘½ä»¤è¡Œç•Œé¢</li>
<li>DataSource æ•°æ®æº</li>
<li>Generators ç”Ÿæˆå™¨</li>
</ul>

<p>The CLI in this case is very simple, as I didnâ€™t add any features in terms of configurability. It basically just fetches data from the DataSource and runs the Generators on it.</p>

<p>åœ¨è¿™é‡ŒCLIéå¸¸ç®€å•ï¼Œå› ä¸ºæˆ‘æ²¡æœ‰åœ¨å¯é…ç½®æ€§æ–¹é¢æ·»åŠ ä»»ä½•ç‰¹æ€§ã€‚ä»…ä»…æ˜¯ä»DataSourceä¸­è·å–æ•°æ® ï¼Œå¹¶ä½¿ç”¨ç”Ÿæˆå™¨è¿è¡Œå®ƒã€‚</p>

<p>The DataSource interface looks like this:</p>

<p>DotaSourceæ¥å£é•¿è¿™æ ·ï¼š</p>

<pre><span class="kwd">type</span> <span class="typ">DataSource</span> <span class="kwd">interface</span> <span class="pun">{</span>
    <span class="typ">Fetch</span><span class="pun">(</span><span class="kwd">from</span><span class="pun">,</span> <span class="pln">to</span> <span class="pln">string</span><span class="pun">)</span> <span class="pun">(</span><span class="pun">[</span><span class="pun">]</span><span class="pln">string</span><span class="pun">,</span> <span class="pln">error</span><span class="pun">)</span>
<span class="pun">}</span>
</pre>

<p>The Generator interface looks like this:
ç”Ÿæˆå™¨æ¥å£é•¿è¿™æ ·ï¼š</p>

<pre><span class="kwd">type</span> <span class="typ">Generator</span> <span class="kwd">interface</span> <span class="pun">{</span>
    <span class="typ">Generate</span><span class="pun">(</span><span class="pun">)</span> <span class="pln">error</span>
<span class="pun">}</span>
</pre>

<p>Pretty simple. Each Generator also receives a configuration struct, which contains all the necessary data for generation.</p>

<p>ç›¸å½“ç®€å•ã€‚æ¯ä¸€ä¸ªç”Ÿæˆå™¨éƒ½æ¥å—ä¸€ä¸ªé…ç½®çš„ç»“æ„ä½“ï¼ŒåŒ…å«äº†æ‰€æœ‰éœ€è¦çš„ä¿¡æ¯ã€‚</p>

<p>There are 7 Generators at the time of writing this post:</p>

<p>å†™è¿™ç¯‡æ–‡ç« çš„æ—¶å€™ï¼Œæœ‰äº†7ä¸ªç”Ÿæˆå™¨ã€‚</p>

<ul>
<li>SiteGenerator</li>
<li>ListingGenerator</li>
<li>PostGenerator</li>
<li>RSSGenerator</li>
<li>SitemapGenerator</li>
<li>StaticsGenerator</li>
<li>TagsGenerator
Where the SiteGenerator is the meta-generator, which calls all other generators and outputs the whole static website.</li>
</ul>

<p>SiteGeneratoræ˜¯meta-generatorè°ƒç”¨å…¶ä»–æ‰€æœ‰çš„ç”Ÿæˆå™¨å¹¶è¾“å‡ºæ•´ä¸ªé™æ€ç½‘ç«™çš„åœ°æ–¹ã€‚</p>

<p>The generation is based on HTML templates using Goâ€™s html/template package.</p>

<p>ç”Ÿæˆå™¨åŸºäºHTMLæ¨¡æ¿ï¼Œä½¿ç”¨Goçš„html/template package.</p>

<h2>Implementation Details å®ç°ç»†èŠ‚</h2>

<p>In this section I will just cover a few selected parts I think might be interesting, such as the git DataSource and the different Generators.</p>

<p>åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘å°†ä»‹ç»ä¸€äº›æˆ‘è®¤ä¸ºå¯èƒ½å¾ˆæœ‰è¶£çš„éƒ¨åˆ†ï¼Œå¦‚gitæ•°æ®æºå’Œä¸åŒçš„ç”Ÿæˆå™¨ã€‚</p>

<h3>DataSource</h3>

<p>First up, we need some data to generate our blog from. This data, as mentioned above has the form of a git repository. The following Fetch function captures most of what the DataSource implementation does:</p>

<p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸€äº›æ•°æ®æ¥ç”Ÿæˆæˆ‘ä»¬çš„åšå®¢ã€‚å¦‚ä¸Šæ‰€è¿°ï¼Œè¿™äº›æ•°æ®å…·æœ‰gitå­˜å‚¨åº“çš„å½¢å¼ã€‚ä¸‹é¢çš„Fetchå‡½æ•°å±•ç¤ºäº†å¤§å¤šæ•°æ•°æ®æºå®ç°çš„åŠŸèƒ½:</p>

<pre><span class="kwd">func</span> <span class="pun">(</span><span class="pln">ds</span> <span class="pun">*</span><span class="typ">GitDataSource</span><span class="pun">)</span> <span class="typ">Fetch</span><span class="pun">(</span><span class="kwd">from</span><span class="pun">,</span> <span class="pln">to</span> <span class="pln">string</span><span class="pun">)</span> <span class="pun">(</span><span class="pun">[</span><span class="pun">]</span><span class="pln">string</span><span class="pun">,</span> <span class="pln">error</span><span class="pun">)</span> <span class="pun">{</span>
    <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;Fetching data from %s into %s...\n&#34;</span><span class="pun">,</span> <span class="kwd">from</span><span class="pun">,</span> <span class="pln">to</span><span class="pun">)</span>
    <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">createFolderIfNotExist</span><span class="pun">(</span><span class="pln">to</span><span class="pun">)</span><span class="pun">;</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
        <span class="kwd">return</span> <span class="kwd">nil</span><span class="pun">,</span> <span class="pln">err</span>
    <span class="pun">}</span>
    <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">clearFolder</span><span class="pun">(</span><span class="pln">to</span><span class="pun">)</span><span class="pun">;</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
        <span class="kwd">return</span> <span class="kwd">nil</span><span class="pun">,</span> <span class="pln">err</span>
    <span class="pun">}</span>
    <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">cloneRepo</span><span class="pun">(</span><span class="pln">to</span><span class="pun">,</span> <span class="kwd">from</span><span class="pun">)</span><span class="pun">;</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
        <span class="kwd">return</span> <span class="kwd">nil</span><span class="pun">,</span> <span class="pln">err</span>
    <span class="pun">}</span>
    <span class="pln">dirs</span><span class="pun">,</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">getContentFolders</span><span class="pun">(</span><span class="pln">to</span><span class="pun">)</span>
    <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
        <span class="kwd">return</span> <span class="kwd">nil</span><span class="pun">,</span> <span class="pln">err</span>
    <span class="pun">}</span>
    <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Print</span><span class="pun">(</span><span class="str">&#34;Fetching complete.\n&#34;</span><span class="pun">)</span>
    <span class="kwd">return</span> <span class="pln">dirs</span><span class="pun">,</span> <span class="kwd">nil</span>
<span class="pun">}</span>
</pre>

<p>Fetch is called with two parameters from, which is a repository URL and to, which is the destination folder. The function creates and clears the destination folder, clones the repository using os/exec plus a git command and finally reads the folder, returning a list of paths for all the files within the repository.</p>

<p>Fetchä½¿ç”¨2ä¸ªå‚æ•°æ¥è°ƒç”¨ï¼Œä¸€ä¸ªæ˜¯repoçš„url ï¼Œä¸€ä¸ªæ˜¯ç›®æ ‡çš„æ–‡ä»¶å¤¹ã€‚è¿™ä¸ªå‡½æ•°åˆ›å»ºå¹¶æ¸…é™¤ç›®æ ‡æ–‡ä»¶å¤¹ï¼Œä½¿ç”¨os/execæ·»åŠ ä¸€ä¸ªgitå‘½ä»¤å…‹éš†repoï¼Œæœ€åè¯»å–æ–‡ä»¶å¤¹ï¼Œè¿”å›repoä¸­çš„æ‰€æœ‰æ–‡ä»¶çš„è·¯å¾„åˆ—è¡¨</p>

<p>As mentioned above, the repository contains only folders, which represent the different blog posts. The array with these folder paths is then passed to the generators, which can then do their thing for each of the blog posts within the repository.</p>

<p>å¦‚ä¸Šæ‰€è¯´ï¼Œè¿™ä¸ªrepoä»…ä»…åŒ…å«æ–‡ä»¶å¤¹ï¼Œä»£è¡¨ç€ä¸åŒåšå®¢çš„æ–‡ç« ã€‚å°†è¿™äº›æ–‡ä»¶å¤¹è·¯å¾„çš„æ•°æ®ä¼ é€’ç»™ç”Ÿæˆå™¨ï¼Œ</p>

<h3>Kicking it all off å¼€å§‹å®Œæˆæ‰€æœ‰çš„ç›®æ ‡</h3>

<p>After the Fetch comes the Generate phase. When the blog-generator is executed, the following code is executed on the highest level:</p>

<p>åœ¨Fetchä¹‹åï¼Œæ¥ä¸‹æ¥æ˜¯Generateé˜¶æ®µã€‚å½“blog-generatoræ‰§è¡Œçš„æ—¶å€™ï¼Œä¸‹é¢çš„ä»£ç ä¼šæœ€å…ˆæ‰§è¡Œã€‚</p>

<pre><span class="pln">ds</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">datasource</span><span class="pun">.</span><span class="typ">New</span><span class="pun">(</span><span class="pun">)</span>
<span class="pln">dirs</span><span class="pun">,</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">ds</span><span class="pun">.</span><span class="typ">Fetch</span><span class="pun">(</span><span class="typ">RepoURL</span><span class="pun">,</span> <span class="typ">TmpFolder</span><span class="pun">)</span>
<span class="kwd">if</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
    <span class="pln">log</span><span class="pun">.</span><span class="typ">Fatal</span><span class="pun">(</span><span class="pln">err</span><span class="pun">)</span>
<span class="pun">}</span>
<span class="pln">g</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">generator</span><span class="pun">.</span><span class="typ">New</span><span class="pun">(</span><span class="pun">&amp;</span><span class="pln">generator</span><span class="pun">.</span><span class="typ">SiteConfig</span><span class="pun">{</span>
    <span class="typ">Sources</span><span class="pun">:</span>     <span class="pln">dirs</span><span class="pun">,</span>
    <span class="typ">Destination</span><span class="pun">:</span> <span class="typ">DestFolder</span><span class="pun">,</span>
<span class="pun">}</span><span class="pun">)</span>
<span class="pln">err</span> <span class="pun">=</span> <span class="pln">g</span><span class="pun">.</span><span class="typ">Generate</span><span class="pun">(</span><span class="pun">)</span>
<span class="kwd">if</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
    <span class="pln">log</span><span class="pun">.</span><span class="typ">Fatal</span><span class="pun">(</span><span class="pln">err</span><span class="pun">)</span>
<span class="pun">}</span>
</pre>

<p>The generator.New function creates a new SiteGenerator which is basically a generator, which calls other generators. Itâ€™s passed a destination folder and the directories for the blog posts within the repository.</p>

<p>generate.Newå‡½æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„SiteGenerateï¼ŒSiteGenerateæ˜¯ä¸€ä¸ªåŸºæœ¬çš„ç”Ÿæˆå™¨ï¼Œå®ƒè°ƒç”¨å…¶ä»–ç”Ÿæˆå™¨ã€‚éœ€è¦ä¼ é€’ç›®æ ‡æ–‡ä»¶å¤¹å’Œç”Ÿæˆåœ¨repoä¸­åšå®¢æ–‡ç« çš„ç›®å½•ã€‚</p>

<p>As every Generator implementing the interface mentioned above, the SiteGenerator has a Generate method, which returns an error. The Generate method of the SiteGenerator prepares the destination folder, reads in templates, prepares data structures for the blog posts, registers the other generators and concurrently runs them.</p>

<p>æ­£å¦‚ä¸Šé¢æåˆ°çš„æ¯ä¸€ä¸ªç”Ÿæˆå™¨æ¥å£çš„å®ç°ï¼ŒSiteGenerateæœ‰ä¸€ä¸ªè¿”å›errorçš„Generateæ–¹æ³•ã€‚SiteGenerateçš„Generateçš„æ–¹æ³•å‡†å¤‡äº†ç›®æ ‡æ–‡ä»¶å¤¹ï¼Œè¯»å–æ¨¡æ¿ï¼Œå‡†å¤‡åšå®¢æ–‡ç« çš„æ•°æ®ç»“æ„ï¼Œæ³¨å†Œå…¶ä»–ç”Ÿæˆå™¨å¹¶ä¸”å¹¶å‘æ‰§è¡Œä»–ä»¬ã€‚</p>

<p>The SiteGenerator also registers some settings for the blog like the URL, Language, Date Format etc. These settings are simply global constants, which is certainly not the prettiest solution or the most scalable, but itâ€™s simple and that was the highest goal here.</p>

<p>SiteGenerateåŒæ ·æ³¨å†Œäº†ä¸€äº›æ–‡ç« çš„è®¾ç½®ï¼Œä¾‹å¦‚URLï¼Œè¯­è¨€ï¼Œæ•°æ®æ ¼å¼ç­‰ç­‰ã€‚è¿™äº›è®¾ç½®æ˜¯ç®€å•çš„å…¨å±€å¸¸é‡ï¼Œè¿™å½“ç„¶ä¸æ˜¯æœ€å¥½çš„è§£å†³åŠæ³•ä¹Ÿä¸æ˜¯æœ€æœ‰æ‰©å±•æ€§çš„ï¼Œä½†æ˜¯å®ƒå¾ˆç®€å•ï¼Œå¹¶ä¸”åœ¨è¿™é‡Œï¼Œè¿™æ˜¯æˆ‘ä»¬çš„æœ€é«˜ç›®æ ‡ã€‚</p>

<h3>Posts</h3>

<p>The most important concept on a blog are - surprise, surprise - blog posts! In the context of this blog-generator, they are represented by the following data-structure:</p>

<p>åšå®¢æœ€é‡è¦çš„æ¦‚å¿µå°±æ˜¯åšå®¢çš„æ–‡ç« ã€‚åœ¨è¿™ä¸ªblog-ç”Ÿæˆå™¨çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œå®ƒä»¬ç”±ä»¥ä¸‹æ•°æ®ç»“æ„è¡¨ç¤º:</p>

<pre><span class="kwd">type</span> <span class="typ">Post</span> <span class="kwd">struct</span> <span class="pun">{</span>
    <span class="typ">Name</span>      <span class="pln">string</span>
    <span class="typ">HTML</span>      <span class="pun">[</span><span class="pun">]</span><span class="kwd">byte</span>
    <span class="typ">Meta</span>      <span class="pun">*</span><span class="typ">Meta</span>
    <span class="typ">ImagesDir</span> <span class="pln">string</span>
    <span class="typ">Images</span>    <span class="pun">[</span><span class="pun">]</span><span class="pln">string</span>
<span class="pun">}</span>
</pre>

<p>These posts are created by iterating over the folders in the repository, reading the meta.yml file, converting the post.md file to HTML and by adding images, if there are any.</p>

<p>è¿™äº›æ–‡ç« æ˜¯é€šè¿‡åœ¨å­˜å‚¨åº“ä¸­çš„æ–‡ä»¶å¤¹ä¸­è¿­ä»£æ¥åˆ›å»ºçš„ï¼Œè¯»å–meta.ymlæ–‡ä»¶ï¼Œè½¬æ¢post.mdæ–‡ä»¶åˆ°HTMLï¼Œå¦‚æœæœ‰å›¾åƒçš„è¯æ·»åŠ å›¾åƒã€‚</p>

<p>Quite a bit of work, but once we have the posts represented as a data structure, the generation of posts is quite simple and looks like this:</p>

<p>åšäº†å¾ˆå¤šå·¥ä½œï¼Œä½†æ˜¯ä¸€æ—¦æˆ‘ä»¬çš„postè¢«è¡¨ç¤ºä¸ºæ•°æ®ç»“æ„ï¼Œæ–‡ç« çš„ç”Ÿæˆå°±å¾ˆç®€å•äº†ï¼Œçœ‹èµ·æ¥å°±åƒè¿™æ ·:</p>

<pre><span class="kwd">func</span> <span class="pun">(</span><span class="pln">g</span> <span class="pun">*</span><span class="typ">PostGenerator</span><span class="pun">)</span> <span class="typ">Generate</span><span class="pun">(</span><span class="pun">)</span> <span class="pln">error</span> <span class="pun">{</span>
    <span class="pln">post</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">g</span><span class="pun">.</span><span class="typ">Config</span><span class="pun">.</span><span class="typ">Post</span>
    <span class="pln">destination</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">g</span><span class="pun">.</span><span class="typ">Config</span><span class="pun">.</span><span class="typ">Destination</span>
    <span class="pln">t</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">g</span><span class="pun">.</span><span class="typ">Config</span><span class="pun">.</span><span class="typ">Template</span>
    <span class="pln">staticPath</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Sprintf</span><span class="pun">(</span><span class="str">&#34;%s%s&#34;</span><span class="pun">,</span> <span class="pln">destination</span><span class="pun">,</span> <span class="pln">post</span><span class="pun">.</span><span class="typ">Name</span><span class="pun">)</span>
    <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">os</span><span class="pun">.</span><span class="typ">Mkdir</span><span class="pun">(</span><span class="pln">staticPath</span><span class="pun">,</span> <span class="pln">os</span><span class="pun">.</span><span class="typ">ModePerm</span><span class="pun">)</span><span class="pun">;</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
      <span class="kwd">return</span> <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Errorf</span><span class="pun">(</span><span class="str">&#34;error creating directory at %s: %v&#34;</span><span class="pun">,</span> <span class="pln">staticPath</span><span class="pun">,</span> <span class="pln">err</span><span class="pun">)</span>
    <span class="pun">}</span>
    <span class="kwd">if</span> <span class="pln">post</span><span class="pun">.</span><span class="typ">ImagesDir</span> <span class="pun">!</span><span class="pun">=</span> <span class="str">&#34;&#34;</span> <span class="pun">{</span>
      <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">copyImagesDir</span><span class="pun">(</span><span class="pln">post</span><span class="pun">.</span><span class="typ">ImagesDir</span><span class="pun">,</span> <span class="pln">staticPath</span><span class="pun">)</span><span class="pun">;</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
          <span class="kwd">return</span> <span class="pln">err</span>
      <span class="pun">}</span>
    <span class="pun">}</span>
    <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">writeIndexHTML</span><span class="pun">(</span><span class="pln">staticPath</span><span class="pun">,</span> <span class="pln">post</span><span class="pun">.</span><span class="typ">Meta</span><span class="pun">.</span><span class="typ">Title</span><span class="pun">,</span> <span class="kwd">template</span><span class="pun">.</span><span class="typ">HTML</span><span class="pun">(</span><span class="pln">string</span><span class="pun">(</span><span class="pln">post</span><span class="pun">.</span><span class="typ">HTML</span><span class="pun">)</span><span class="pun">)</span><span class="pun">,</span> <span class="pln">t</span><span class="pun">)</span><span class="pun">;</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
      <span class="kwd">return</span> <span class="pln">err</span>
    <span class="pun">}</span>
    <span class="kwd">return</span> <span class="kwd">nil</span>
<span class="pun">}</span>
</pre>

<p>First, we create a directory for the post, then we copy the images in there and finally create the postâ€™s index.html file using templating. The PostGenerator also implements syntax-highlighting, which I described in this post.</p>

<p>é¦–å…ˆï¼Œæˆ‘ä»¬ç»™poståˆ›å»ºä¸€ä¸ªç›®å½•ï¼Œç„¶åå¤åˆ¶å›¾ç‰‡åˆ°è¿™é‡Œï¼Œæœ€åä½¿ç”¨æ¨¡æ¿åˆ›å»ºpostçš„index.htmlã€‚æˆ‘åœ¨æœ¬æ–‡ä¸­è¯´äº†ï¼ŒPostGenerateå®ç°äº†è¯­æ³•é«˜äº®ã€‚</p>

<h3>Listing Creation æ¸…å•åˆ›å»º</h3>

<p>When a user comes to the landing page of the blog, she sees the latest posts with information like the reading time of the article and a short description. For this feature and for the archive, I implemented the ListingGenerator, which takes the following config:</p>

<p>å½“ä¸€ä¸ªç”¨æˆ·è®¿é—®åšå®¢ç™»å½•ç•Œé¢çš„æ—¶å€™ï¼Œå¥¹ä¼šçœ‹åˆ°æœ€è¿‘çš„æ–‡ç« çš„ä¿¡æ¯ï¼Œä¾‹å¦‚é˜…è¯»æ–‡ç« éœ€è¦çš„æ—¶é—´å’Œç®€å•çš„æè¿°ã€‚ä¸ºäº†è¿™ä¸ªç‰¹æ€§å¹¶ä¸”ä¸ºäº†å­˜æ¡£ï¼Œæˆ‘ä»¬å®ç°äº†ListingGeneratorï¼Œä½¿ç”¨äº†å¦‚ä¸‹çš„é…ç½®ï¼š</p>

<pre><span class="kwd">type</span> <span class="typ">ListingConfig</span> <span class="kwd">struct</span> <span class="pun">{</span>
    <span class="typ">Posts</span>                  <span class="pun">[</span><span class="pun">]</span><span class="pun">*</span><span class="typ">Post</span>
    <span class="typ">Template</span>               <span class="pun">*</span><span class="kwd">template</span><span class="pun">.</span><span class="typ">Template</span>
    <span class="typ">Destination</span><span class="pun">,</span> <span class="typ">PageTitle</span> <span class="pln">string</span>
<span class="pun">}</span>
</pre>

<p>The Generate method of this generator iterates over the post, assembles their metadata and creates short blocks based on the given template. Then these blocks are appended and written to the index template.</p>

<p>è¿™ä¸ªç”Ÿæˆå™¨çš„ç”Ÿæˆæ–¹æ³•åœ¨postä¸Šè¿­ä»£ï¼Œç»„è£…å®ƒä»¬çš„å…ƒæ•°æ®ï¼Œå¹¶æ ¹æ®ç»™å®šçš„æ¨¡æ¿åˆ›å»ºçŸ­å—ã€‚ç„¶åå°†è¿™äº›å—é™„åŠ åˆ°ç´¢å¼•æ¨¡æ¿ä¸­ã€‚</p>

<p>I liked mediumâ€™s feature to approximate the time to read an article, so I implemented my own version of it, based on the assumption that an average human reads about 200 words per minute. Images also count towards the overall reading time with a constant 12 seconds added for each img tag in the post. This will obviously not scale for arbitrary content, but should be a fine approximation for my usual articles:</p>

<p>æˆ‘å–œæ¬¢é˜…è¯»æ–‡ç« çš„è¿‘ä¼¼æ—¶é—´çš„åª’ä½“ç‰¹æ€§ï¼Œæ‰€ä»¥æˆ‘å®ç°äº†è‡ªå·±çš„ç‰ˆæœ¬ã€‚å‡è®¾äººç±»å‡­å€Ÿæ¯åˆ†é’Ÿé˜…è¯»200ä¸ªå•è¯ã€‚å›¾ç‰‡åŒæ ·è®¡å…¥æ€»é˜…è¯»æ—¶é—´ï¼Œä»¥æ¯å¼ å›¾12ç§’è®¡ç®—ã€‚è¿™æ˜¾ç„¶ä¸é€‚åˆä»»æ„å†…å®¹ï¼Œä½†å¾ˆé€‚åˆæˆ‘çš„æ–‡ç« ã€‚</p>

<pre><span class="kwd">func</span> <span class="pln">calculateTimeToRead</span><span class="pun">(</span><span class="pln">input</span> <span class="pln">string</span><span class="pun">)</span> <span class="pln">string</span> <span class="pun">{</span>
    <span class="com">// an average human reads about 200 wpm</span>
    <span class="kwd">var</span> <span class="pln">secondsPerWord</span> <span class="pun">=</span> <span class="dec">60.0</span> <span class="pun">/</span> <span class="dec">200.0</span>
    <span class="com">// multiply with the amount of words</span>
    <span class="pln">words</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">secondsPerWord</span> <span class="pun">*</span> <span class="kwd">float64</span><span class="pun">(</span><span class="pln">len</span><span class="pun">(</span><span class="pln">strings</span><span class="pun">.</span><span class="typ">Split</span><span class="pun">(</span><span class="pln">input</span><span class="pun">,</span> <span class="str">&#34; &#34;</span><span class="pun">)</span><span class="pun">)</span><span class="pun">)</span>
    <span class="com">// add 12 seconds for each image</span>
    <span class="pln">images</span> <span class="pun">:</span><span class="pun">=</span> <span class="dec">12.0</span> <span class="pun">*</span> <span class="pln">strings</span><span class="pun">.</span><span class="typ">Count</span><span class="pun">(</span><span class="pln">input</span><span class="pun">,</span> <span class="str">&#34;&lt;img&#34;</span><span class="pun">)</span>
    <span class="pln">result</span> <span class="pun">:</span><span class="pun">=</span> <span class="pun">(</span><span class="pln">words</span> <span class="pun">+</span> <span class="kwd">float64</span><span class="pun">(</span><span class="pln">images</span><span class="pun">)</span><span class="pun">)</span> <span class="pun">/</span> <span class="dec">60.0</span>
    <span class="kwd">if</span> <span class="pln">result</span> <span class="pun">&lt;</span> <span class="dec">1.0</span> <span class="pun">{</span>
        <span class="pln">result</span> <span class="pun">=</span> <span class="dec">1.0</span>
    <span class="pun">}</span>
    <span class="kwd">return</span> <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Sprintf</span><span class="pun">(</span><span class="str">&#34;%.0fm&#34;</span><span class="pun">,</span> <span class="pln">result</span><span class="pun">)</span>
<span class="pun">}</span>
</pre>

<h3>Tags æ ‡ç­¾</h3>

<p>Next, to have a way to categorize and filter the posts by topic, I opted to implement a simple tagging mechanism. Posts have a list of tags in their meta.yml file. These tags should be listed on a separate Tags Page and upon clicking on a tag, the user is supposed to see a listing of posts with the selected tag.</p>

<p>æ¥ä¸‹æ¥ï¼Œä¸ºäº†åˆ†ç±»å’Œé€šè¿‡ä¸»é¢˜è¿‡æ»¤æ–‡ç« ï¼Œæˆ‘é€‰æ‹©å®ç°ä¸€ä¸ªç®€å•çš„æ ‡ç­¾æœºåˆ¶ã€‚æ–‡ç« åœ¨meta.ymlä¸­æœ‰æ ‡ç­¾åˆ—è¡¨ã€‚è¿™äº›æ ‡ç­¾åº”è¯¥åœ¨ç‹¬ç«‹çš„æ ‡ç­¾é¡µä¸­ï¼Œæ ¹æ®ç‚¹å‡»ä¸€ä¸ªæ ‡ç­¾ï¼Œç”¨æˆ·åº”è¯¥èƒ½çœ‹åˆ°è¿™ä¸ªæ ‡ç­¾çš„æ–‡ç« åˆ—è¡¨ã€‚</p>

<p>First up, we create a map from tag to Post:</p>

<p>é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºæ ‡ç­¾åˆ°æ–‡ç« çš„æ˜ å°„è¡¨ã€‚</p>

<pre><span class="kwd">func</span> <span class="pln">createTagPostsMap</span><span class="pun">(</span><span class="pln">posts</span> <span class="pun">[</span><span class="pun">]</span><span class="pun">*</span><span class="typ">Post</span><span class="pun">)</span> <span class="kwd">map</span><span class="pun">[</span><span class="pln">string</span><span class="pun">]</span><span class="pun">[</span><span class="pun">]</span><span class="pun">*</span><span class="typ">Post</span> <span class="pun">{</span>
<span class="pln">result</span> <span class="pun">:</span><span class="pun">=</span> <span class="kwd">make</span><span class="pun">(</span><span class="kwd">map</span><span class="pun">[</span><span class="pln">string</span><span class="pun">]</span><span class="pun">[</span><span class="pun">]</span><span class="pun">*</span><span class="typ">Post</span><span class="pun">)</span>
    <span class="kwd">for</span> <span class="pln">_</span><span class="pun">,</span> <span class="pln">post</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">range</span> <span class="pln">posts</span> <span class="pun">{</span>
        <span class="kwd">for</span> <span class="pln">_</span><span class="pun">,</span> <span class="pln">tag</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">range</span> <span class="pln">post</span><span class="pun">.</span><span class="typ">Meta</span><span class="pun">.</span><span class="typ">Tags</span> <span class="pun">{</span>
            <span class="pln">key</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">strings</span><span class="pun">.</span><span class="typ">ToLower</span><span class="pun">(</span><span class="pln">tag</span><span class="pun">)</span>
             <span class="kwd">if</span> <span class="pln">result</span><span class="pun">[</span><span class="pln">key</span><span class="pun">]</span> <span class="pun">=</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
                 <span class="pln">result</span><span class="pun">[</span><span class="pln">key</span><span class="pun">]</span> <span class="pun">=</span> <span class="pun">[</span><span class="pun">]</span><span class="pun">*</span><span class="typ">Post</span><span class="pun">{</span><span class="pln">post</span><span class="pun">}</span>
             <span class="pun">}</span> <span class="kwd">else</span> <span class="pun">{</span>
                 <span class="pln">result</span><span class="pun">[</span><span class="pln">key</span><span class="pun">]</span> <span class="pun">=</span> <span class="kwd">append</span><span class="pun">(</span><span class="pln">result</span><span class="pun">[</span><span class="pln">key</span><span class="pun">]</span><span class="pun">,</span> <span class="pln">post</span><span class="pun">)</span>
             <span class="pun">}</span>
        <span class="pun">}</span>
    <span class="pun">}</span>
    <span class="kwd">return</span> <span class="pln">result</span>
<span class="pun">}</span>
</pre>

<p>Then, there are two tasks to implement:</p>

<p>ç„¶åï¼Œæœ‰ä¸¤ä¸ªä»»åŠ¡è¦å»å®ç°</p>

<ul>
<li>Tags Page æ ‡ç­¾é¡µ</li>
<li>List of Posts for a selected Tag å±•ç¤ºé€‰æ‹©çš„æ ‡ç­¾çš„æ–‡ç« å•Š
The data structure of a Tag looks like this:</li>
</ul>

<p>æ•°æ®ç»“æ„å¦‚ä¸‹</p>

<pre><span class="kwd">type</span> <span class="typ">Tag</span> <span class="kwd">struct</span> <span class="pun">{</span>
    <span class="typ">Name</span>  <span class="pln">string</span>
    <span class="typ">Link</span>  <span class="pln">string</span>
    <span class="typ">Count</span> <span class="kwd">int</span>
<span class="pun">}</span>
</pre>

<p>So, we have the actual tag (Name), the Link to the tagâ€™s listing page and the amount of posts with this tag. These tags are created from the tagPostsMap and then sorted by Count descending:</p>

<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬æœ‰å®é™…çš„æ ‡ç­¾ï¼ˆåï¼‰ï¼Œæ ‡ç­¾åˆ—è¡¨é¡µçš„è¿æ¥å’Œè¿™ä¸ªæ ‡ç­¾çš„æ–‡ç« ã€‚è¿™äº›æ ‡ç­¾ç”±tagPostMapåˆ›å»ºï¼Œç„¶åæ ¹æ®æ•°ç›®é™åºæ’åˆ—ã€‚</p>

<pre><span class="pln">tags</span> <span class="pun">:</span><span class="pun">=</span> <span class="pun">[</span><span class="pun">]</span><span class="pun">*</span><span class="typ">Tag</span><span class="pun">{</span><span class="pun">}</span>
<span class="kwd">for</span> <span class="pln">tag</span><span class="pun">,</span> <span class="pln">posts</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">range</span> <span class="pln">tagPostsMap</span> <span class="pun">{</span>
    <span class="pln">tags</span> <span class="pun">=</span> <span class="kwd">append</span><span class="pun">(</span><span class="pln">tags</span><span class="pun">,</span> <span class="pun">&amp;</span><span class="typ">Tag</span><span class="pun">{</span><span class="typ">Name</span><span class="pun">:</span> <span class="pln">tag</span><span class="pun">,</span> <span class="typ">Link</span><span class="pun">:</span> <span class="pln">getTagLink</span><span class="pun">(</span><span class="pln">tag</span><span class="pun">)</span><span class="pun">,</span> <span class="typ">Count</span><span class="pun">:</span> <span class="pln">len</span><span class="pun">(</span><span class="pln">posts</span><span class="pun">)</span><span class="pun">}</span><span class="pun">)</span>
<span class="pun">}</span>
<span class="pln">sort</span><span class="pun">.</span><span class="typ">Sort</span><span class="pun">(</span><span class="typ">ByCountDesc</span><span class="pun">(</span><span class="pln">tags</span><span class="pun">)</span><span class="pun">)</span>
</pre>

<p>The Tags Page basically just consists of this list rendered into the tags/index.html file.</p>

<p>æ ‡ç­¾é¡µä»…ä»…ç”±æ¸²æŸ“åˆ°tags/index.htmlçš„æ–‡ä»¶ç»„æˆ</p>

<p>The List of Posts for a selected Tag can be achieved using the ListingGenerator described above. We just need to iterate the tags, create a folder for each tag, select the posts to display and generate a listing for them.</p>

<p>é€‰æ‹©çš„æ ‡ç­¾çš„æ–‡ç« åˆ—è¡¨èƒ½è¢«å­˜æ¡£ï¼Œä½¿ç”¨ä¸Šé¢çš„ListingGeneratorã€‚æˆ‘ä»¬ä»…ä»…éœ€è¦è¿­ä»£æ ‡ç­¾ï¼Œç»™æ¯ä¸€ä¸ªæ ‡ç­¾åˆ›å»ºæ–‡ä»¶å¤¹ï¼Œé€‰æ‹©é€‰æ‹©æ–‡ç« å±•ç¤ºå¹¶ç”Ÿæˆåˆ—è¡¨</p>

<h3>Sitemap &amp; RSS</h3>

<p>To improve searchability on the web, itâ€™s a good idea to have a sitemap.xml which can be crawled by bots. Creating such a file is fairly straightforward and can be done using the Go standard library.</p>

<p>ä¸ºäº†æé«˜ç½‘ç«™çš„æœç´¢èƒ½åŠ›ï¼Œæœ‰ä¸ªå¥½ä¸»æ„æ˜¯æ‹¥æœ‰ä¸€ä¸ªsitemap.xmlï¼Œå®ƒèƒ½å¤Ÿè¢«botsçˆ¬åˆ°ã€‚åˆ›å»ºè¿™æ ·çš„ä¸€ä¸ªæ–‡ä»¶ç›¸å½“ç®€å•ï¼Œä½¿ç”¨Goçš„æ ‡å‡†åº“å°±å¯ä»¥äº†ã€‚</p>

<p>In this tool, however, I opted to use the great etree library, which provides a nice API for creating and reading XML.</p>

<p>ä½†æ˜¯åœ¨è¿™ä¸ªå·¥å…·é‡Œï¼Œæˆ‘é€‰æ‹©ä½¿ç”¨<a href="https://github.com/beevik/etree">etree</a>åº“ï¼Œå®ƒæä¾›åˆ›å»ºä¸ªè¯»å–xmléå¸¸å¥½ç”¨çš„APIã€‚</p>

<p>The SitemapGenerator uses this config:</p>

<p>SitemapGeneratorä½¿ç”¨è¿™ä¸ªé…ç½®ï¼š</p>

<pre><span class="kwd">type</span> <span class="typ">SitemapConfig</span> <span class="kwd">struct</span> <span class="pun">{</span>
    <span class="typ">Posts</span>       <span class="pun">[</span><span class="pun">]</span><span class="pun">*</span><span class="typ">Post</span>
    <span class="typ">TagPostsMap</span> <span class="kwd">map</span><span class="pun">[</span><span class="pln">string</span><span class="pun">]</span><span class="pun">[</span><span class="pun">]</span><span class="pun">*</span><span class="typ">Post</span>
    <span class="typ">Destination</span> <span class="pln">string</span>
<span class="pun">}</span>
</pre>

<p>blog-generator takes a basic approach to the sitemap and just generates url and image locations by using the addURL function:</p>

<p>blog-generatorå¯¹ç«™ç‚¹åœ°å›¾è¿›è¡Œäº†åŸºæœ¬çš„å¤„ç†ï¼Œå¹¶é€šè¿‡ä½¿ç”¨addURLå‡½æ•°ç”Ÿæˆurlå’Œå›¾åƒä½ç½®ã€‚</p>

<pre><span class="kwd">func</span> <span class="pln">addURL</span><span class="pun">(</span><span class="pln">element</span> <span class="pun">*</span><span class="pln">etree</span><span class="pun">.</span><span class="typ">Element</span><span class="pun">,</span> <span class="pln">location</span> <span class="pln">string</span><span class="pun">,</span> <span class="pln">images</span> <span class="pun">[</span><span class="pun">]</span><span class="pln">string</span><span class="pun">)</span> <span class="pun">{</span>
    <span class="pln">url</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">element</span><span class="pun">.</span><span class="typ">CreateElement</span><span class="pun">(</span><span class="str">&#34;url&#34;</span><span class="pun">)</span>
     <span class="pln">loc</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">url</span><span class="pun">.</span><span class="typ">CreateElement</span><span class="pun">(</span><span class="str">&#34;loc&#34;</span><span class="pun">)</span>
     <span class="pln">loc</span><span class="pun">.</span><span class="typ">SetText</span><span class="pun">(</span><span class="pln">fmt</span><span class="pun">.</span><span class="typ">Sprintf</span><span class="pun">(</span><span class="str">&#34;%s/%s/&#34;</span><span class="pun">,</span> <span class="pln">blogURL</span><span class="pun">,</span> <span class="pln">location</span><span class="pun">)</span><span class="pun">)</span>

     <span class="kwd">if</span> <span class="pln">len</span><span class="pun">(</span><span class="pln">images</span><span class="pun">)</span> <span class="pun">&gt;</span> <span class="dec">0</span> <span class="pun">{</span>
         <span class="kwd">for</span> <span class="pln">_</span><span class="pun">,</span> <span class="pln">image</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">range</span> <span class="pln">images</span> <span class="pun">{</span>
            <span class="pln">img</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">url</span><span class="pun">.</span><span class="typ">CreateElement</span><span class="pun">(</span><span class="str">&#34;image:image&#34;</span><span class="pun">)</span>
             <span class="pln">imgLoc</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">img</span><span class="pun">.</span><span class="typ">CreateElement</span><span class="pun">(</span><span class="str">&#34;image:loc&#34;</span><span class="pun">)</span>
             <span class="pln">imgLoc</span><span class="pun">.</span><span class="typ">SetText</span><span class="pun">(</span><span class="pln">fmt</span><span class="pun">.</span><span class="typ">Sprintf</span><span class="pun">(</span><span class="str">&#34;%s/%s/images/%s&#34;</span><span class="pun">,</span> <span class="pln">blogURL</span><span class="pun">,</span> <span class="pln">location</span><span class="pun">,</span> <span class="pln">image</span><span class="pun">)</span><span class="pun">)</span>
         <span class="pun">}</span>
     <span class="pun">}</span>
<span class="pun">}</span>
</pre>

<p>After creating the XML document with etree, itâ€™s just saved to a file and stored in the output folder.</p>

<p>ä½¿ç”¨etreeåˆ›å»ºxmlæ–‡ä»¶ä¹‹åï¼Œä¿å­˜å¹¶å­˜å‚¨æ–‡ä»¶åˆ°æ–‡ä»¶å¤¹ä¸­ã€‚</p>

<p>RSS generation works the same way - iterate all posts and create XML entries for each post, then write to index.xml.</p>

<p>Rssç”Ÿæˆå™¨ä½¿ç”¨åŒæ ·çš„æ–¹æ³•ç”Ÿæˆ - éå†æ‰€æœ‰æ–‡ç« å¹¶ä¸ºæ¯ä¸ªpoståˆ›å»ºXMLæ¡ç›®ï¼Œç„¶åå°†å…¶å†™å…¥index.XMLã€‚</p>

<h3>Handling Statics</h3>

<p>The last concept I needed were entirely static assets like a favicon.ico or a static page like About. To do this, the tool runs the StaticsGenerator with this config:</p>

<p>æˆ‘æ‰€éœ€è¦çš„æœ€åä¸€ä¸ªæ¦‚å¿µæ˜¯å®Œå…¨é™æ€çš„èµ„æºï¼Œæ¯”å¦‚favicon.icoæˆ–é™æ€é¡µé¢ä¾‹å¦‚Aboutã€‚ä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼Œè¯¥å·¥å…·ä½¿ç”¨è¿™ä¸ªé…ç½®æ¥è¿è¡ŒStaticsGenerator:</p>

<pre><span class="kwd">type</span> <span class="typ">StaticsConfig</span> <span class="kwd">struct</span> <span class="pun">{</span>
    <span class="typ">FileToDestination</span> <span class="kwd">map</span><span class="pun">[</span><span class="pln">string</span><span class="pun">]</span><span class="pln">string</span>
    <span class="typ">TemplateToFile</span>    <span class="kwd">map</span><span class="pun">[</span><span class="pln">string</span><span class="pun">]</span><span class="pln">string</span>
    <span class="typ">Template</span>          <span class="pun">*</span><span class="kwd">template</span><span class="pun">.</span><span class="typ">Template</span>
<span class="pun">}</span>
</pre>

<p>The FileToDestination-map represents static files like images or the robots.txt and TemplateToFile is a mapping from templates in the static folder to their designated output path.</p>

<p>FileToDestination-mapè¡¨ç¤ºåƒå›¾ç‰‡æˆ–è€…robot.txtçš„é™æ€æ–‡ä»¶ï¼ŒTemplateToFilesæ˜¯ä»é™æ€æ–‡ä»¶å¤¹ä¸­çš„æ¨¡æ¿åˆ°æŒ‡å®šçš„è¾“å‡ºè·¯å¾„çš„æ˜ å°„ã€‚</p>

<p>This configuration could look like this in practice:</p>

<p>å®é™…ä¸Šï¼Œé…ç½®æ–‡ä»¶æ˜¯è¿™æ ·çš„ï¼š</p>

<pre><span class="pln">fileToDestination</span> <span class="pun">:</span><span class="pun">=</span> <span class="kwd">map</span><span class="pun">[</span><span class="pln">string</span><span class="pun">]</span><span class="pln">string</span><span class="pun">{</span>
    <span class="str">&#34;static/favicon.ico&#34;</span><span class="pun">:</span> <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Sprintf</span><span class="pun">(</span><span class="str">&#34;%s/favicon.ico&#34;</span><span class="pun">,</span> <span class="pln">destination</span><span class="pun">)</span><span class="pun">,</span>
    <span class="str">&#34;static/robots.txt&#34;</span><span class="pun">:</span>  <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Sprintf</span><span class="pun">(</span><span class="str">&#34;%s/robots.txt&#34;</span><span class="pun">,</span> <span class="pln">destination</span><span class="pun">)</span><span class="pun">,</span>
    <span class="str">&#34;static/about.png&#34;</span><span class="pun">:</span>   <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Sprintf</span><span class="pun">(</span><span class="str">&#34;%s/about.png&#34;</span><span class="pun">,</span> <span class="pln">destination</span><span class="pun">)</span><span class="pun">,</span>
<span class="pun">}</span>
<span class="pln">templateToFile</span> <span class="pun">:</span><span class="pun">=</span> <span class="kwd">map</span><span class="pun">[</span><span class="pln">string</span><span class="pun">]</span><span class="pln">string</span><span class="pun">{</span>
    <span class="str">&#34;static/about.html&#34;</span><span class="pun">:</span> <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Sprintf</span><span class="pun">(</span><span class="str">&#34;%s/about/index.html&#34;</span><span class="pun">,</span> <span class="pln">destination</span><span class="pun">)</span><span class="pun">,</span>
<span class="pun">}</span>
<span class="pln">statg</span> <span class="pun">:</span><span class="pun">=</span> <span class="typ">StaticsGenerator</span><span class="pun">{</span><span class="pun">&amp;</span><span class="typ">StaticsConfig</span><span class="pun">{</span>
<span class="typ">FileToDestination</span><span class="pun">:</span> <span class="pln">fileToDestination</span><span class="pun">,</span>
   <span class="typ">TemplateToFile</span><span class="pun">:</span>    <span class="pln">templateToFile</span><span class="pun">,</span>
   <span class="typ">Template</span><span class="pun">:</span>          <span class="pln">t</span><span class="pun">,</span>
<span class="pun">}</span><span class="pun">}</span>
</pre>

<p>The code for generating these statics is not particularly interesting - as you can imagine, the files are just iterated and copied to the given destination.</p>

<p>ç”Ÿæˆè¿™äº›é™æ€æ–‡ä»¶çš„ä»£ç ä¸æ˜¯å¾ˆæœ‰è¶£ - æ­£å¦‚ä½ æƒ³çš„é‚£æ ·ï¼Œä»…ä»…å°±æ˜¯éå†æ–‡ä»¶ï¼Œå¹¶å¤åˆ¶åˆ°ç›®æ ‡åœ°ç‚¹</p>

<h3>Parallel Execution å¹¶è¡Œæ‰§è¡Œ</h3>

<p>For blog-generator to be fast, the generators are all run in parallel. For this purpose, they all follow the Generator interface - this way we can put them all inside a slice and concurrently call Generate for all of them.</p>

<p>ä¸ºäº†è®©blog-generatoræ›´å¿«ï¼Œç”Ÿæˆå™¨éƒ½å¹¶è¡Œè¿è¡Œã€‚ä¸ºäº†è¿™ä¸ªç›®çš„ï¼Œä»–ä»¬éƒ½éµå¾ªç€Generatorçš„æ¥å£ - è¿™æ ·æˆ‘å¯ä»¥å°†ä»–ä»¬æ”¾åœ¨ä¸€ä¸ªsliceä¸­ï¼Œå¹¶å‘çš„è°ƒç”¨ç”Ÿæˆå™¨ã€‚</p>

<p>The generators all work independently of one another and donâ€™t use any global state mutation, so parallelizing them was a simple exercise of using channels and a sync.WaitGroup like this:</p>

<p>ç”Ÿæˆå™¨è¿è¡Œéƒ½ç›¸äº’ç‹¬ç«‹ï¼Œä¸”ä¸ä½¿ç”¨ä»»ä½•å…¨å±€çŠ¶æ€å˜åŒ–ï¼Œæ‰€ä»¥å¹¶è¡Œæ˜¯ä¸€ä¸ªç®€å•çš„ä½¿ç”¨channelå’Œsync.WaitGroupçš„ç»ƒä¹ ï¼Œå°±åƒè¿™æ ·ï¼š</p>

<pre><span class="kwd">func</span> <span class="pln">runTasks</span><span class="pun">(</span><span class="pln">posts</span> <span class="pun">[</span><span class="pun">]</span><span class="pun">*</span><span class="typ">Post</span><span class="pun">,</span> <span class="pln">t</span> <span class="pun">*</span><span class="kwd">template</span><span class="pun">.</span><span class="typ">Template</span><span class="pun">,</span> <span class="pln">destination</span> <span class="pln">string</span><span class="pun">)</span> <span class="pln">error</span> <span class="pun">{</span>
    <span class="kwd">var</span> <span class="pln">wg</span> <span class="pln">sync</span><span class="pun">.</span><span class="typ">WaitGroup</span>
    <span class="pln">finished</span> <span class="pun">:</span><span class="pun">=</span> <span class="kwd">make</span><span class="pun">(</span><span class="pln">chan</span> <span class="kwd">bool</span><span class="pun">,</span> <span class="dec">1</span><span class="pun">)</span>
    <span class="pln">errors</span> <span class="pun">:</span><span class="pun">=</span> <span class="kwd">make</span><span class="pun">(</span><span class="pln">chan</span> <span class="pln">error</span><span class="pun">,</span> <span class="dec">1</span><span class="pun">)</span>
    <span class="pln">pool</span> <span class="pun">:</span><span class="pun">=</span> <span class="kwd">make</span><span class="pun">(</span><span class="pln">chan</span> <span class="kwd">struct</span><span class="pun">{</span><span class="pun">}</span><span class="pun">,</span> <span class="dec">50</span><span class="pun">)</span>
    <span class="pln">generators</span> <span class="pun">:</span><span class="pun">=</span> <span class="pun">[</span><span class="pun">]</span><span class="typ">Generator</span><span class="pun">{</span><span class="pun">}</span>

    <span class="kwd">for</span> <span class="pln">_</span><span class="pun">,</span> <span class="pln">post</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">range</span> <span class="pln">posts</span> <span class="pun">{</span>
        <span class="pln">pg</span> <span class="pun">:</span><span class="pun">=</span> <span class="typ">PostGenerator</span><span class="pun">{</span><span class="pun">&amp;</span><span class="typ">PostConfig</span><span class="pun">{</span>
            <span class="typ">Post</span><span class="pun">:</span>        <span class="pln">post</span><span class="pun">,</span>
             <span class="typ">Destination</span><span class="pun">:</span> <span class="pln">destination</span><span class="pun">,</span>
             <span class="typ">Template</span><span class="pun">:</span>    <span class="pln">t</span><span class="pun">,</span>
        <span class="pun">}</span><span class="pun">}</span>
        <span class="pln">generators</span> <span class="pun">=</span> <span class="kwd">append</span><span class="pun">(</span><span class="pln">generators</span><span class="pun">,</span> <span class="pun">&amp;</span><span class="pln">pg</span><span class="pun">)</span>
    <span class="pun">}</span>

    <span class="pln">fg</span> <span class="pun">:</span><span class="pun">=</span> <span class="typ">ListingGenerator</span><span class="pun">{</span><span class="pun">&amp;</span><span class="typ">ListingConfig</span><span class="pun">{</span>
        <span class="typ">Posts</span><span class="pun">:</span>       <span class="pln">posts</span><span class="pun">[</span><span class="pun">:</span><span class="pln">getNumOfPagesOnFrontpage</span><span class="pun">(</span><span class="pln">posts</span><span class="pun">)</span><span class="pun">]</span><span class="pun">,</span>
        <span class="typ">Template</span><span class="pun">:</span>    <span class="pln">t</span><span class="pun">,</span>
        <span class="typ">Destination</span><span class="pun">:</span> <span class="pln">destination</span><span class="pun">,</span>
        <span class="typ">PageTitle</span><span class="pun">:</span>   <span class="str">&#34;&#34;</span><span class="pun">,</span>
    <span class="pun">}</span><span class="pun">}</span>

    <span class="pun">.</span><span class="pun">.</span><span class="pun">.</span><span class="pln">create</span> <span class="pln">the</span> <span class="pln">other</span> <span class="pln">generators</span><span class="pun">.</span><span class="pun">.</span><span class="pun">.</span>

    <span class="pln">generators</span> <span class="pun">=</span> <span class="kwd">append</span><span class="pun">(</span><span class="pln">generators</span><span class="pun">,</span> <span class="pun">&amp;</span><span class="pln">fg</span><span class="pun">,</span> <span class="pun">&amp;</span><span class="pln">ag</span><span class="pun">,</span> <span class="pun">&amp;</span><span class="pln">tg</span><span class="pun">,</span> <span class="pun">&amp;</span><span class="pln">sg</span><span class="pun">,</span> <span class="pun">&amp;</span><span class="pln">rg</span><span class="pun">,</span> <span class="pun">&amp;</span><span class="pln">statg</span><span class="pun">)</span>

    <span class="kwd">for</span> <span class="pln">_</span><span class="pun">,</span> <span class="pln">generator</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">range</span> <span class="pln">generators</span> <span class="pun">{</span>
        <span class="pln">wg</span><span class="pun">.</span><span class="typ">Add</span><span class="pun">(</span><span class="dec">1</span><span class="pun">)</span>
        <span class="pln">go</span> <span class="kwd">func</span><span class="pun">(</span><span class="pln">g</span> <span class="typ">Generator</span><span class="pun">)</span> <span class="pun">{</span>
            <span class="pln">defer</span> <span class="pln">wg</span><span class="pun">.</span><span class="typ">Done</span><span class="pun">(</span><span class="pun">)</span>
            <span class="pln">pool</span> <span class="pun">&lt;</span><span class="pun">-</span> <span class="kwd">struct</span><span class="pun">{</span><span class="pun">}</span><span class="pun">{</span><span class="pun">}</span>
            <span class="pln">defer</span> <span class="kwd">func</span><span class="pun">(</span><span class="pun">)</span> <span class="pun">{</span> <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">pool</span> <span class="pun">}</span><span class="pun">(</span><span class="pun">)</span>
            <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">g</span><span class="pun">.</span><span class="typ">Generate</span><span class="pun">(</span><span class="pun">)</span><span class="pun">;</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
                <span class="pln">errors</span> <span class="pun">&lt;</span><span class="pun">-</span> <span class="pln">err</span>
            <span class="pun">}</span>
        <span class="pun">}</span><span class="pun">(</span><span class="pln">generator</span><span class="pun">)</span>
    <span class="pun">}</span>

    <span class="pln">go</span> <span class="kwd">func</span><span class="pun">(</span><span class="pun">)</span> <span class="pun">{</span>
        <span class="pln">wg</span><span class="pun">.</span><span class="typ">Wait</span><span class="pun">(</span><span class="pun">)</span>
        <span class="pln">close</span><span class="pun">(</span><span class="pln">finished</span><span class="pun">)</span>
    <span class="pun">}</span><span class="pun">(</span><span class="pun">)</span>

    <span class="pln">select</span> <span class="pun">{</span>
    <span class="kwd">case</span> <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">finished</span><span class="pun">:</span>
        <span class="kwd">return</span> <span class="kwd">nil</span>
    <span class="kwd">case</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">errors</span><span class="pun">:</span>
        <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
           <span class="kwd">return</span> <span class="pln">err</span>
        <span class="pun">}</span>
    <span class="pun">}</span>
    <span class="kwd">return</span> <span class="kwd">nil</span>
<span class="pun">}</span>
</pre>

<p>The runTasks function uses a pool of max. 50 goroutines, creates all generators, adds them to a slice and then runs them in parallel.</p>

<p>runTaskså‡½æ•°ä½¿ç”¨æœ€å¤§50åç¨‹çš„åç¨‹æ± ï¼Œåˆ›å»ºæ‰€æœ‰ç”Ÿæˆå™¨ï¼Œå°†ä»–ä»¬æ·»åŠ åˆ°sliceä¸­ï¼Œç„¶åå¹¶è¡Œè¿è¡Œä»–ä»¬</p>

<p>These examples were just a short dive into the basic concepts used to write a static-site generator in Go.</p>

<p>è¿™äº›ä¾‹å­ä»…ä»…åˆæ­¥æ·±å…¥åŸºæœ¬æ¦‚å¿µç”¨äºä½¿ç”¨Goå†™ä¸€ä¸ªé™æ€ç½‘ç«™ç”Ÿæˆå™¨</p>

<p>If youâ€™re interested in the full implementation, you can find the code here.</p>

<p>å¦‚æœä½ å¯¹æ•´ä¸ªå®ç°æ„Ÿå…´è¶£ï¼Œä½ å¯ä»¥åœ¨<a href="https://github.com/zupzup/blog-generator">è¿™é‡Œ</a>æ‰¾åˆ°ä»£ç .</p>

<h2>Conclusion æ€»ç»“</h2>

<p>Writing my blog-generator was an absolute blast and a great learning experience. Itâ€™s also quite satisfying to use my own hand-crafted tool for creating my blog.</p>

<p>ç¼–å†™æˆ‘çš„åšå®¢ç”Ÿæˆå™¨æ˜¯ä¸€ç§ç»å¯¹çš„æŒ‘æˆ˜ï¼Œä¹Ÿæ˜¯ä¸€ç§å¾ˆå¥½çš„å­¦ä¹ ä½“éªŒã€‚ä½¿ç”¨æˆ‘è‡ªå·±çš„æ‰‹å·¥å·¥å…·åˆ›å»ºæˆ‘çš„åšå®¢ä¹Ÿå¾ˆä»¤äººæ»¡æ„ã€‚</p>

<p>To publish my posts to AWS, I also created static-aws-deploy, another Go command-line tool, which I covered in this post.</p>

<p>ä¸ºäº†å‘å¸ƒæˆ‘çš„æ–‡ç« åˆ°AWSï¼Œæˆ‘åŒæ ·åˆ›å»ºäº†<a href="https://github.com/zupzup/static-aws-deploy">static-aws-deploy</a>ï¼Œé¢å¤–çš„Goå‘½ä»¤è¡Œå·¥å…·ï¼Œæˆ‘åœ¨è¿™ç¯‡<a href="https://zupzup.org/static-deploy-tool/">æ–‡ç« </a>ä¸­ä¼šæåˆ°æåˆ°</p>

<p>If you want to use the tool yourself, just fork the repo and change the configuration. However, I didnâ€™t put much time into customizability or configurability, as Hugo provides all that and more.</p>

<p>å¦‚æœä½ æƒ³è‡ªå·±ä½¿ç”¨è¿™ä¸ªå·¥å…·ï¼Œä»…ä»…forkè¿™ä¸ªrepoï¼Œå¹¶ä¿®æ”¹é…ç½®å°±å¯ä»¥äº†ã€‚ä½†æ˜¯ï¼Œæˆ‘æ²¡æœ‰èŠ±å¤ªå¤šæ—¶é—´æ¥åšå¯å®šåˆ¶åŒ–å’Œå¯é…ç½®åŒ–ï¼Œå› ä¸º<a href="https://gohugo.io/">Hugo</a>æä¾›çš„äº†æ‰€æœ‰ä½ éœ€è¦çš„ã€‚</p>

<p>Of course, one should strive not to re-invent the wheel all the time, but sometimes re-inventing a wheel or two can be rewarding and can help you learn quite a bit in the process. :)</p>

<p>å½“ç„¶ï¼Œä¸€ä¸ªäººåº”è¯¥åŠªåŠ›ä¸å»é‡æ–°å‘æ˜è½®å­ï¼Œä½†æ˜¯æœ‰æ—¶å€™é‡æ–°å‘æ˜ä¸€ä¸¤ä¸ªè½®å­æ˜¯å€¼å¾—çš„ï¼Œå¯ä»¥å¸®åŠ©ä½ åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å­¦åˆ°å¾ˆå¤šä¸œè¥¿ã€‚:)</p>

<h3>Resources</h3>

<ul>
<li><a href="https://github.com/zupzup/blog-generator">blog-generator on GitHub</a></li>
<li><a href="https://gohugo.io/">Hugo</a></li>
<li><a href="https://github.com/beevik/etree">etree</a></li>
</ul>

                </div>
                <a class="ui large button" href="/2017/07/04/%28%e7%bf%bb%e8%af%91%29writing%20a%20Static%20Blog%20Generator%20in%20Go">Read More</a>
                <h4 class="ui horizontal header divider">
                    <a href="#">è¿™æ˜¯åˆ†ç•Œçº¿å“¦~~</a>
                </h4>
                
                <h3 class="ui header">(ç¿»è¯‘)å–æ¶ˆå¤šä¸ªGoroutines</h3>
                <div class="postContent">
                    <p>åŸæ–‡ <a href="https://chilts.org/2017/06/12/cancelling-multiple-goroutines">https://chilts.org/2017/06/12/cancelling-multiple-goroutines</a></p>

<h1>Cancelling Multiple Goroutines å–æ¶ˆå¤šåç¨‹</h1>

<p>When Go was first released, there was a way to do some things in concurrency. As time has gone on, various things have changed. The Context package for one thing. :)</p>

<p>åœ¨Goåˆšå¼€å§‹å‘è¡Œçš„æ—¶å€™ï¼Œåªæœ‰ä¸€ç§å¹¶å‘çš„æ–¹æ³•ã€‚éšç€æ—¶é—´æµé€ï¼Œå¾ˆå¤šäº‹æƒ…éƒ½å‘ç”Ÿäº†å˜åŒ–ã€‚ContextåŒ…å°±æ˜¯å…¶ä¸­ä¹‹ä¸€ã€‚</p>

<p>This article doesnâ€™t go into all of the ways of doing concurrency but will focus on one problem and take you through a few different solutions so you can see how things have evolved.</p>

<p>è¿™ç¯‡æ–‡ç« ä¸ä¼šæ¢ç©¶æ‰€æœ‰å¹¶å‘çš„æ–¹æ³•ï¼Œä½†æ˜¯ä¼šç ”ç©¶ä¸€ä¸ªé—®é¢˜ï¼Œå¹¶å¸¦ä½ ç†Ÿæ‚‰ä¸€äº›ä¸åŒçš„è§£å†³æ–¹æ³•ï¼Œè®©ä½ äº†è§£æ–¹æ³•æ˜¯å¦‚ä½•æ¨è®ºå‡ºæ¥çš„ã€‚</p>

<h2>The Problem</h2>

<p>The problem Iâ€™d like to address here is being able to cancel multiple goroutines. There are many blog posts out there (I curate @CuratedGo, please follow) which show how to cancel just one goroutine, but my use-case was slightly more complicated. The rest of this article summarises my progress through getting this to work.</p>

<p>æˆ‘åœ¨è¿™é‡Œæƒ³æå‡ºçš„é—®é¢˜æ˜¯å–æ¶ˆå¯¹åç¨‹ã€‚æœ‰è®¸å¤šblogå†™äº†å¦‚ä½•å–æ¶ˆä¸€ä¸ªåç¨‹ï¼Œä½†æ˜¯æˆ‘çš„ç”¨ä¾‹æ˜¯æ›´åŠ å¤æ‚çš„ã€‚ä¸‹é¢çš„æ–‡ç« æ€»ç»“äº†æˆ‘å®ç°çš„è¿‡ç¨‹ã€‚</p>

<p>The way weâ€™re going decide when to quit is by listening for a C-c keypress. Of course at that point, we want to make sure we tidy up things nicely at that point. For example, if weâ€™re currently streaming tweets from Twitter, weâ€™d rather we told them weâ€™re finished than just drop the connection.</p>

<p>æˆ‘ä»¬è¦å†³å®šä½•æ—¶é€€å‡ºçš„æ–¹å¼æ˜¯ç›‘å¬C-cæŒ‰é”®ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬ç¡®ä¿æˆ‘ä»¬åœ¨è¿™ä¸€ç‚¹ä¸Šå¾ˆå¥½åœ°å¤„ç†äº‹æƒ…ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬ç›®å‰æ­£åœ¨æ¨é€Twitterçš„æ¨æ–‡ï¼Œæˆ‘ä»¬è¦å‘Šè¯‰ä»–ä»¬æˆ‘ä»¬å·²ç»å®Œæˆï¼Œè€Œä¸æ˜¯æ”¾å¼ƒäº†è§£ã€‚</p>

<p>Letâ€™s get started.
è®©æˆ‘ä»¬å¼€å§‹å§</p>

<h2>A Main without Tidying up</h2>

<pre><span class="kwd">package</span> <span class="pln">main</span>

<span class="kwd">import</span> <span class="pun">(</span>
    <span class="str">&#34;fmt&#34;</span>
    <span class="str">&#34;time&#34;</span>
<span class="pun">)</span>

<span class="kwd">func</span> <span class="pln">main</span><span class="pun">(</span><span class="pun">)</span> <span class="pun">{</span>
    <span class="pln">ticker</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">NewTicker</span><span class="pun">(</span><span class="dec">3</span> <span class="pun">*</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Second</span><span class="pun">)</span>

    <span class="kwd">for</span> <span class="pun">{</span>
        <span class="pln">select</span> <span class="pun">{</span>
        <span class="kwd">case</span> <span class="pln">now</span> <span class="pun">:</span><span class="pun">=</span> <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">ticker</span><span class="pun">.</span><span class="typ">C</span><span class="pun">:</span>
            <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;tick %s\n&#34;</span><span class="pun">,</span> <span class="pln">now</span><span class="pun">.</span><span class="typ">UTC</span><span class="pun">(</span><span class="pun">)</span><span class="pun">.</span><span class="typ">Format</span><span class="pun">(</span><span class="str">&#34;20060102-150405.000000000&#34;</span><span class="pun">)</span><span class="pun">)</span>
        <span class="pun">}</span>
    <span class="pun">}</span>
<span class="pun">}</span>
</pre>

<p>And letâ€™s run it and C-c it.</p>

<pre><span class="pun">$</span> <span class="pln">go</span> <span class="pln">run</span> <span class="dec">01</span><span class="pun">/</span><span class="pln">tidy</span><span class="pun">.</span><span class="pln">go</span> 
<span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">213112.045887655</span>
<span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">213115.045986150</span>
<span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">213118.045993591</span>
<span class="pun">^</span><span class="typ">Csignal</span><span class="pun">:</span> <span class="pln">interrupt</span>
</pre>

<p>Here you can see we have sent the interrupt signal. Make a mental note of that name. However, we havenâ€™t actually tidied up the timer. There are a few ways we could do it, and the easiest for this program is to defer ticker.Stop() so it gets run at the end of main().</p>

<p>åœ¨è¿™é‡Œä½ å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬å‘é€äº†ä¸­æ–­ä¿¡å·ã€‚åœ¨å¿ƒé‡Œè®°ä½è¿™ä¸ªåå­—ã€‚ä½†æ˜¯æˆ‘ä»¬è¿˜æ²¡æœ‰æ­£ç¡®çš„æ•´ç†å¥½å®šæ—¶å™¨ã€‚æœ‰è®¸å¤šæ–¹æ³•å¯ä»¥åšåˆ°ï¼Œå…¶ä¸­æœ€ç®€å•çš„æ˜¯defer tick.Stop(),ä»–åœ¨main()çš„ç»“å°¾è¿è¡Œã€‚</p>

<pre><span class="kwd">package</span> <span class="pln">main</span>

<span class="kwd">import</span> <span class="pun">(</span>
    <span class="str">&#34;fmt&#34;</span>
    <span class="str">&#34;time&#34;</span>
<span class="pun">)</span>

<span class="kwd">func</span> <span class="pln">main</span><span class="pun">(</span><span class="pun">)</span> <span class="pun">{</span>
    <span class="pln">ticker</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">NewTicker</span><span class="pun">(</span><span class="dec">3</span> <span class="pun">*</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Second</span><span class="pun">)</span>
    <span class="pln">defer</span> <span class="pln">ticker</span><span class="pun">.</span><span class="typ">Stop</span><span class="pun">(</span><span class="pun">)</span>

    <span class="kwd">for</span> <span class="pun">{</span>
        <span class="pln">select</span> <span class="pun">{</span>
        <span class="kwd">case</span> <span class="pln">now</span> <span class="pun">:</span><span class="pun">=</span> <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">ticker</span><span class="pun">.</span><span class="typ">C</span><span class="pun">:</span>
            <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;tick %s\n&#34;</span><span class="pun">,</span> <span class="pln">now</span><span class="pun">.</span><span class="typ">UTC</span><span class="pun">(</span><span class="pun">)</span><span class="pun">.</span><span class="typ">Format</span><span class="pun">(</span><span class="str">&#34;20060102-150405.000000000&#34;</span><span class="pun">)</span><span class="pun">)</span>
        <span class="pun">}</span>
    <span class="pun">}</span>
<span class="pun">}</span>

</pre>

<p>There is no discernable difference in the output, however you are being a good citizen. :)</p>

<p>åœ¨è¾“å‡ºçš„ç»“æœä¸­å¹¶æ²¡æœ‰æ˜æ˜¾çš„åŒºåˆ«ï¼Œä½†æ˜¯ä½ ç°åœ¨æ˜¯ä¸€ä¸ªè‰¯å¥½å¸‚æ°‘.:)</p>

<pre><span class="pun">$</span> <span class="pln">go</span> <span class="pln">run</span> <span class="dec">02</span><span class="pun">/</span><span class="pln">tidy</span><span class="pun">.</span><span class="pln">go</span> 
<span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">213456.385205269</span>
<span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">213459.385180852</span>
<span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">213502.385222563</span>
<span class="pun">^</span><span class="typ">Csignal</span><span class="pun">:</span> <span class="pln">interrupt</span>
</pre>

<p>We said earlier that we want to run multiple goroutines and we want to listen for C-c, so letâ€™s do the C-c first.
æˆ‘ä»¬ä¹‹å‰è¯´è¿‡ï¼Œæˆ‘ä»¬æƒ³è¿è¡Œå¤šåç¨‹å¹¶ä¸”æˆ‘ä»¬æƒ³ç›‘å¬C-cï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆå®ŒæˆC-cã€‚</p>

<p>Using the os/signal package, we can tell Go to listen for (you guessed it) OS Signals such as os.Interrupt and os.Kill. Letâ€™s see what that looks like:</p>

<p>ä½¿ç”¨ os/signalåŒsing the os/signal package, we can tell Go to listen for (you guessed it) OS Signals such as os.Interrupt and os.Kill. Letâ€™s see what that looks like:</p>

<p>ä½¿ç”¨ os/signalåŒ…ï¼Œæˆ‘ä»¬å¯ä»¥å‘Šè¯‰Goç›‘å¬æ“ä½œç³»ç»Ÿçš„ä¿¡å·ï¼Œä¾‹å¦‚os.Interruptå’Œos.Killã€‚è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹å§ã€‚</p>

<pre><span class="kwd">package</span> <span class="pln">main</span>

<span class="kwd">import</span> <span class="pun">(</span>
    <span class="str">&#34;fmt&#34;</span>
    <span class="str">&#34;os&#34;</span>
    <span class="str">&#34;os/signal&#34;</span>
    <span class="str">&#34;time&#34;</span>
<span class="pun">)</span>

<span class="kwd">func</span> <span class="pln">main</span><span class="pun">(</span><span class="pun">)</span> <span class="pun">{</span>
    <span class="pln">ticker</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">NewTicker</span><span class="pun">(</span><span class="dec">3</span> <span class="pun">*</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Second</span><span class="pun">)</span>
    <span class="pln">defer</span> <span class="pln">ticker</span><span class="pun">.</span><span class="typ">Stop</span><span class="pun">(</span><span class="pun">)</span>

    <span class="pln">c</span> <span class="pun">:</span><span class="pun">=</span> <span class="kwd">make</span><span class="pun">(</span><span class="pln">chan</span> <span class="pln">os</span><span class="pun">.</span><span class="typ">Signal</span><span class="pun">,</span> <span class="dec">1</span><span class="pun">)</span>
    <span class="pln">signal</span><span class="pun">.</span><span class="typ">Notify</span><span class="pun">(</span><span class="pln">c</span><span class="pun">,</span> <span class="pln">os</span><span class="pun">.</span><span class="typ">Interrupt</span><span class="pun">)</span>

    <span class="kwd">for</span> <span class="pun">{</span>
        <span class="pln">select</span> <span class="pun">{</span>
        <span class="kwd">case</span> <span class="pln">now</span> <span class="pun">:</span><span class="pun">=</span> <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">ticker</span><span class="pun">.</span><span class="typ">C</span><span class="pun">:</span>
            <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;tick %s\n&#34;</span><span class="pun">,</span> <span class="pln">now</span><span class="pun">.</span><span class="typ">UTC</span><span class="pun">(</span><span class="pun">)</span><span class="pun">.</span><span class="typ">Format</span><span class="pun">(</span><span class="str">&#34;20060102-150405.000000000&#34;</span><span class="pun">)</span><span class="pun">)</span>
        <span class="kwd">case</span> <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">c</span><span class="pun">:</span>
            <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;Received C-c - shutting down&#34;</span><span class="pun">)</span>
            <span class="kwd">return</span>
        <span class="pun">}</span>
    <span class="pun">}</span>
<span class="pun">}</span>
</pre>

<p>And when we run it, instead of seeing the default message Go provides when it receives an interrupt signal, we can see our own message:</p>

<pre><span class="pun">$</span> <span class="pln">go</span> <span class="pln">run</span> <span class="dec">03</span><span class="pun">/</span><span class="pln">tidy</span><span class="pun">.</span><span class="pln">go</span> 
<span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">214602.313917282</span>
<span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">214605.313950300</span>
<span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">214608.313950904</span>
<span class="pun">^</span><span class="typ">CReceived</span> <span class="typ">C</span><span class="pun">-</span><span class="pln">c</span> <span class="pun">-</span> <span class="pln">shutting</span> <span class="pln">down</span>
</pre>

<p>Excellent, so letâ€™s start moving the program closer to what we want - running multiple goroutines and stopping them cleanly</p>

<p>éå¸¸å¥½ï¼Œæˆ‘ä»¬å°†ç¨‹åºæ”¹æˆæ›´æ¥è¿‘æˆ‘ä»¬æƒ³è¦çš„â€“è¿è¡Œå¤šåç¨‹å¹¶å¹²å‡€çš„ç»“æŸä»–ä»¬</p>

<h2>Signalling a Goroutine to Stop å‘é€ä¿¡å·è®©åç¨‹åœæ­¢</h2>

<p>Even though we only have one task at the moment, we will put it into itâ€™s own goroutine and signal it to stop when we have received the C-c. Iâ€™m going to use the first half of a post called â€œStopping Goroutinesâ€ by the excellent Mat Ryer as the basis for this process. Note when this post was written - 2015 - and be sure weâ€™ll change a few things by the time weâ€™ve finished this article.</p>

<p>å°½ç®¡æˆ‘ä»¬æ­¤åˆ»åªæœ‰ä¸€ä¸ªä»»åŠ¡ï¼Œä½†æˆ‘ä»¬æˆ‘ä»¬ä¼šå°†ä»–æ”¾åœ¨ä»–è‡ªå·±çš„åç¨‹ä¸­ï¼Œå¹¶ä¸”å½“ä»–æ¥å—åˆ°C-cä¿¡å·çš„æ—¶å€™åœæ­¢ã€‚</p>

<p>The next example shows the ticker in itâ€™s own goroutine. Notice that instead of keeping the signal receiver in the for select case &lt;-c weâ€™ll just change it to &lt;-c since thatâ€™s the only thing weâ€™re going to leave in main(). I will prefix the messages with either main or tick so you can see whatâ€™s going on.</p>

<p>ä¸‹ä¸€ä¸ªä¾‹å­å±•ç¤ºäº†åœ¨å®ƒè‡ªå·±å•ç‹¬çš„åç¨‹é‡Œçš„tickerã€‚æ³¨æ„ï¼Œæˆ‘ä»¬å°†æ”¹ç”¨&lt;-c, è€Œä¸æ˜¯å°†ä¿¡å·æ¥å—æ”¾åœ¨for select case &lt;-cä¸­ã€‚å› ä¸ºè¿™æ˜¯æˆ‘ä»¬å”¯ä¸€æ”¾åœ¨main()ä¸­çš„è¯­å¥.æˆ‘å°†ä¼šåœ¨æ¶ˆæ¯ä¸­åŠ ä¸Šmainæˆ–è€…tickçš„å‰ç¼€ï¼Œè®©ä½ çœ‹åˆ°å“ªä¸€ä¸ªæ­£åœ¨æ‰§è¡Œã€‚</p>

<pre><span class="kwd">package</span> <span class="pln">main</span>

<span class="kwd">import</span> <span class="pun">(</span>
    <span class="str">&#34;fmt&#34;</span>
    <span class="str">&#34;os&#34;</span>
    <span class="str">&#34;os/signal&#34;</span>
    <span class="str">&#34;time&#34;</span>
<span class="pun">)</span>

<span class="kwd">func</span> <span class="pln">main</span><span class="pun">(</span><span class="pun">)</span> <span class="pun">{</span>
    <span class="com">// a channel to tell `tick()` to stop, and one to tell us they&#39;ve stopped</span>
    <span class="pln">stopChan</span> <span class="pun">:</span><span class="pun">=</span> <span class="kwd">make</span><span class="pun">(</span><span class="pln">chan</span> <span class="kwd">struct</span><span class="pun">{</span><span class="pun">}</span><span class="pun">)</span>
    <span class="pln">stoppedChan</span> <span class="pun">:</span><span class="pun">=</span> <span class="kwd">make</span><span class="pun">(</span><span class="pln">chan</span> <span class="kwd">struct</span><span class="pun">{</span><span class="pun">}</span><span class="pun">)</span>
    <span class="pln">go</span> <span class="pln">tick</span><span class="pun">(</span><span class="pln">stopChan</span><span class="pun">,</span> <span class="pln">stoppedChan</span><span class="pun">)</span>

    <span class="com">// listen for C-c</span>
    <span class="pln">c</span> <span class="pun">:</span><span class="pun">=</span> <span class="kwd">make</span><span class="pun">(</span><span class="pln">chan</span> <span class="pln">os</span><span class="pun">.</span><span class="typ">Signal</span><span class="pun">,</span> <span class="dec">1</span><span class="pun">)</span>
    <span class="pln">signal</span><span class="pun">.</span><span class="typ">Notify</span><span class="pun">(</span><span class="pln">c</span><span class="pun">,</span> <span class="pln">os</span><span class="pun">.</span><span class="typ">Interrupt</span><span class="pun">)</span>
    <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">c</span>
    <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;main: received C-c - shutting down&#34;</span><span class="pun">)</span>

    <span class="com">// tell the goroutine to stop</span>
    <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;main: telling goroutines to stop&#34;</span><span class="pun">)</span>
    <span class="pln">close</span><span class="pun">(</span><span class="pln">stopChan</span><span class="pun">)</span>
    <span class="com">// and wait for them to reply back</span>
    <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">stoppedChan</span>
    <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;main: goroutine has told us they&#39;ve finished&#34;</span><span class="pun">)</span>
<span class="pun">}</span>

<span class="kwd">func</span> <span class="pln">tick</span><span class="pun">(</span><span class="pln">stop</span><span class="pun">,</span> <span class="pln">stopped</span> <span class="pln">chan</span> <span class="kwd">struct</span><span class="pun">{</span><span class="pun">}</span><span class="pun">)</span> <span class="pun">{</span>
    <span class="com">// tell the caller we&#39;ve stopped</span>
    <span class="pln">defer</span> <span class="pln">close</span><span class="pun">(</span><span class="pln">stopped</span><span class="pun">)</span>

    <span class="pln">ticker</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">NewTicker</span><span class="pun">(</span><span class="dec">3</span> <span class="pun">*</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Second</span><span class="pun">)</span>
    <span class="pln">defer</span> <span class="pln">ticker</span><span class="pun">.</span><span class="typ">Stop</span><span class="pun">(</span><span class="pun">)</span>

    <span class="kwd">for</span> <span class="pun">{</span>
        <span class="pln">select</span> <span class="pun">{</span>
        <span class="kwd">case</span> <span class="pln">now</span> <span class="pun">:</span><span class="pun">=</span> <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">ticker</span><span class="pun">.</span><span class="typ">C</span><span class="pun">:</span>
            <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;tick: tick %s\n&#34;</span><span class="pun">,</span> <span class="pln">now</span><span class="pun">.</span><span class="typ">UTC</span><span class="pun">(</span><span class="pun">)</span><span class="pun">.</span><span class="typ">Format</span><span class="pun">(</span><span class="str">&#34;20060102-150405.000000000&#34;</span><span class="pun">)</span><span class="pun">)</span>
        <span class="kwd">case</span> <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">stop</span><span class="pun">:</span>
            <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;tick: caller has told us to stop&#34;</span><span class="pun">)</span>
            <span class="kwd">return</span>
        <span class="pun">}</span>
    <span class="pun">}</span>
<span class="pun">}</span>
</pre>

<p>Once you press C-c here, you can see the exchange of messages.</p>

<p>ä¸€æ—¦ä½ æŒ‰ä¸‹äº†C-cï¼Œä½ å¯ä»¥çœ‹åˆ°æ¶ˆæ¯çš„äº¤æ¢ã€‚</p>

<pre><span class="pun">$</span> <span class="pln">go</span> <span class="pln">run</span> <span class="dec">04</span><span class="pun">/</span><span class="pln">tidy</span><span class="pun">.</span><span class="pln">go</span> 
<span class="pln">tick</span><span class="pun">:</span> <span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">220018.345218301</span>
<span class="pln">tick</span><span class="pun">:</span> <span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">220021.345202622</span>
<span class="pln">tick</span><span class="pun">:</span> <span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">220024.345147172</span>
<span class="pun">^</span><span class="typ">Cmain</span><span class="pun">:</span> <span class="pln">received</span> <span class="typ">C</span><span class="pun">-</span><span class="pln">c</span> <span class="pun">-</span> <span class="pln">shutting</span> <span class="pln">down</span>
<span class="pln">main</span><span class="pun">:</span> <span class="pln">telling</span> <span class="pln">goroutines</span> <span class="pln">to</span> <span class="pln">stop</span>
<span class="pln">tick</span><span class="pun">:</span> <span class="kwd">caller</span> <span class="pln">has</span> <span class="pln">told</span> <span class="pln">us</span> <span class="pln">to</span> <span class="pln">stop</span>
<span class="pln">main</span><span class="pun">:</span> <span class="pln">goroutine</span> <span class="pln">has</span> <span class="pln">told</span> <span class="pln">us</span> <span class="pln">they</span><span class="str">&#39;ve finished
</span></pre>

<p>So far so good. It works.
åˆ°ç°åœ¨ä¸ºæ­¢è¿˜æŒºå¥½ã€‚å®ƒèµ·ä½œç”¨äº†ã€‚</p>

<p>But I can see one problem on the horizon. When we add another goroutine, weâ€™ll have to create another stopped channel for the second goroutine to tell us when theyâ€™ve stopped. (Side-note: I originally also created a new stop chan too, but we can re-use that channel for both goroutines.)</p>

<p>ä½†æ˜¯æˆ‘é¢„è§äº†ä¸€ä¸ªé—®é¢˜ã€‚å½“æˆ‘æ·»åŠ å¦å¤–ä¸€ä¸ªåç¨‹æ—¶ï¼Œæˆ‘ä»¬å°†ä¸ºç¬¬äºŒä¸ªåç¨‹åˆ›å»ºå¦å¤–ä¸€ä¸ªstoped channelç”¨äºå‘Šè¯‰æˆ‘ä»¬åç¨‹ä½•æ—¶åœæ­¢ã€‚ï¼ˆè¾¹æ³¨ï¼šæˆ‘åŸæ¥ä¹Ÿåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„stop channelï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥é‡æ–°ä½¿ç”¨è¯¥channelç”¨äºè¿™ä¸¤ä¸ªgoroutineï¼‰</p>

<p>Letâ€™s see what the extra stopped channel looks like. In this example our second goroutine tock() is very similar to the first, except it tocks every 5s instead of ticks every 3s.</p>

<p>è®©æˆ‘ä»¬çœ‹çœ‹é¢å¤–çš„stopped channelã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬çš„ç¬¬äºŒä¸ªgoroutine tock()å’Œç¬¬ä¸€ä¸ªéå¸¸ç›¸ä¼¼ï¼Œä¸åŒç‚¹æ˜¯ç¬¬äºŒä¸ªæ˜¯æ¯éš”5sè€Œç¬¬ä¸€ä¸ªæ˜¯æ¯éš”3sã€‚</p>

<pre><span class="kwd">package</span> <span class="pln">main</span>

<span class="kwd">import</span> <span class="pun">(</span>
    <span class="str">&#34;fmt&#34;</span>
    <span class="str">&#34;os&#34;</span>
    <span class="str">&#34;os/signal&#34;</span>
    <span class="str">&#34;time&#34;</span>
<span class="pun">)</span>

<span class="kwd">func</span> <span class="pln">main</span><span class="pun">(</span><span class="pun">)</span> <span class="pun">{</span>
    <span class="com">// a channel to tell `tick()` and `tock()` to stop</span>
    <span class="pln">stopChan</span> <span class="pun">:</span><span class="pun">=</span> <span class="kwd">make</span><span class="pun">(</span><span class="pln">chan</span> <span class="kwd">struct</span><span class="pun">{</span><span class="pun">}</span><span class="pun">)</span>

    <span class="com">// a channel for `tick()` to tell us they&#39;ve stopped</span>
    <span class="pln">tickStoppedChan</span> <span class="pun">:</span><span class="pun">=</span> <span class="kwd">make</span><span class="pun">(</span><span class="pln">chan</span> <span class="kwd">struct</span><span class="pun">{</span><span class="pun">}</span><span class="pun">)</span>
    <span class="pln">go</span> <span class="pln">tick</span><span class="pun">(</span><span class="pln">stopChan</span><span class="pun">,</span> <span class="pln">tickStoppedChan</span><span class="pun">)</span>

    <span class="com">// a channel for `tock()` to tell us they&#39;ve stopped</span>
    <span class="pln">tockStoppedChan</span> <span class="pun">:</span><span class="pun">=</span> <span class="kwd">make</span><span class="pun">(</span><span class="pln">chan</span> <span class="kwd">struct</span><span class="pun">{</span><span class="pun">}</span><span class="pun">)</span>
    <span class="pln">go</span> <span class="pln">tock</span><span class="pun">(</span><span class="pln">stopChan</span><span class="pun">,</span> <span class="pln">tockStoppedChan</span><span class="pun">)</span>

    <span class="com">// listen for C-c</span>
    <span class="pln">c</span> <span class="pun">:</span><span class="pun">=</span> <span class="kwd">make</span><span class="pun">(</span><span class="pln">chan</span> <span class="pln">os</span><span class="pun">.</span><span class="typ">Signal</span><span class="pun">,</span> <span class="dec">1</span><span class="pun">)</span>
    <span class="pln">signal</span><span class="pun">.</span><span class="typ">Notify</span><span class="pun">(</span><span class="pln">c</span><span class="pun">,</span> <span class="pln">os</span><span class="pun">.</span><span class="typ">Interrupt</span><span class="pun">)</span>
    <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">c</span>
    <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;main: received C-c - shutting down&#34;</span><span class="pun">)</span>

    <span class="com">// tell the goroutine to stop</span>
    <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;main: telling goroutines to stop&#34;</span><span class="pun">)</span>
    <span class="pln">close</span><span class="pun">(</span><span class="pln">stopChan</span><span class="pun">)</span>
    <span class="com">// and wait for them to reply back</span>
    <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">tickStoppedChan</span>
    <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">tockStoppedChan</span>
    <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;main: all goroutines have told us they&#39;ve finished&#34;</span><span class="pun">)</span>
<span class="pun">}</span>

<span class="kwd">func</span> <span class="pln">tick</span><span class="pun">(</span><span class="pln">stop</span><span class="pun">,</span> <span class="pln">stopped</span> <span class="pln">chan</span> <span class="kwd">struct</span><span class="pun">{</span><span class="pun">}</span><span class="pun">)</span> <span class="pun">{</span>
    <span class="com">// tell the caller we&#39;ve stopped</span>
    <span class="pln">defer</span> <span class="pln">close</span><span class="pun">(</span><span class="pln">stopped</span><span class="pun">)</span>

    <span class="pln">ticker</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">NewTicker</span><span class="pun">(</span><span class="dec">3</span> <span class="pun">*</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Second</span><span class="pun">)</span>
    <span class="pln">defer</span> <span class="pln">ticker</span><span class="pun">.</span><span class="typ">Stop</span><span class="pun">(</span><span class="pun">)</span>

    <span class="kwd">for</span> <span class="pun">{</span>
        <span class="pln">select</span> <span class="pun">{</span>
        <span class="kwd">case</span> <span class="pln">now</span> <span class="pun">:</span><span class="pun">=</span> <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">ticker</span><span class="pun">.</span><span class="typ">C</span><span class="pun">:</span>
            <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;tick: tick %s\n&#34;</span><span class="pun">,</span> <span class="pln">now</span><span class="pun">.</span><span class="typ">UTC</span><span class="pun">(</span><span class="pun">)</span><span class="pun">.</span><span class="typ">Format</span><span class="pun">(</span><span class="str">&#34;20060102-150405.000000000&#34;</span><span class="pun">)</span><span class="pun">)</span>
        <span class="kwd">case</span> <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">stop</span><span class="pun">:</span>
            <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;tick: caller has told us to stop&#34;</span><span class="pun">)</span>
            <span class="kwd">return</span>
        <span class="pun">}</span>
    <span class="pun">}</span>
<span class="pun">}</span>

<span class="kwd">func</span> <span class="pln">tock</span><span class="pun">(</span><span class="pln">stop</span><span class="pun">,</span> <span class="pln">stopped</span> <span class="pln">chan</span> <span class="kwd">struct</span><span class="pun">{</span><span class="pun">}</span><span class="pun">)</span> <span class="pun">{</span>
    <span class="com">// tell the caller we&#39;ve stopped</span>
    <span class="pln">defer</span> <span class="pln">close</span><span class="pun">(</span><span class="pln">stopped</span><span class="pun">)</span>

    <span class="pln">ticker</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">NewTicker</span><span class="pun">(</span><span class="dec">5</span> <span class="pun">*</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Second</span><span class="pun">)</span>
    <span class="pln">defer</span> <span class="pln">ticker</span><span class="pun">.</span><span class="typ">Stop</span><span class="pun">(</span><span class="pun">)</span>

    <span class="kwd">for</span> <span class="pun">{</span>
        <span class="pln">select</span> <span class="pun">{</span>
        <span class="kwd">case</span> <span class="pln">now</span> <span class="pun">:</span><span class="pun">=</span> <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">ticker</span><span class="pun">.</span><span class="typ">C</span><span class="pun">:</span>
            <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;tock: tock %s\n&#34;</span><span class="pun">,</span> <span class="pln">now</span><span class="pun">.</span><span class="typ">UTC</span><span class="pun">(</span><span class="pun">)</span><span class="pun">.</span><span class="typ">Format</span><span class="pun">(</span><span class="str">&#34;20060102-150405.000000000&#34;</span><span class="pun">)</span><span class="pun">)</span>
        <span class="kwd">case</span> <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">stop</span><span class="pun">:</span>
            <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;tock: caller has told us to stop&#34;</span><span class="pun">)</span>
            <span class="kwd">return</span>
        <span class="pun">}</span>
    <span class="pun">}</span>
<span class="pun">}</span>
</pre>

<p>Itâ€™s starting to look unwieldy. However, letâ€™s take a look at the output for completeness:</p>

<pre><span class="pun">$</span> <span class="pln">go</span> <span class="pln">run</span> <span class="dec">05</span><span class="pun">/</span><span class="pln">tidy</span><span class="pun">.</span><span class="pln">go</span> 
<span class="pln">tick</span><span class="pun">:</span> <span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">220618.466725240</span>
<span class="pln">tock</span><span class="pun">:</span> <span class="pln">tock</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">220620.466789888</span>
<span class="pln">tick</span><span class="pun">:</span> <span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">220621.466756817</span>
<span class="pln">tick</span><span class="pun">:</span> <span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">220624.466762771</span>
<span class="pun">^</span><span class="typ">Cmain</span><span class="pun">:</span> <span class="pln">received</span> <span class="typ">C</span><span class="pun">-</span><span class="pln">c</span> <span class="pun">-</span> <span class="pln">shutting</span> <span class="pln">down</span>
<span class="pln">main</span><span class="pun">:</span> <span class="pln">telling</span> <span class="pln">goroutines</span> <span class="pln">to</span> <span class="pln">stop</span>
<span class="pln">tock</span><span class="pun">:</span> <span class="kwd">caller</span> <span class="pln">has</span> <span class="pln">told</span> <span class="pln">us</span> <span class="pln">to</span> <span class="pln">stop</span>
<span class="pln">tick</span><span class="pun">:</span> <span class="kwd">caller</span> <span class="pln">has</span> <span class="pln">told</span> <span class="pln">us</span> <span class="pln">to</span> <span class="pln">stop</span>
<span class="pln">main</span><span class="pun">:</span> <span class="pln">all</span> <span class="pln">goroutines</span> <span class="pln">have</span> <span class="pln">told</span> <span class="pln">us</span> <span class="pln">they</span><span class="str">&#39;ve finished
</span></pre>

<p>Even though itâ€™s looking a bit nasty, it still works as it should.</p>

<h2>sync.WaitGroup</h2>

<p>Letâ€™s try and tidy-up and simplify a bit here. The reason to do this is because if weâ€™d like to add another goroutine to this program - or indeed another 10, 20 or a hundred - weâ€™re going to have a headache with all the channels we need to create.</p>

<p>è®©æˆ‘ä»¬å°è¯•ã€æ•´ç†å¹¶ç®€åŒ–ã€‚åšè¿™ä¸ªçš„ç†ç”±æ˜¯å› ä¸ºå¦‚æœæˆ‘ä»¬æƒ³åœ¨è¿™ä¸ªç¨‹åºä¸­æ·»åŠ å…¶ä»–goroutine - æˆ–è€…ç”šè‡³å…¶ä»–10ï¼Œ20ï¼Œæˆ–è€…100ä¸ª - å¤„ç†æ‰€æœ‰æˆ‘ä»¬éœ€è¦åˆ›å»ºçš„channelä¼šè®©æˆ‘ä»¬å¤´ç–¼ã€‚</p>

<p>So instead of channels, letâ€™s try another concurrency fundamental that Go provides, which is sync.WaitGroup. Here we create just one WaitGroup (instead of two channels) and use that for the goroutines to signal theyâ€™ve finished. Remember, once we create the WaitGroup we shouldnâ€™t copy it, so we need to pass it by reference.</p>

<p>æ‰€ä»¥ï¼Œé™¤äº†channelï¼Œè®©æˆ‘ä»¬å°è¯•å¦å¤–çš„Goæä¾›çš„å¹¶å‘åŸºæœ¬åŸåˆ™â€“sync.WaitGroup.åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä»…ä»…åˆ›å»ºä¸€ä¸ªWaitGroup(è€Œä¸æ˜¯ä¸¤ä¸ªchannel)ï¼Œç”¨äºå½“åç¨‹ç»“æŸæ—¶å‘é€ä¿¡æ¯ã€‚è®°ä½ï¼Œä¸€æ—¦æˆ‘ä»¬åˆ›å»ºäº†WaitGroupï¼Œæˆ‘ä»¬ä¸èƒ½æ‹·è´å®ƒï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡å¼•ç”¨(æŒ‡é’ˆï¼Ÿï¼Ÿï¼Ÿ)ä¼ é€’ã€‚</p>

<pre><span class="kwd">package</span> <span class="pln">main</span>

<span class="kwd">import</span> <span class="pun">(</span>
    <span class="str">&#34;fmt&#34;</span>
    <span class="str">&#34;os&#34;</span>
    <span class="str">&#34;os/signal&#34;</span>
    <span class="str">&#34;sync&#34;</span>
    <span class="str">&#34;time&#34;</span>
<span class="pun">)</span>

<span class="kwd">func</span> <span class="pln">main</span><span class="pun">(</span><span class="pun">)</span> <span class="pun">{</span>
    <span class="com">// a channel to tell `tick()` and `tock()` to stop</span>
    <span class="pln">stopChan</span> <span class="pun">:</span><span class="pun">=</span> <span class="kwd">make</span><span class="pun">(</span><span class="pln">chan</span> <span class="kwd">struct</span><span class="pun">{</span><span class="pun">}</span><span class="pun">)</span>

    <span class="com">// a WaitGroup for the goroutines to tell us they&#39;ve stopped</span>
    <span class="pln">wg</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">sync</span><span class="pun">.</span><span class="typ">WaitGroup</span><span class="pun">{</span><span class="pun">}</span>

    <span class="com">// a channel for `tick()` to tell us they&#39;ve stopped</span>
    <span class="pln">wg</span><span class="pun">.</span><span class="typ">Add</span><span class="pun">(</span><span class="dec">1</span><span class="pun">)</span>
    <span class="pln">go</span> <span class="pln">tick</span><span class="pun">(</span><span class="pln">stopChan</span><span class="pun">,</span> <span class="pun">&amp;</span><span class="pln">wg</span><span class="pun">)</span>

    <span class="com">// a channel for `tock()` to tell us they&#39;ve stopped</span>
    <span class="pln">wg</span><span class="pun">.</span><span class="typ">Add</span><span class="pun">(</span><span class="dec">1</span><span class="pun">)</span>
    <span class="pln">go</span> <span class="pln">tock</span><span class="pun">(</span><span class="pln">stopChan</span><span class="pun">,</span> <span class="pun">&amp;</span><span class="pln">wg</span><span class="pun">)</span>

    <span class="com">// listen for C-c</span>
    <span class="pln">c</span> <span class="pun">:</span><span class="pun">=</span> <span class="kwd">make</span><span class="pun">(</span><span class="pln">chan</span> <span class="pln">os</span><span class="pun">.</span><span class="typ">Signal</span><span class="pun">,</span> <span class="dec">1</span><span class="pun">)</span>
    <span class="pln">signal</span><span class="pun">.</span><span class="typ">Notify</span><span class="pun">(</span><span class="pln">c</span><span class="pun">,</span> <span class="pln">os</span><span class="pun">.</span><span class="typ">Interrupt</span><span class="pun">)</span>
    <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">c</span>
    <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;main: received C-c - shutting down&#34;</span><span class="pun">)</span>

    <span class="com">// tell the goroutine to stop</span>
    <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;main: telling goroutines to stop&#34;</span><span class="pun">)</span>
    <span class="pln">close</span><span class="pun">(</span><span class="pln">stopChan</span><span class="pun">)</span>
    <span class="com">// and wait for them both to reply back</span>
    <span class="pln">wg</span><span class="pun">.</span><span class="typ">Wait</span><span class="pun">(</span><span class="pun">)</span>
    <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;main: all goroutines have told us they&#39;ve finished&#34;</span><span class="pun">)</span>
<span class="pun">}</span>

<span class="kwd">func</span> <span class="pln">tick</span><span class="pun">(</span><span class="pln">stop</span> <span class="pln">chan</span> <span class="kwd">struct</span><span class="pun">{</span><span class="pun">}</span><span class="pun">,</span> <span class="pln">wg</span> <span class="pun">*</span><span class="pln">sync</span><span class="pun">.</span><span class="typ">WaitGroup</span><span class="pun">)</span> <span class="pun">{</span>
    <span class="com">// tell the caller we&#39;ve stopped</span>
    <span class="pln">defer</span> <span class="pln">wg</span><span class="pun">.</span><span class="typ">Done</span><span class="pun">(</span><span class="pun">)</span>

    <span class="pln">ticker</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">NewTicker</span><span class="pun">(</span><span class="dec">3</span> <span class="pun">*</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Second</span><span class="pun">)</span>
    <span class="pln">defer</span> <span class="pln">ticker</span><span class="pun">.</span><span class="typ">Stop</span><span class="pun">(</span><span class="pun">)</span>

    <span class="kwd">for</span> <span class="pun">{</span>
        <span class="pln">select</span> <span class="pun">{</span>
        <span class="kwd">case</span> <span class="pln">now</span> <span class="pun">:</span><span class="pun">=</span> <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">ticker</span><span class="pun">.</span><span class="typ">C</span><span class="pun">:</span>
            <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;tick: tick %s\n&#34;</span><span class="pun">,</span> <span class="pln">now</span><span class="pun">.</span><span class="typ">UTC</span><span class="pun">(</span><span class="pun">)</span><span class="pun">.</span><span class="typ">Format</span><span class="pun">(</span><span class="str">&#34;20060102-150405.000000000&#34;</span><span class="pun">)</span><span class="pun">)</span>
        <span class="kwd">case</span> <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">stop</span><span class="pun">:</span>
            <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;tick: caller has told us to stop&#34;</span><span class="pun">)</span>
            <span class="kwd">return</span>
        <span class="pun">}</span>
    <span class="pun">}</span>
<span class="pun">}</span>

<span class="kwd">func</span> <span class="pln">tock</span><span class="pun">(</span><span class="pln">stop</span> <span class="pln">chan</span> <span class="kwd">struct</span><span class="pun">{</span><span class="pun">}</span><span class="pun">,</span> <span class="pln">wg</span> <span class="pun">*</span><span class="pln">sync</span><span class="pun">.</span><span class="typ">WaitGroup</span><span class="pun">)</span> <span class="pun">{</span>
    <span class="com">// tell the caller we&#39;ve stopped</span>
    <span class="pln">defer</span> <span class="pln">wg</span><span class="pun">.</span><span class="typ">Done</span><span class="pun">(</span><span class="pun">)</span>

    <span class="pln">ticker</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">NewTicker</span><span class="pun">(</span><span class="dec">5</span> <span class="pun">*</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Second</span><span class="pun">)</span>
    <span class="pln">defer</span> <span class="pln">ticker</span><span class="pun">.</span><span class="typ">Stop</span><span class="pun">(</span><span class="pun">)</span>

    <span class="kwd">for</span> <span class="pun">{</span>
        <span class="pln">select</span> <span class="pun">{</span>
        <span class="kwd">case</span> <span class="pln">now</span> <span class="pun">:</span><span class="pun">=</span> <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">ticker</span><span class="pun">.</span><span class="typ">C</span><span class="pun">:</span>
            <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;tock: tock %s\n&#34;</span><span class="pun">,</span> <span class="pln">now</span><span class="pun">.</span><span class="typ">UTC</span><span class="pun">(</span><span class="pun">)</span><span class="pun">.</span><span class="typ">Format</span><span class="pun">(</span><span class="str">&#34;20060102-150405.000000000&#34;</span><span class="pun">)</span><span class="pun">)</span>
        <span class="kwd">case</span> <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">stop</span><span class="pun">:</span>
            <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;tock: caller has told us to stop&#34;</span><span class="pun">)</span>
            <span class="kwd">return</span>
        <span class="pun">}</span>
    <span class="pun">}</span>
<span class="pun">}</span>

</pre>

<p>The output is exactly the same as the previous program, so we should be on the right lines. The program itself has a few lines removed, a few lines added and looks very similar, however adding new goroutines is a little simpler now. We just need call wg.Add(1) and pass both the stop channel and the waitgroup to it. As I said, itâ€™s only a little simpler but thatâ€™s good, right?</p>

<p>è¾“å‡ºå®Œå…¨å’Œä¹‹å‰ç¨‹åºä¸€æ ·ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥åœ¨æ­£ç¡®çš„è¡Œä¸Šã€‚è¿™ä¸ªç¨‹åºæœ¬èº«æœ‰äº›è¡Œåˆ é™¤äº†ï¼Œä¸€äº›è¡Œæ·»åŠ äº†ï¼Œçœ‹èµ·æ¥å·®ä¸å¤šï¼Œä½†æ˜¯æ·»åŠ æ–°çš„goroutineæ¯”ä¹‹å‰ç®€å•äº†ã€‚æˆ‘ä»¬ä»…ä»…éœ€è¦è°ƒç”¨wg.Add(1)ï¼Œä¼ é€’stopé€šé“å’Œwaitgroupç»™å®ƒã€‚æ­£å¦‚æˆ‘æ‰€è¯´çš„ï¼Œä»…ä»…ç®€å•ä¸€ç‚¹ç‚¹ï¼Œä½†æ˜¯å¾ˆä¸é”™ï¼Œå¯¹å§ï¼Ÿï¼</p>

<pre><span class="pun">$</span> <span class="pln">go</span> <span class="pln">run</span> <span class="dec">06</span><span class="pun">/</span><span class="pln">tidy</span><span class="pun">.</span><span class="pln">go</span> 
<span class="pln">tick</span><span class="pun">:</span> <span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">221717.992723221</span>
<span class="pln">tock</span><span class="pun">:</span> <span class="pln">tock</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">221719.992700713</span>
<span class="pln">tick</span><span class="pun">:</span> <span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">221720.992722592</span>
<span class="pln">tick</span><span class="pun">:</span> <span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">221723.992745407</span>
<span class="pun">^</span><span class="typ">Cmain</span><span class="pun">:</span> <span class="pln">received</span> <span class="typ">C</span><span class="pun">-</span><span class="pln">c</span> <span class="pun">-</span> <span class="pln">shutting</span> <span class="pln">down</span>
<span class="pln">main</span><span class="pun">:</span> <span class="pln">telling</span> <span class="pln">goroutines</span> <span class="pln">to</span> <span class="pln">stop</span>
<span class="pln">tock</span><span class="pun">:</span> <span class="kwd">caller</span> <span class="pln">has</span> <span class="pln">told</span> <span class="pln">us</span> <span class="pln">to</span> <span class="pln">stop</span>
<span class="pln">tick</span><span class="pun">:</span> <span class="kwd">caller</span> <span class="pln">has</span> <span class="pln">told</span> <span class="pln">us</span> <span class="pln">to</span> <span class="pln">stop</span>
<span class="pln">main</span><span class="pun">:</span> <span class="pln">all</span> <span class="pln">goroutines</span> <span class="pln">have</span> <span class="pln">told</span> <span class="pln">us</span> <span class="pln">they</span><span class="str">&#39;ve finished
</span></pre>

<p>So far, so good. However, there is another problem on the horizon. Letâ€™s imagine we want to also create a webserver in a goroutine. In the past we used to create one using the following code. The problem here though is that the server blocks the goroutine until it has finished.</p>

<p>åˆ°ç°åœ¨ä¸ºæ­¢ï¼Œéƒ½å¾ˆå¥½ï¼Œä½†æ˜¯ï¼Œåˆæœ‰ä¸€ä¸ªæ–°çš„é—®é¢˜ã€‚è®©æˆ‘ä»¬æƒ³è±¡ä¸€ä¸‹æˆ‘ä»¬ä¹Ÿæƒ³åœ¨goroutineä¸­åˆ›å»ºwebæœåŠ¡å™¨ã€‚è¿‡å»æˆ‘ä»¬å¸¸å¸¸ä½¿ç”¨ä»¥ä¸‹çš„ä»£ç åˆ›å»ºåç¨‹ã€‚è€Œç°åœ¨çš„é—®é¢˜æ˜¯serverç›´åˆ°å®ƒç»“æŸå‰ï¼Œä¸€ç›´é˜»å¡ç€åç¨‹ã€‚</p>

<pre><span class="kwd">package</span> <span class="pln">main</span>

<span class="kwd">import</span> <span class="pun">(</span>
    <span class="str">&#34;fmt&#34;</span>
    <span class="str">&#34;net/http&#34;</span>
<span class="pun">)</span>

<span class="kwd">func</span> <span class="pln">main</span><span class="pun">(</span><span class="pun">)</span> <span class="pun">{</span>
    <span class="pln">http</span><span class="pun">.</span><span class="typ">HandleFunc</span><span class="pun">(</span><span class="str">&#34;/&#34;</span><span class="pun">,</span> <span class="kwd">func</span><span class="pun">(</span><span class="pln">w</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">ResponseWriter</span><span class="pun">,</span> <span class="pln">r</span> <span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">)</span> <span class="pun">{</span>
        <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Fprintln</span><span class="pun">(</span><span class="pln">w</span><span class="pun">,</span> <span class="str">&#34;Hello, World!&#34;</span><span class="pun">)</span>
    <span class="pun">}</span><span class="pun">)</span>
    <span class="pln">http</span><span class="pun">.</span><span class="typ">ListenAndServe</span><span class="pun">(</span><span class="str">&#34;:8080&#34;</span><span class="pun">,</span> <span class="kwd">nil</span><span class="pun">)</span>
<span class="pun">}</span>
</pre>

<p>So the question is, how do we also tell the web server to stop?
æ‰€ä»¥é—®é¢˜æ˜¯ï¼Œæˆ‘ä»¬åº”è¯¥æ€æ ·å‘Šè¯‰webæœåŠ¡å™¨å»åœæ­¢è¿è¡Œã€‚</p>

<h2>Context</h2>

<p>In Go v1.7, the context package was added and that is our next secret. The ability to tell a webserver to stop using a context was also added. Using a Context has become the swiss-army knife of concurrency control in Go over the past few years (it used to live at <a href="https://godoc.org/golang.org/x/net/context">https://godoc.org/golang.org/x/net/context</a> but was moved into the standard library).</p>

<p>åœ¨Goçš„1.7ç‰ˆæœ¬åŠ å…¥äº†contextåŒ…ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬ä¸‹ä¸€ä¸ªç§˜å¯†æ­¦å™¨ã€‚ä½¿ç”¨contextæ¥åœæ­¢webservverçš„è¿è¡Œçš„èƒ½åŠ›åŒæ ·ä¹Ÿå…·æœ‰ã€‚åœ¨Goçš„è¿‡å»çš„å‡ å¹´ä¸­ï¼Œä½¿ç”¨Contextå˜æˆå¹¶å‘æ§åˆ¶çš„ç‘å£«å†›åˆ€ã€‚ï¼ˆå®ƒä»¥å‰åœ¨ <a href="https://godoc.org/golang.org/x/net/context,ä½†æ˜¯ç°åœ¨å·²ç»ç§»å…¥æ ‡å‡†åº“äº†ï¼‰">https://godoc.org/golang.org/x/net/context,ä½†æ˜¯ç°åœ¨å·²ç»ç§»å…¥æ ‡å‡†åº“äº†ï¼‰</a></p>

<p>Letâ€™s have a very quick look at how we can create and cancel a Context:
è®©æˆ‘ä»¬å¿«é€Ÿåœ°äº†è§£ä¸€ä¸‹å¦‚ä½•åˆ›å»ºå’Œå–æ¶ˆä¸Šä¸‹æ–‡:</p>

<pre>    <span class="com">// create a context that we can cancel</span>
    <span class="pln">ctx</span><span class="pun">,</span> <span class="pln">cancel</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">context</span><span class="pun">.</span><span class="typ">WithCancel</span><span class="pun">(</span><span class="pln">context</span><span class="pun">.</span><span class="typ">Background</span><span class="pun">(</span><span class="pun">)</span><span class="pun">)</span>
    <span class="pln">defer</span> <span class="pln">cancel</span><span class="pun">(</span><span class="pun">)</span>

    <span class="com">// pass this ctx to our goroutines - each of which would select on `&lt;-ctx.Done()`</span>
    <span class="pln">go</span> <span class="pln">tick</span><span class="pun">(</span><span class="pln">ctx</span><span class="pun">,</span> <span class="pun">.</span><span class="pun">.</span><span class="pun">.</span><span class="pun">)</span>

    <span class="com">// sometime later ... in our case after a `C-c`</span>
    <span class="pln">cancel</span><span class="pun">(</span><span class="pun">)</span>
</pre>

<p>(Side note: if you havenâ€™t see JustForFunc by Francesc Campoy yet, you should watch it - Francesc talks about the Context package in episodes 9 and 10.)</p>

<p>One major advantage of using a Context over a stop channel is if any of the goroutines are also creating other goroutines to do the work for them. In the case of using stopped channels weâ€™d have to create more stop channels to tell the child goroutines to finish. Weâ€™d also have to tie much of this together to make it work. When we use a Context however, each goroutine would derive a Context from the one it was given, and each of them would be told to cancel.</p>

<p>ä½¿ç”¨Contextæ¯”ä½¿ç”¨stop channelæœ€ä¸»è¦çš„ä¼˜åŠ¿æ˜¯ï¼Œåç¨‹æ˜¯å¦ä¹Ÿåˆ›å»ºå…¶ä»–åç¨‹æ¥å·¥ä½œã€‚å› ä¸ºä½¿ç”¨stopped channelsï¼Œæˆ‘ä»¬ä¸å¾—ä¸åˆ›å»ºæ›´å¤šçš„stop channeï¼Œæ¥è®©å­åç¨‹ç»ˆæ­¢ã€‚æˆ‘ä»¬åŒæ ·ä¸å¾—ä¸å°†è¿™äº›æ•´åˆèµ·æ¥æ¥è®©å®ƒèµ·ä½œç”¨ã€‚ä½†æ˜¯å½“æˆ‘ä»¬ä½¿ç”¨Contextï¼Œæ¯ä¸€ä¸ªåç¨‹éƒ½ä¼šç»§æ‰¿ä¼ é€’ç»™å®ƒçš„Contextï¼Œå¹¶ä¸”æ¯ä¸€ä¸ª(ç»§æ‰¿è€…)éƒ½è¢«å‘Šä¹‹è¦åˆ é™¤ã€‚</p>

<p>Before we try adding a webserver, letâ€™s change our example above to use a Context. The first thing weâ€™ll need to do is pass the context to each goroutine instead of the channel. Instead of selecting on the channel, itâ€™ll select on &lt;-ctx.Done() and still signal back to main() when it has tidied up.</p>

<p>åœ¨æˆ‘ä»¬å°è¯•æ·»åŠ ä¸€ä¸ªwebserverä¹‹å‰,è®©æˆ‘ä»¬ä¿®æ”¹æˆ‘ä»¬ä¸Šé¢ä½¿ç”¨Contextä¾‹å­ã€‚æˆ‘è¦åšçš„ç¬¬ä¸€ä¸ªäº‹æƒ…å°±æ˜¯å°†ä¼ é€’channelæ”¹ä¸ºä¼ é€’Contextç»™æ¯ä¸€ä¸ªgoroutineï¼Œå°†ç›‘å¬channelæ”¹ä¸ºç›‘å¬ctx.Done()ï¼Œå¹¶ä¸”ä»å‘é€ä¿¡å·ï¼Œå½“æ•´ç†ï¼ˆtidy upï¼‰å¥½åç¨‹ä¹‹åè¿”å›main()</p>

<pre><span class="kwd">package</span> <span class="pln">main</span>

<span class="kwd">import</span> <span class="pun">(</span>
    <span class="str">&#34;context&#34;</span>
    <span class="str">&#34;fmt&#34;</span>
    <span class="str">&#34;os&#34;</span>
    <span class="str">&#34;os/signal&#34;</span>
    <span class="str">&#34;sync&#34;</span>
    <span class="str">&#34;time&#34;</span>
<span class="pun">)</span>

<span class="kwd">func</span> <span class="pln">main</span><span class="pun">(</span><span class="pun">)</span> <span class="pun">{</span>
    <span class="com">// create a context that we can cancel</span>
    <span class="pln">ctx</span><span class="pun">,</span> <span class="pln">cancel</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">context</span><span class="pun">.</span><span class="typ">WithCancel</span><span class="pun">(</span><span class="pln">context</span><span class="pun">.</span><span class="typ">Background</span><span class="pun">(</span><span class="pun">)</span><span class="pun">)</span>
    <span class="pln">defer</span> <span class="pln">cancel</span><span class="pun">(</span><span class="pun">)</span>

    <span class="com">// a WaitGroup for the goroutines to tell us they&#39;ve stopped</span>
    <span class="pln">wg</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">sync</span><span class="pun">.</span><span class="typ">WaitGroup</span><span class="pun">{</span><span class="pun">}</span>

    <span class="com">// a channel for `tick()` to tell us they&#39;ve stopped</span>
    <span class="pln">wg</span><span class="pun">.</span><span class="typ">Add</span><span class="pun">(</span><span class="dec">1</span><span class="pun">)</span>
    <span class="pln">go</span> <span class="pln">tick</span><span class="pun">(</span><span class="pln">ctx</span><span class="pun">,</span> <span class="pun">&amp;</span><span class="pln">wg</span><span class="pun">)</span>

    <span class="com">// a channel for `tock()` to tell us they&#39;ve stopped</span>
    <span class="pln">wg</span><span class="pun">.</span><span class="typ">Add</span><span class="pun">(</span><span class="dec">1</span><span class="pun">)</span>
    <span class="pln">go</span> <span class="pln">tock</span><span class="pun">(</span><span class="pln">ctx</span><span class="pun">,</span> <span class="pun">&amp;</span><span class="pln">wg</span><span class="pun">)</span>

    <span class="com">// listen for C-c</span>
    <span class="pln">c</span> <span class="pun">:</span><span class="pun">=</span> <span class="kwd">make</span><span class="pun">(</span><span class="pln">chan</span> <span class="pln">os</span><span class="pun">.</span><span class="typ">Signal</span><span class="pun">,</span> <span class="dec">1</span><span class="pun">)</span>
    <span class="pln">signal</span><span class="pun">.</span><span class="typ">Notify</span><span class="pun">(</span><span class="pln">c</span><span class="pun">,</span> <span class="pln">os</span><span class="pun">.</span><span class="typ">Interrupt</span><span class="pun">)</span>
    <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">c</span>
    <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;main: received C-c - shutting down&#34;</span><span class="pun">)</span>

    <span class="com">// tell the goroutines to stop</span>
    <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;main: telling goroutines to stop&#34;</span><span class="pun">)</span>
    <span class="pln">cancel</span><span class="pun">(</span><span class="pun">)</span>

    <span class="com">// and wait for them both to reply back</span>
    <span class="pln">wg</span><span class="pun">.</span><span class="typ">Wait</span><span class="pun">(</span><span class="pun">)</span>
    <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;main: all goroutines have told us they&#39;ve finished&#34;</span><span class="pun">)</span>
<span class="pun">}</span>

<span class="kwd">func</span> <span class="pln">tick</span><span class="pun">(</span><span class="pln">ctx</span> <span class="pln">context</span><span class="pun">.</span><span class="typ">Context</span><span class="pun">,</span> <span class="pln">wg</span> <span class="pun">*</span><span class="pln">sync</span><span class="pun">.</span><span class="typ">WaitGroup</span><span class="pun">)</span> <span class="pun">{</span>
    <span class="com">// tell the caller we&#39;ve stopped</span>
    <span class="pln">defer</span> <span class="pln">wg</span><span class="pun">.</span><span class="typ">Done</span><span class="pun">(</span><span class="pun">)</span>

    <span class="pln">ticker</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">NewTicker</span><span class="pun">(</span><span class="dec">3</span> <span class="pun">*</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Second</span><span class="pun">)</span>
    <span class="pln">defer</span> <span class="pln">ticker</span><span class="pun">.</span><span class="typ">Stop</span><span class="pun">(</span><span class="pun">)</span>

    <span class="kwd">for</span> <span class="pun">{</span>
        <span class="pln">select</span> <span class="pun">{</span>
        <span class="kwd">case</span> <span class="pln">now</span> <span class="pun">:</span><span class="pun">=</span> <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">ticker</span><span class="pun">.</span><span class="typ">C</span><span class="pun">:</span>
            <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;tick: tick %s\n&#34;</span><span class="pun">,</span> <span class="pln">now</span><span class="pun">.</span><span class="typ">UTC</span><span class="pun">(</span><span class="pun">)</span><span class="pun">.</span><span class="typ">Format</span><span class="pun">(</span><span class="str">&#34;20060102-150405.000000000&#34;</span><span class="pun">)</span><span class="pun">)</span>
        <span class="kwd">case</span> <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">ctx</span><span class="pun">.</span><span class="typ">Done</span><span class="pun">(</span><span class="pun">)</span><span class="pun">:</span>
            <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;tick: caller has told us to stop&#34;</span><span class="pun">)</span>
            <span class="kwd">return</span>
        <span class="pun">}</span>
    <span class="pun">}</span>
<span class="pun">}</span>

<span class="kwd">func</span> <span class="pln">tock</span><span class="pun">(</span><span class="pln">ctx</span> <span class="pln">context</span><span class="pun">.</span><span class="typ">Context</span><span class="pun">,</span> <span class="pln">wg</span> <span class="pun">*</span><span class="pln">sync</span><span class="pun">.</span><span class="typ">WaitGroup</span><span class="pun">)</span> <span class="pun">{</span>
    <span class="com">// tell the caller we&#39;ve stopped</span>
    <span class="pln">defer</span> <span class="pln">wg</span><span class="pun">.</span><span class="typ">Done</span><span class="pun">(</span><span class="pun">)</span>

    <span class="pln">ticker</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">NewTicker</span><span class="pun">(</span><span class="dec">5</span> <span class="pun">*</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Second</span><span class="pun">)</span>
    <span class="pln">defer</span> <span class="pln">ticker</span><span class="pun">.</span><span class="typ">Stop</span><span class="pun">(</span><span class="pun">)</span>

    <span class="kwd">for</span> <span class="pun">{</span>
        <span class="pln">select</span> <span class="pun">{</span>
        <span class="kwd">case</span> <span class="pln">now</span> <span class="pun">:</span><span class="pun">=</span> <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">ticker</span><span class="pun">.</span><span class="typ">C</span><span class="pun">:</span>
            <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;tock: tock %s\n&#34;</span><span class="pun">,</span> <span class="pln">now</span><span class="pun">.</span><span class="typ">UTC</span><span class="pun">(</span><span class="pun">)</span><span class="pun">.</span><span class="typ">Format</span><span class="pun">(</span><span class="str">&#34;20060102-150405.000000000&#34;</span><span class="pun">)</span><span class="pun">)</span>
        <span class="kwd">case</span> <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">ctx</span><span class="pun">.</span><span class="typ">Done</span><span class="pun">(</span><span class="pun">)</span><span class="pun">:</span>
            <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;tock: caller has told us to stop&#34;</span><span class="pun">)</span>
            <span class="kwd">return</span>
        <span class="pun">}</span>
    <span class="pun">}</span>
<span class="pun">}</span>
</pre>

<p>There is very little difference between this program and the previous one, however we now have the ability to:</p>

<p>è¿™ä¸ªç¨‹åºä¸ä¹‹å‰çš„æœ‰ç‚¹ä¸ä¸€æ ·ï¼Œæˆ‘ä»¬ç°åœ¨æœ‰èƒ½åŠ›æ¥ï¼š</p>

<ol>
<li><p>create a webserver that we can cancel with the Context
åˆ›å»ºä¸€ä¸ªèƒ½ä½¿ç”¨Contextå–æ¶ˆçš„webserver</p></li>

<li><p>pass the same context to sub goroutines which will also cancel their work when told
And again, the output is the same. We must be doing something right.</p></li>
</ol>

<p>ä¼ é€’ç›¸åŒçš„contextåˆ°å­åç¨‹ï¼Œå¹¶å–æ¶ˆåç¨‹ã€‚è¾“å‡ºç»“æœåˆä¸€æ¬¡ç›¸åŒã€‚æˆ‘ä»¬åšå¯¹äº†ã€‚</p>

<pre><span class="pun">$</span> <span class="pln">go</span> <span class="pln">run</span> <span class="dec">07</span><span class="pun">/</span><span class="pln">tidy</span><span class="pun">.</span><span class="pln">go</span> 
<span class="pln">tick</span><span class="pun">:</span> <span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">223954.341894561</span>
<span class="pln">tock</span><span class="pun">:</span> <span class="pln">tock</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">223956.341886006</span>
<span class="pln">tick</span><span class="pun">:</span> <span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">223957.341887182</span>
<span class="pln">tick</span><span class="pun">:</span> <span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">224000.341927373</span>
<span class="pun">^</span><span class="typ">Cmain</span><span class="pun">:</span> <span class="pln">received</span> <span class="typ">C</span><span class="pun">-</span><span class="pln">c</span> <span class="pun">-</span> <span class="pln">shutting</span> <span class="pln">down</span>
<span class="pln">main</span><span class="pun">:</span> <span class="pln">telling</span> <span class="pln">goroutines</span> <span class="pln">to</span> <span class="pln">stop</span>
<span class="pln">tock</span><span class="pun">:</span> <span class="kwd">caller</span> <span class="pln">has</span> <span class="pln">told</span> <span class="pln">us</span> <span class="pln">to</span> <span class="pln">stop</span>
<span class="pln">tick</span><span class="pun">:</span> <span class="kwd">caller</span> <span class="pln">has</span> <span class="pln">told</span> <span class="pln">us</span> <span class="pln">to</span> <span class="pln">stop</span>
<span class="pln">main</span><span class="pun">:</span> <span class="pln">all</span> <span class="pln">goroutines</span> <span class="pln">have</span> <span class="pln">told</span> <span class="pln">us</span> <span class="pln">they</span><span class="str">&#39;ve finished
</span></pre>

<p>Now letâ€™s get onto the beast and tell our program to also serve HTTP requests.</p>

<p>ç°åœ¨è¦å®ç°æˆ‘ä»¬çš„é‡æœ›äº†ã€‚è®©æˆ‘ä»¬çš„ç¨‹åºåŒæ ·æä¾›HTTPè¯·æ±‚</p>

<h2>The Webserver</h2>

<p>Before we show the entire program, letâ€™s take a look at what the webserver goroutine would look like. The magic here is that instead of calling http.ListenAndServe() we explicitly create the webserver and by doing this we can eventually signal to it to stop. Weâ€™re going to model this on the excellent HTTP server connection draining section of this article by Tyler Christensen.</p>

<p>åœ¨æˆ‘ä»¬å±•ç¤ºå…¨éƒ¨ç¨‹åºä¹‹å‰ï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹webserverçš„åç¨‹æ˜¯ä»€ä¹ˆæ ·çš„ã€‚è¿™é‡Œç¥å¥‡çš„åœ°æ–¹æ˜¯ï¼Œä¸æ˜¯è°ƒç”¨ http.ListenAndServe()è€Œæ˜¯æ˜ç¡®çš„åˆ›å»ºwebserverå¹¶ä¸”é€šè¿‡è¿™æ ·åšï¼Œæˆ‘ä»¬èƒ½æœ€ç»ˆä½¿ç”¨ä¿¡å·ç»ˆæ­¢å®ƒã€‚æˆ‘ä»¬å°†è¦åœ¨è¿™ä¼˜ç§€çš„HTTPæœåŠ¡è¿æ¥ä¸Šæ„å»ºè¿™ä¸ªæ–¹æ³•</p>

<pre><span class="kwd">func</span> <span class="pln">server</span><span class="pun">(</span><span class="pln">ctx</span> <span class="pln">context</span><span class="pun">.</span><span class="typ">Context</span><span class="pun">,</span> <span class="pln">wg</span> <span class="pun">*</span><span class="pln">sync</span><span class="pun">.</span><span class="typ">WaitGroup</span><span class="pun">)</span> <span class="pun">{</span>
    <span class="com">// tell the caller that we&#39;ve stopped</span>
    <span class="pln">defer</span> <span class="pln">wg</span><span class="pun">.</span><span class="typ">Done</span><span class="pun">(</span><span class="pun">)</span>

    <span class="com">// create a new mux and handler</span>
    <span class="pln">mux</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">NewServeMux</span><span class="pun">(</span><span class="pun">)</span>
    <span class="pln">mux</span><span class="pun">.</span><span class="typ">Handle</span><span class="pun">(</span><span class="str">&#34;/&#34;</span><span class="pun">,</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">HandlerFunc</span><span class="pun">(</span><span class="kwd">func</span><span class="pun">(</span><span class="pln">w</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">ResponseWriter</span><span class="pun">,</span> <span class="pln">r</span> <span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">)</span> <span class="pun">{</span>
        <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;server: received request&#34;</span><span class="pun">)</span>
        <span class="pln">time</span><span class="pun">.</span><span class="typ">Sleep</span><span class="pun">(</span><span class="dec">3</span> <span class="pun">*</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Second</span><span class="pun">)</span>
        <span class="pln">io</span><span class="pun">.</span><span class="typ">WriteString</span><span class="pun">(</span><span class="pln">w</span><span class="pun">,</span> <span class="str">&#34;Finished!\n&#34;</span><span class="pun">)</span>
        <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;server: request finished&#34;</span><span class="pun">)</span>
    <span class="pun">}</span><span class="pun">)</span><span class="pun">)</span>

    <span class="com">// create a server</span>
    <span class="pln">srv</span> <span class="pun">:</span><span class="pun">=</span> <span class="pun">&amp;</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Server</span><span class="pun">{</span><span class="typ">Addr</span><span class="pun">:</span> <span class="str">&#34;:8080&#34;</span><span class="pun">,</span> <span class="typ">Handler</span><span class="pun">:</span> <span class="pln">mux</span><span class="pun">}</span>

    <span class="pln">go</span> <span class="kwd">func</span><span class="pun">(</span><span class="pun">)</span> <span class="pun">{</span>
        <span class="com">// service connections</span>
        <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">srv</span><span class="pun">.</span><span class="typ">ListenAndServe</span><span class="pun">(</span><span class="pun">)</span><span class="pun">;</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
            <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;Listen : %s\n&#34;</span><span class="pun">,</span> <span class="pln">err</span><span class="pun">)</span>
        <span class="pun">}</span>
    <span class="pun">}</span><span class="pun">(</span><span class="pun">)</span>

    <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">ctx</span><span class="pun">.</span><span class="typ">Done</span><span class="pun">(</span><span class="pun">)</span>
    <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;server: caller has told us to stop&#34;</span><span class="pun">)</span>

    <span class="com">// shut down gracefully, but wait no longer than 5 seconds before halting</span>
    <span class="pln">shutdownCtx</span><span class="pun">,</span> <span class="pln">cancel</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">context</span><span class="pun">.</span><span class="typ">WithTimeout</span><span class="pun">(</span><span class="pln">context</span><span class="pun">.</span><span class="typ">Background</span><span class="pun">(</span><span class="pun">)</span><span class="pun">,</span> <span class="dec">5</span><span class="pun">*</span><span class="pln">time</span><span class="pun">.</span><span class="typ">Second</span><span class="pun">)</span>
    <span class="pln">defer</span> <span class="pln">cancel</span><span class="pun">(</span><span class="pun">)</span>

    <span class="com">// ignore error since it will be &#34;Err shutting down server : context canceled&#34;</span>
    <span class="pln">srv</span><span class="pun">.</span><span class="typ">Shutdown</span><span class="pun">(</span><span class="pln">shutdownCtx</span><span class="pun">)</span>

    <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;server gracefully stopped&#34;</span><span class="pun">)</span>
<span class="pun">}</span>
</pre>

<p>For this func, the only two lines we added in main() were:</p>

<p>å¯¹äºè¿™ä¸ªå‡½æ•°æ¥è¯´ï¼Œåªéœ€main()æ·»åŠ ä¸¤è¡Œå°±è¡Œäº†ã€‚</p>

<pre>    <span class="com">// run `server` in it&#39;s own goroutine</span>
    <span class="pln">wg</span><span class="pun">.</span><span class="typ">Add</span><span class="pun">(</span><span class="dec">1</span><span class="pun">)</span>
    <span class="pln">go</span> <span class="pln">server</span><span class="pun">(</span><span class="pln">ctx</span><span class="pun">,</span> <span class="pun">&amp;</span><span class="pln">wg</span><span class="pun">)</span>
</pre>

<p>For the output of this program, I will send a request to the server curl localhost:8080 after the first tick and you should see the request start and finish either side of the 2nd tick. And as usual weâ€™ll just show three ticks (and one tock):</p>

<p>è¾“å‡ºç¨‹åºçš„ç»“æœï¼Œæˆ‘å°†åœ¨ç¬¬ä¸€ä¸ªtickåé¢å‘æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œä½ åº”è¯¥çœ‹åˆ°è¯·æ±‚åœ¨å¼€å§‹å’Œç»“æŸåœ¨ç¬¬äºŒä¸ªtickçš„ä¸¤è¾¹ã€‚å’Œé€šå¸¸çš„ä¸€æ ·ï¼Œæˆ‘ä»¬ä»…å±•ç¤º3ä¸ªtickï¼ˆå’Œä¸€ä¸ªtockï¼‰</p>

<pre><span class="pun">$</span> <span class="pln">go</span> <span class="pln">run</span> <span class="dec">08</span><span class="pun">/</span><span class="pln">tidy</span><span class="pun">.</span><span class="pln">go</span> 
<span class="pln">tick</span><span class="pun">:</span> <span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">230003.228960866</span>
<span class="pln">server</span><span class="pun">:</span> <span class="pln">received</span> <span class="pln">request</span>
<span class="pln">tock</span><span class="pun">:</span> <span class="pln">tock</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">230005.228893119</span>
<span class="pln">tick</span><span class="pun">:</span> <span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">230006.228868513</span>
<span class="pln">server</span><span class="pun">:</span> <span class="pln">request</span> <span class="pln">finished</span>
<span class="pln">tick</span><span class="pun">:</span> <span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">230009.228863351</span>
<span class="pun">^</span><span class="typ">Cmain</span><span class="pun">:</span> <span class="pln">received</span> <span class="typ">C</span><span class="pun">-</span><span class="pln">c</span> <span class="pun">-</span> <span class="pln">shutting</span> <span class="pln">down</span>
<span class="pln">main</span><span class="pun">:</span> <span class="pln">telling</span> <span class="pln">goroutines</span> <span class="pln">to</span> <span class="pln">stop</span>
<span class="pln">server</span><span class="pun">:</span> <span class="kwd">caller</span> <span class="pln">has</span> <span class="pln">told</span> <span class="pln">us</span> <span class="pln">to</span> <span class="pln">stop</span>
<span class="pln">tick</span><span class="pun">:</span> <span class="kwd">caller</span> <span class="pln">has</span> <span class="pln">told</span> <span class="pln">us</span> <span class="pln">to</span> <span class="pln">stop</span>
<span class="pln">server</span> <span class="pln">gracefully</span> <span class="pln">stopped</span>
<span class="pln">tock</span><span class="pun">:</span> <span class="kwd">caller</span> <span class="pln">has</span> <span class="pln">told</span> <span class="pln">us</span> <span class="pln">to</span> <span class="pln">stop</span>
<span class="pln">main</span><span class="pun">:</span> <span class="pln">all</span> <span class="pln">goroutines</span> <span class="pln">have</span> <span class="pln">told</span> <span class="pln">us</span> <span class="pln">they</span><span class="str">&#39;ve finished
</span></pre>

<p>And as we expected the server also shut down correctly. This time though, Iâ€™ll send a request after the 2nd tick but C-c the server before the 3rd tick to demonstrate the server graefully shutting down.</p>

<p>å’Œæˆ‘ä»¬é¢„æœŸçš„ä¸€æ ·ï¼Œæ­£ç¡®çš„é€€å‡ºäº†ã€‚è¿™ä¸€æ¬¡ï¼Œæˆ‘ä»¬åœ¨ç¬¬äºŒä¸ªtickåå‘å‡ºè¯·æ±‚ï¼Œä½†æ˜¯åœ¨ç¬¬ä¸‰ä¸ªtickå‰å‘é€C-cï¼Œä»¥æ­¤æ¥è¯æ˜æœåŠ¡å™¨å®‰å…¨é€€å‡ºäº†ã€‚</p>

<pre><span class="pun">$</span> <span class="pln">go</span> <span class="pln">run</span> <span class="dec">08</span><span class="pun">/</span><span class="pln">tidy</span><span class="pun">.</span><span class="pln">go</span> 
<span class="pln">tick</span><span class="pun">:</span> <span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">230408.026717601</span>
<span class="pln">tock</span><span class="pun">:</span> <span class="pln">tock</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">230410.026710464</span>
<span class="pln">tick</span><span class="pun">:</span> <span class="pln">tick</span> <span class="dec">20170612</span><span class="pun">-</span><span class="dec">230411.026700385</span>
<span class="pln">server</span><span class="pun">:</span> <span class="pln">received</span> <span class="pln">request</span>
<span class="pun">^</span><span class="typ">Cmain</span><span class="pun">:</span> <span class="pln">received</span> <span class="typ">C</span><span class="pun">-</span><span class="pln">c</span> <span class="pun">-</span> <span class="pln">shutting</span> <span class="pln">down</span>
<span class="pln">main</span><span class="pun">:</span> <span class="pln">telling</span> <span class="pln">goroutines</span> <span class="pln">to</span> <span class="pln">stop</span>
<span class="pln">tick</span><span class="pun">:</span> <span class="kwd">caller</span> <span class="pln">has</span> <span class="pln">told</span> <span class="pln">us</span> <span class="pln">to</span> <span class="pln">stop</span>
<span class="pln">tock</span><span class="pun">:</span> <span class="kwd">caller</span> <span class="pln">has</span> <span class="pln">told</span> <span class="pln">us</span> <span class="pln">to</span> <span class="pln">stop</span>
<span class="pln">server</span><span class="pun">:</span> <span class="kwd">caller</span> <span class="pln">has</span> <span class="pln">told</span> <span class="pln">us</span> <span class="pln">to</span> <span class="pln">stop</span>
<span class="typ">Listen</span> <span class="pun">:</span> <span class="pln">http</span><span class="pun">:</span> <span class="typ">Server</span> <span class="pln">closed</span>
<span class="pln">server</span><span class="pun">:</span> <span class="pln">request</span> <span class="pln">finished</span>
<span class="pln">server</span> <span class="pln">gracefully</span> <span class="pln">stopped</span>
<span class="pln">main</span><span class="pun">:</span> <span class="pln">all</span> <span class="pln">goroutines</span> <span class="pln">have</span> <span class="pln">told</span> <span class="pln">us</span> <span class="pln">they</span><span class="str">&#39;ve finished
</span></pre>

<p>Notice that both tick() and tock() finished first, then we had a couple of seconds where we waited for the webserver to finish itâ€™s request and then finally shut down. In the previous example the server shut down when it wasnâ€™t servicing any requests and the srv.ListenAndServe() didnâ€™t return any error. In this example the server was servicing a request and returned the http: Server closed error which appeared above - after which the request finished message appeared to prove the request was still in progress. However, it did finish, the client received the response and everything shut down as expected.ã€</p>

<p>æ³¨æ„ï¼štick()å’Œtock()å…ˆç»“æŸï¼Œç„¶åæˆ‘ä»¬æˆ‘ä»¬ç­‰å¾…äº†ä¸€ä¼šæœåŠ¡å™¨å®Œæˆè¯·æ±‚ä¹‹åï¼Œæœ€ç»ˆé€€å‡ºäº†ã€‚ä¹‹å‰çš„ä¾‹å­ï¼Œå½“æœåŠ¡å™¨æ²¡æœ‰å¤„ç†ä»»ä½•è¯·æ±‚çš„æ—¶å€™ï¼Œä¸” the srv.ListenAndServe()æ²¡æœ‰è¿”å›ä»»ä½•é”™è¯¯ï¼ŒæœåŠ¡å™¨ï¼ˆç«‹å³ï¼‰é€€å‡ºã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼ŒæœåŠ¡å™¨å¤„ç†è¯·æ±‚å¹¶è¿”å›äº†ä¸Šé¢å‡ºç°çš„http: Server closedé”™è¯¯ â€“  è¯·æ±‚å®Œæˆä¹‹åï¼Œå‡ºç°çš„â€œrequest finishedâ€ä¿¡æ¯è¯æ˜äº†è¯·æ±‚ä»ç„¶åœ¨æ‰§è¡Œã€‚ä½†æ˜¯ï¼Œå®ƒçš„ç¡®ç»“æŸäº†ï¼Œå®¢æˆ·ç«¯æ”¶åˆ°äº†å“åº”ï¼Œä¸€åˆ‡éƒ½åƒæœŸæœ›çš„é‚£æ ·ç»“æŸã€‚</p>

<pre><span class="pun">$</span> <span class="pln">curl</span> <span class="pln">localhost</span><span class="pun">:</span><span class="dec">8080</span>
<span class="typ">Finished</span><span class="pun">!</span>
</pre>

<p>And thatâ€™s it! I hope youâ€™ve enjoyed following along in this rather long article, but I hope we demonstrated not just how to use a Context to cancel multiple goroutines, but also how the way we write concurrent Go programs has changed over the years. As with everything, there are many ways to do all of this and Iâ€™m sure Iâ€™ve missed some but I hope that has given you a taster to play with more concurrency and Context.</p>

<h1>æˆ‘çš„è¯»ï¼ˆç¿»è¯‘ï¼Ÿï¼‰åæ„Ÿ</h1>

<p>ä½¿ç”¨stopped channelç­‰å¾…æ‰€æœ‰çš„åç¨‹ç»“æŸ</p>

<pre><span class="kwd">for</span> <span class="pln">i</span> <span class="pun">:</span><span class="pun">=</span> <span class="dec">0</span><span class="pun">;</span> <span class="pln">i</span> <span class="pun">&lt;</span> <span class="pln">count</span><span class="pun">;</span> <span class="pln">i</span><span class="pun">+</span><span class="pun">+</span><span class="pun">{</span>
    <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">stoppedChan</span>
<span class="pun">}</span> 
</pre>

<p>æ¥ç­‰å¾…æ‰€æœ‰çš„åç¨‹ç»“æŸã€‚å…·ä½“çš„ä»£ç å¦‚ä¸‹</p>

<pre>    <span class="com">// a channel to tell `tick()` and `tock()` to stop</span>
    <span class="pln">stopChan</span> <span class="pun">:</span><span class="pun">=</span> <span class="kwd">make</span><span class="pun">(</span><span class="pln">chan</span> <span class="kwd">struct</span><span class="pun">{</span><span class="pun">}</span><span class="pun">)</span>
    <span class="pln">stoppedChan</span> <span class="pun">:</span><span class="pun">=</span> <span class="kwd">make</span><span class="pun">(</span><span class="pln">chan</span> <span class="kwd">struct</span><span class="pun">{</span><span class="pun">}</span><span class="pun">)</span>
    <span class="pln">count</span> <span class="pun">:</span><span class="pun">=</span> <span class="dec">0</span>

    <span class="pln">count</span><span class="pun">+</span><span class="pun">+</span>
    <span class="pln">go</span> <span class="pln">tick</span><span class="pun">(</span><span class="pln">stopChan</span><span class="pun">,</span> <span class="pln">stoppedChan</span><span class="pun">)</span>

    <span class="pln">count</span><span class="pun">+</span><span class="pun">+</span>
    <span class="pln">go</span> <span class="pln">tock</span><span class="pun">(</span><span class="pln">stopChan</span><span class="pun">,</span> <span class="pln">stoppedChan</span><span class="pun">)</span>

    <span class="com">// listen for C-c</span>
    <span class="pln">c</span> <span class="pun">:</span><span class="pun">=</span> <span class="kwd">make</span><span class="pun">(</span><span class="pln">chan</span> <span class="pln">os</span><span class="pun">.</span><span class="typ">Signal</span><span class="pun">,</span> <span class="dec">1</span><span class="pun">)</span>
    <span class="pln">signal</span><span class="pun">.</span><span class="typ">Notify</span><span class="pun">(</span><span class="pln">c</span><span class="pun">,</span> <span class="pln">os</span><span class="pun">.</span><span class="typ">Interrupt</span><span class="pun">)</span>
    <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">c</span>
    <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;main: received C-c - shutting down&#34;</span><span class="pun">)</span>

    <span class="com">// tell the goroutine to stop</span>
    <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;main: telling goroutines to stop&#34;</span><span class="pun">)</span>
    <span class="pln">close</span><span class="pun">(</span><span class="pln">stopChan</span><span class="pun">)</span>
    <span class="com">// and wait for them both to reply back</span>

    <span class="kwd">for</span> <span class="pln">i</span> <span class="pun">:</span><span class="pun">=</span> <span class="dec">0</span><span class="pun">;</span> <span class="pln">i</span> <span class="pun">&lt;</span> <span class="pln">count</span><span class="pun">;</span> <span class="pln">i</span><span class="pun">+</span><span class="pun">+</span><span class="pun">{</span>
        <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">stoppedChan</span>
    <span class="pun">}</span> 
    <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;main: all goroutines have told us they&#39;ve finished&#34;</span><span class="pun">)</span>
</pre>

<p>ç¡®å®šå¾ˆæ˜æ˜¾ï¼Œå­åç¨‹ä»éœ€è¦åƒçˆ¶çº¿ç¨‹ä¸€æ ·ï¼Œåˆ›å»ºstop channelï¼Œéº»çƒ¦ä¸æ­¢ä¸€ç‚¹ç‚¹ã€‚ã€‚</p>

<p>æˆ‘çš„ç¿»è¯‘çœŸæ˜¯ä¸€å¨å±ã€‚ã€‚ã€‚ã€‚</p>

<p>context.Backgroud()æ˜¯ä¸€ä¸ªénilç©ºContextã€‚æ²¡æœ‰å€¼ï¼Œæ²¡æœ‰deadlineã€‚ç»å¸¸ç”¨äºmainå‡½æ•°åˆå§‹åŒ–ï¼Œæµ‹è¯•ï¼Œä½œä¸ºè¯·æ±‚çš„æœ€é«˜ç­‰çº§çš„Contextã€‚</p>

<p>serverä¸­çš„shutdownCtx, cancel := context.WithTimeout(context.Background(), 5*time.Second)çš„ç¬¬ä¸€ä¸ªè¿”å›å€¼å°±æ˜¯æ–°çš„å¸¦æ—¶é—´æˆªæ­¢æ§åˆ¶çš„contextã€‚ç¬¬äºŒä¸ªè¿”å›å€¼æ˜¯æ‰§è¡Œæ—¶é—´åˆ°è¾¾çš„æ—¶ï¼Œæ‰§è¡Œçš„å‡½æ•°ã€‚ä¾‹å¦‚è¿™æ ·ï¼š</p>

<pre>	<span class="pln">shutdownCtx</span><span class="pun">,</span> <span class="pln">cancel</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">context</span><span class="pun">.</span><span class="typ">WithTimeout</span><span class="pun">(</span><span class="pln">context</span><span class="pun">.</span><span class="typ">Background</span><span class="pun">(</span><span class="pun">)</span><span class="pun">,</span> <span class="dec">5</span><span class="pun">*</span><span class="pln">time</span><span class="pun">.</span><span class="typ">Second</span><span class="pun">)</span>
	<span class="pln">cancel</span> <span class="pun">=</span> <span class="kwd">func</span><span class="pun">(</span><span class="pun">)</span> <span class="pun">{</span>
		<span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;æ–©æ–©æ–©&#34;</span><span class="pun">)</span>
	<span class="pun">}</span>
</pre>

<p>ä¸»åŠ¨åˆ›å»ºæœåŠ¡å™¨çš„è¿‡ç¨‹</p>

<pre>	<span class="pln">mux</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">NewServeMux</span><span class="pun">(</span><span class="pun">)</span>
	<span class="pln">mux</span><span class="pun">.</span><span class="typ">Handle</span><span class="pun">(</span><span class="str">&#34;/&#34;</span><span class="pun">,</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">HandlerFunc</span><span class="pun">(</span><span class="kwd">func</span><span class="pun">(</span><span class="pln">w</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">ResponseWriter</span><span class="pun">,</span> <span class="pln">r</span> <span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">)</span> <span class="pun">{</span>
		<span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;server: received request&#34;</span><span class="pun">)</span>
		<span class="pln">time</span><span class="pun">.</span><span class="typ">Sleep</span><span class="pun">(</span><span class="dec">3</span> <span class="pun">*</span> <span class="pln">time</span><span class="pun">.</span><span class="typ">Second</span><span class="pun">)</span>
		<span class="pln">io</span><span class="pun">.</span><span class="typ">WriteString</span><span class="pun">(</span><span class="pln">w</span><span class="pun">,</span> <span class="str">&#34;Finished!\n&#34;</span><span class="pun">)</span>
		<span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="str">&#34;server: request finished&#34;</span><span class="pun">)</span>
	<span class="pun">}</span><span class="pun">)</span><span class="pun">)</span>

	<span class="pln">srv</span> <span class="pun">:</span><span class="pun">=</span> <span class="pun">&amp;</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Server</span><span class="pun">{</span><span class="typ">Addr</span><span class="pun">:</span> <span class="str">&#34;:8080&#34;</span><span class="pun">,</span> <span class="typ">Handler</span><span class="pun">:</span> <span class="pln">mux</span><span class="pun">}</span>

    <span class="pln">go</span> <span class="kwd">func</span><span class="pun">(</span><span class="pun">)</span> <span class="pun">{</span>
		<span class="com">// service connections</span>
		<span class="kwd">if</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">srv</span><span class="pun">.</span><span class="typ">ListenAndServe</span><span class="pun">(</span><span class="pun">)</span><span class="pun">;</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
			<span class="pln">fmt</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;Listen : %s\n&#34;</span><span class="pun">,</span> <span class="pln">err</span><span class="pun">)</span>
		<span class="pun">}</span>
	<span class="pun">}</span><span class="pun">(</span><span class="pun">)</span>

</pre>

<p>æœåŠ¡å™¨å…³é—­</p>

<pre>	<span class="pln">srv</span><span class="pun">.</span><span class="typ">Shutdown</span><span class="pun">(</span><span class="pln">shutdownCtx</span><span class="pun">)</span>
</pre>

<p>æ³¨æ„ï¼Œæ­¤Shutdownæ–¹æ³•ï¼Œåªæœ‰goçš„ç‰ˆæœ¬å¤§äºç­‰äº1.8çš„æ‰æœ‰ã€‚</p>

                </div>
                <a class="ui large button" href="/2017/06/28/%28%e7%bf%bb%e8%af%91%29%e5%8f%96%e6%b6%88%e5%a4%9a%e4%b8%aaGoroutines">Read More</a>
                <h4 class="ui horizontal header divider">
                    <a href="#">è¿™æ˜¯åˆ†ç•Œçº¿å“¦~~</a>
                </h4>
                
                <h3 class="ui header">lec01å­¦ä¹ ç¬”è®°</h3>
                <div class="postContent">
                    <p>åˆ†ä¸º: å­˜å‚¨ï¼Œé€šè®¯å’Œè®¡ç®—
å…³é”®ç‚¹ï¼šå®ç°ï¼Œæ€§èƒ½ï¼Œå®¹é”™å’Œä¸€è‡´æ€§ã€‚ä¸€è‡´æ€§å’Œæ€§èƒ½ä¸å¯å…¼å¾—
split-brainçš„æ„æ€æ˜¯A true split brain means multiple systems are online and have accessed an exclusive resource simultaneously</p>

<p>MapReduceï¼š å®šä¹‰Mapå’ŒReduceå‡½æ•°ï¼Œè¾“å…¥æ•°ç»„å½¢å¼çš„æ•°æ®ã€‚</p>

<p>æ‰©å±•ï¼šä¸äº’ç›¸ç­‰å¾…ï¼Œä¸å…±äº«æ•°æ®ã€‚å¯å¹¶å‘æ‰§è¡Œã€‚å¯å•çº¯çš„é…ç½®æ›´å¤šçš„è®¡ç®—æœºæ¥è·å¾—æ›´å¤šçš„ååé‡
æ€§èƒ½ï¼šHard to build a network than can run 1000x faster than a single computer.So they cared about minimizing movement of data over the network.ä¸€èˆ¬ä¼šè¢«ç½‘ç»œé™åˆ¶ã€‚å°½é‡å‡å°‘æ•°æ®åœ¨ç½‘ç»œä¸Šä¼ è¾“ã€‚
å®¹é”™ï¼šå½“Mapå’ŒReduceå¤±è´¥æ—¶ï¼Œé‡æ–°è¿è¡Œã€‚ä»–ä»¬ä»…ä»…æ˜¯å‡½æ•°è€Œå·²â€“ä»–ä»¬ä¸ä¿®æ”¹è¾“å…¥çš„å†…å®¹ï¼Œä¸ç”¨ä¿å­˜çŠ¶æ€ï¼Œä¸å…±äº«å†…å­˜ï¼Œæ²¡æœ‰Map-Mapå’ŒReduce-Reduceçš„äº¤äº’ã€‚æ‰€ä»¥é‡æ–°æ‰§è¡Œä¼šå¾—åˆ°ç›¸åŒçš„è¾“å‡ºã€‚çº¯å‡½æ•°ï¼ˆpure functionï¼‰çš„è¿™ä¸ªéœ€æ±‚æ˜¯ç›¸å¯¹äºå…¶ä»–å¹¶è¡Œç¼–ç¨‹æ–¹æ¡ˆçš„ä¸»è¦é™åˆ¶ï¼Œä¹Ÿæ˜¯MRç®€å•çš„åŸå› ã€‚</p>

<p>MapReduceç”±Materå’ŒWorkerç»„æˆã€‚Masterç»™workersåˆ†é…å·¥ä½œï¼Œå†³å®šworkerè¿è¡Œmapæ–¹æ³•è¿˜æ˜¯reduceæ–¹æ³•ã€‚å½“workeræ‰§è¡Œé”™è¯¯ï¼Œç›´æ¥é‡å¯workerå°±å¥½ã€‚
masterçš„è°ƒåº¦ç¨‹åº</p>

<pre><span class="kwd">func</span> <span class="pun">(</span><span class="pln">mr</span> <span class="pun">*</span><span class="typ">Master</span><span class="pun">)</span> <span class="pln">schedule</span><span class="pun">(</span><span class="pln">phase</span> <span class="pln">jobPhase</span><span class="pun">)</span> <span class="pun">{</span>
	<span class="kwd">var</span> <span class="pln">ntasks</span> <span class="kwd">int</span>
	<span class="kwd">var</span> <span class="pln">nios</span> <span class="kwd">int</span> <span class="com">// number of inputs (for reduce) or outputs (for map)</span>
	<span class="kwd">switch</span> <span class="pln">phase</span> <span class="pun">{</span>
	<span class="kwd">case</span> <span class="pln">mapPhase</span><span class="pun">:</span>
		<span class="pln">ntasks</span> <span class="pun">=</span> <span class="pln">len</span><span class="pun">(</span><span class="pln">mr</span><span class="pun">.</span><span class="pln">files</span><span class="pun">)</span>
		<span class="pln">nios</span> <span class="pun">=</span> <span class="pln">mr</span><span class="pun">.</span><span class="pln">nReduce</span>
	<span class="kwd">case</span> <span class="pln">reducePhase</span><span class="pun">:</span>
		<span class="pln">ntasks</span> <span class="pun">=</span> <span class="pln">mr</span><span class="pun">.</span><span class="pln">nReduce</span>
		<span class="pln">nios</span> <span class="pun">=</span> <span class="pln">len</span><span class="pun">(</span><span class="pln">mr</span><span class="pun">.</span><span class="pln">files</span><span class="pun">)</span>
	<span class="pun">}</span>
	<span class="pln">fmt</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;Schedule: %v %v tasks (%d I/Os)\n&#34;</span><span class="pun">,</span> <span class="pln">ntasks</span><span class="pun">,</span> <span class="pln">phase</span><span class="pun">,</span> <span class="pln">nios</span><span class="pun">)</span>
	<span class="kwd">var</span> <span class="pln">wg</span> <span class="pln">sync</span><span class="pun">.</span><span class="typ">WaitGroup</span>
	<span class="kwd">for</span> <span class="pln">i</span> <span class="pun">:</span><span class="pun">=</span> <span class="dec">0</span><span class="pun">;</span> <span class="pln">i</span> <span class="pun">&lt;</span> <span class="pln">ntasks</span><span class="pun">;</span> <span class="pun">{</span>
		<span class="pln">wg</span><span class="pun">.</span><span class="typ">Add</span><span class="pun">(</span><span class="dec">1</span><span class="pun">)</span>
		<span class="pln">go</span> <span class="kwd">func</span><span class="pun">(</span><span class="pln">i</span><span class="pun">,</span> <span class="pln">nios</span> <span class="kwd">int</span><span class="pun">,</span> <span class="pln">phase</span> <span class="pln">jobPhase</span><span class="pun">)</span> <span class="pun">{</span>
			<span class="pln">defer</span> <span class="pln">wg</span><span class="pun">.</span><span class="typ">Done</span><span class="pun">(</span><span class="pun">)</span>
			<span class="pln">workrName</span> <span class="pun">:</span><span class="pun">=</span> <span class="pun">&lt;</span><span class="pun">-</span><span class="pln">mr</span><span class="pun">.</span><span class="pln">registerChannel</span>
			<span class="kwd">for</span> <span class="kwd">true</span> <span class="pun">{</span>
				<span class="pln">ok</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">call</span><span class="pun">(</span><span class="pln">workrName</span><span class="pun">,</span> <span class="str">&#34;Worker.DoTask&#34;</span><span class="pun">,</span> <span class="pun">&amp;</span><span class="typ">DoTaskArgs</span><span class="pun">{</span>
					<span class="typ">JobName</span><span class="pun">:</span>       <span class="pln">mr</span><span class="pun">.</span><span class="pln">jobName</span><span class="pun">,</span>
					<span class="typ">File</span><span class="pun">:</span>          <span class="pln">mr</span><span class="pun">.</span><span class="pln">files</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pun">,</span>
					<span class="typ">Phase</span><span class="pun">:</span>         <span class="pln">phase</span><span class="pun">,</span>
					<span class="typ">TaskNumber</span><span class="pun">:</span>    <span class="pln">i</span><span class="pun">,</span>
					<span class="typ">NumOtherPhase</span><span class="pun">:</span> <span class="pln">nios</span><span class="pun">,</span>
				<span class="pun">}</span><span class="pun">,</span> <span class="kwd">new</span><span class="pun">(</span><span class="kwd">struct</span><span class="pun">{</span><span class="pun">}</span><span class="pun">)</span><span class="pun">)</span>
				<span class="kwd">if</span> <span class="pln">ok</span> <span class="pun">{</span>
					<span class="pln">go</span> <span class="kwd">func</span><span class="pun">(</span><span class="pun">)</span> <span class="pun">{</span>
						<span class="pln">mr</span><span class="pun">.</span><span class="pln">registerChannel</span> <span class="pun">&lt;</span><span class="pun">-</span> <span class="pln">workrName</span>
					<span class="pun">}</span><span class="pun">(</span><span class="pun">)</span>
					<span class="kwd">return</span>
				<span class="pun">}</span>
			<span class="pun">}</span>

		<span class="pun">}</span><span class="pun">(</span><span class="pln">i</span><span class="pun">,</span> <span class="pln">nios</span><span class="pun">,</span> <span class="pln">phase</span><span class="pun">)</span>
	<span class="pun">}</span>
	<span class="pln">wg</span><span class="pun">.</span><span class="typ">Wait</span><span class="pun">(</span><span class="pun">)</span>
	<span class="pln">fmt</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;Schedule: %v phase done\n&#34;</span><span class="pun">,</span> <span class="pln">phase</span><span class="pun">)</span>
<span class="pun">}</span>
</pre>

<p>mapæ–¹æ³•è¯»å…¥inputæ•°æ®ï¼Œä½¿ç”¨mapFå°†æ•°æ®å¤„ç†ä¹‹åï¼Œå°†å¤„ç†åçš„æ•°æ®å­˜åœ¨æŒ‡å®šçš„ä¸­é—´æ–‡ä»¶ä¸­ï¼Œä¸­é—´æ–‡ä»¶çš„æ–‡ä»¶åå†³å®šæ­¤æ–‡ä»¶å°†ç”±å“ªä¸ªreduceæ‰§è¡Œã€‚</p>

<pre><span class="kwd">func</span> <span class="pln">doMap</span><span class="pun">(</span>
	<span class="pln">jobName</span> <span class="pln">string</span><span class="pun">,</span> <span class="com">// the name of the MapReduce job</span>
	<span class="pln">mapTaskNumber</span> <span class="kwd">int</span><span class="pun">,</span> <span class="com">// which map task this is</span>
	<span class="pln">inFile</span> <span class="pln">string</span><span class="pun">,</span>
	<span class="pln">nReduce</span> <span class="kwd">int</span><span class="pun">,</span> <span class="com">// the number of reduce task that will be run (&#34;R&#34; in the paper)</span>
	<span class="pln">mapF</span> <span class="kwd">func</span><span class="pun">(</span><span class="pln">file</span> <span class="pln">string</span><span class="pun">,</span> <span class="pln">contents</span> <span class="pln">string</span><span class="pun">)</span> <span class="pun">[</span><span class="pun">]</span><span class="typ">KeyValue</span><span class="pun">,</span>
<span class="pun">)</span> <span class="pun">{</span>
	<span class="pln">content</span><span class="pun">,</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">ioutil</span><span class="pun">.</span><span class="typ">ReadFile</span><span class="pun">(</span><span class="pln">inFile</span><span class="pun">)</span>
	<span class="kwd">if</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
		<span class="pln">log</span><span class="pun">.</span><span class="typ">Fatal</span><span class="pun">(</span><span class="str">&#34;read input file content &#34;</span><span class="pun">,</span> <span class="pln">err</span><span class="pun">)</span>
	<span class="pun">}</span>
	<span class="pln">kvs</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">mapF</span><span class="pun">(</span><span class="pln">inFile</span><span class="pun">,</span> <span class="pln">string</span><span class="pun">(</span><span class="pln">content</span><span class="pun">)</span><span class="pun">)</span>
	<span class="pln">files</span> <span class="pun">:</span><span class="pun">=</span> <span class="pun">[</span><span class="pun">]</span><span class="pun">*</span><span class="pln">os</span><span class="pun">.</span><span class="typ">File</span><span class="pun">{</span><span class="pun">}</span>
	<span class="kwd">for</span> <span class="pln">i</span> <span class="pun">:</span><span class="pun">=</span> <span class="dec">0</span><span class="pun">;</span> <span class="pln">i</span> <span class="pun">&lt;</span> <span class="pln">nReduce</span><span class="pun">;</span> <span class="pln">i</span><span class="pun">+</span><span class="pun">+</span> <span class="pun">{</span>
		<span class="pln">fileName</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">reduceName</span><span class="pun">(</span><span class="pln">jobName</span><span class="pun">,</span> <span class="pln">mapTaskNumber</span><span class="pun">,</span> <span class="pln">i</span><span class="pun">)</span>
		<span class="pln">file</span><span class="pun">,</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">os</span><span class="pun">.</span><span class="typ">Create</span><span class="pun">(</span><span class="pln">fileName</span><span class="pun">)</span>
		<span class="kwd">if</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
			<span class="pln">log</span><span class="pun">.</span><span class="typ">Fatal</span><span class="pun">(</span><span class="str">&#34;Create File&#34;</span><span class="pun">,</span> <span class="pln">err</span><span class="pun">)</span>
		<span class="pun">}</span>
		<span class="pln">defer</span> <span class="pln">file</span><span class="pun">.</span><span class="typ">Close</span><span class="pun">(</span><span class="pun">)</span>
		<span class="pln">files</span> <span class="pun">=</span> <span class="kwd">append</span><span class="pun">(</span><span class="pln">files</span><span class="pun">,</span> <span class="pln">file</span><span class="pun">)</span>
	<span class="pun">}</span>
	<span class="kwd">for</span> <span class="pln">_</span><span class="pun">,</span> <span class="pln">kv</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">range</span> <span class="pln">kvs</span> <span class="pun">{</span>
		<span class="pln">e</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">json</span><span class="pun">.</span><span class="typ">NewEncoder</span><span class="pun">(</span><span class="pln">files</span><span class="pun">[</span><span class="kwd">int</span><span class="pun">(</span><span class="pln">ihash</span><span class="pun">(</span><span class="pln">kv</span><span class="pun">.</span><span class="typ">Key</span><span class="pun">)</span><span class="pun">)</span><span class="pun">%</span><span class="pln">nReduce</span><span class="pun">]</span><span class="pun">)</span>
		<span class="pln">e</span><span class="pun">.</span><span class="typ">Encode</span><span class="pun">(</span><span class="pun">&amp;</span><span class="pln">kv</span><span class="pun">)</span>
	<span class="pun">}</span>
<span class="pun">}</span>
</pre>

<p>reduceè¯»å–æŒ‡å®šçš„ä¸­é—´æ–‡ä»¶ï¼Œä½¿ç”¨reduceFå¤„ç†åï¼Œè¾“å‡ºç»“æœã€‚</p>

<pre><span class="kwd">func</span> <span class="pln">doReduce</span><span class="pun">(</span>
	<span class="pln">jobName</span> <span class="pln">string</span><span class="pun">,</span> <span class="com">// the name of the whole MapReduce job</span>
	<span class="pln">reduceTaskNumber</span> <span class="kwd">int</span><span class="pun">,</span> <span class="com">// which reduce task this is</span>
	<span class="pln">nMap</span> <span class="kwd">int</span><span class="pun">,</span> <span class="com">// the number of map tasks that were run (&#34;M&#34; in the paper)</span>
	<span class="pln">reduceF</span> <span class="kwd">func</span><span class="pun">(</span><span class="pln">key</span> <span class="pln">string</span><span class="pun">,</span> <span class="pln">values</span> <span class="pun">[</span><span class="pun">]</span><span class="pln">string</span><span class="pun">)</span> <span class="pln">string</span><span class="pun">,</span>
<span class="pun">)</span> <span class="pun">{</span>
	<span class="pln">kvMap</span> <span class="pun">:</span><span class="pun">=</span> <span class="kwd">make</span><span class="pun">(</span><span class="kwd">map</span><span class="pun">[</span><span class="pln">string</span><span class="pun">]</span><span class="pun">[</span><span class="pun">]</span><span class="pln">string</span><span class="pun">)</span>

	<span class="com">// è¯»å–åŒä¸€ä¸ª reduce task ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼Œä¿å­˜è‡³å“ˆå¸Œè¡¨</span>
	<span class="kwd">for</span> <span class="pln">i</span> <span class="pun">:</span><span class="pun">=</span> <span class="dec">0</span><span class="pun">;</span> <span class="pln">i</span> <span class="pun">&lt;</span> <span class="pln">nMap</span><span class="pun">;</span> <span class="pln">i</span><span class="pun">+</span><span class="pun">+</span> <span class="pun">{</span>
		<span class="pln">filename</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">reduceName</span><span class="pun">(</span><span class="pln">jobName</span><span class="pun">,</span> <span class="pln">i</span><span class="pun">,</span> <span class="pln">reduceTaskNumber</span><span class="pun">)</span>
		<span class="pln">f</span><span class="pun">,</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">os</span><span class="pun">.</span><span class="typ">Open</span><span class="pun">(</span><span class="pln">filename</span><span class="pun">)</span>
		<span class="kwd">if</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
			<span class="pln">log</span><span class="pun">.</span><span class="typ">Fatal</span><span class="pun">(</span><span class="str">&#34;Open File Err: &#34;</span><span class="pun">,</span> <span class="pln">filename</span><span class="pun">)</span>
		<span class="pun">}</span>
		<span class="pln">defer</span> <span class="pln">f</span><span class="pun">.</span><span class="typ">Close</span><span class="pun">(</span><span class="pun">)</span>
		<span class="pln">decoder</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">json</span><span class="pun">.</span><span class="typ">NewDecoder</span><span class="pun">(</span><span class="pln">f</span><span class="pun">)</span>
		<span class="kwd">var</span> <span class="pln">kv</span> <span class="typ">KeyValue</span>
		<span class="kwd">for</span> <span class="pln">decoder</span><span class="pun">.</span><span class="typ">More</span><span class="pun">(</span><span class="pun">)</span> <span class="pun">{</span>
			<span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">decoder</span><span class="pun">.</span><span class="typ">Decode</span><span class="pun">(</span><span class="pun">&amp;</span><span class="pln">kv</span><span class="pun">)</span>
			<span class="kwd">if</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
				<span class="pln">log</span><span class="pun">.</span><span class="typ">Fatal</span><span class="pun">(</span><span class="str">&#34;Json decode failed, &#34;</span><span class="pun">,</span> <span class="pln">err</span><span class="pun">)</span>
			<span class="pun">}</span>
			<span class="pln">kvMap</span><span class="pun">[</span><span class="pln">kv</span><span class="pun">.</span><span class="typ">Key</span><span class="pun">]</span> <span class="pun">=</span> <span class="kwd">append</span><span class="pun">(</span><span class="pln">kvMap</span><span class="pun">[</span><span class="pln">kv</span><span class="pun">.</span><span class="typ">Key</span><span class="pun">]</span><span class="pun">,</span> <span class="pln">kv</span><span class="pun">.</span><span class="typ">Value</span><span class="pun">)</span>
		<span class="pun">}</span>
	<span class="pun">}</span>

	<span class="com">// å¯¹= nil {</span>
				<span class="pln">log</span><span class="pun">.</span><span class="typ">Fatal</span><span class="pun">(</span><span class="str">&#34;Json decode failed, &#34;</span><span class="pun">,</span> <span class="pln">err</span><span class="pun">)</span>
			<span class="pun">}</span>
			<span class="pln">kvMap</span><span class="pun">[</span><span class="pln">kv</span><span class="pun">.</span><span class="typ">Key</span><span class="pun">]</span> <span class="pun">=</span> <span class="kwd">append</span><span class="pun">(</span><span class="pln">kvMap</span><span class="pun">[</span><span class="pln">kv</span><span class="pun">.</span><span class="typ">Key</span><span class="pun">]</span><span class="pun">,</span> <span class="pln">kv</span><span class="pun">.</span><span class="typ">Value</span><span class="pun">)</span>
		<span class="pun">}</span>
	<span class="pun">}</span>

	<span class="com">// å¯¹å“ˆå¸Œè¡¨æ‰€æœ‰ key è¿›è¡Œå‡åºæ’åº</span>
	<span class="pln">keys</span> <span class="pun">:</span><span class="pun">=</span> <span class="pun">[</span><span class="pun">]</span><span class="pln">string</span><span class="pun">{</span><span class="pun">}</span>
	<span class="kwd">for</span> <span class="pln">k</span><span class="pun">,</span> <span class="pln">_</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">range</span> <span class="pln">kvMap</span> <span class="pun">{</span>
		<span class="pln">keys</span> <span class="pun">=</span> <span class="kwd">append</span><span class="pun">(</span><span class="pln">keys</span><span class="pun">,</span> <span class="pln">k</span><span class="pun">)</span>
	<span class="pun">}</span>
	<span class="pln">sort</span><span class="pun">.</span><span class="typ">Strings</span><span class="pun">(</span><span class="pln">keys</span><span class="pun">)</span>
	<span class="pln">mergeFile</span><span class="pun">,</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">os</span><span class="pun">.</span><span class="typ">Create</span><span class="pun">(</span><span class="pln">mergeName</span><span class="pun">(</span><span class="pln">jobName</span><span class="pun">,</span> <span class="pln">reduceTaskNumber</span><span class="pun">)</span><span class="pun">)</span>
	<span class="kwd">if</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
		<span class="pln">log</span><span class="pun">.</span><span class="typ">Fatal</span><span class="pun">(</span><span class="str">&#34;Create Merge File Err: &#34;</span><span class="pun">,</span> <span class="pln">err</span><span class="pun">)</span>
	<span class="pun">}</span>
	<span class="pln">defer</span> <span class="pln">mergeFile</span><span class="pun">.</span><span class="typ">Close</span><span class="pun">(</span><span class="pun">)</span>
	<span class="pln">encoder</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">json</span><span class="pun">.</span><span class="typ">NewEncoder</span><span class="pun">(</span><span class="pln">mergeFile</span><span class="pun">)</span>
	<span class="kwd">for</span> <span class="pln">_</span><span class="pun">,</span> <span class="pln">k</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">range</span> <span class="pln">keys</span> <span class="pun">{</span>
		<span class="pln">encoder</span><span class="pun">.</span><span class="typ">Encode</span><span class="pun">(</span><span class="typ">KeyValue</span><span class="pun">{</span><span class="pln">k</span><span class="pun">,</span> <span class="pln">reduceF</span><span class="pun">(</span><span class="pln">k</span><span class="pun">,</span> <span class="pln">kvMap</span><span class="pun">[</span><span class="pln">k</span><span class="pun">]</span><span class="pun">)</span><span class="pun">}</span><span class="pun">)</span>
	<span class="pun">}</span>
<span class="pun">}</span>
</pre>

<p>(è¯¾ç¨‹),<a href="å®éªŒçš„ä»£ç ">https://github.com/qwendy/Distributed-Systems/tree/master/Lec01_Introduction</a>[<a href="https://github.com/qwendy/Distributed-Systems/tree/master/6.824/src/mapreduce">https://github.com/qwendy/Distributed-Systems/tree/master/6.824/src/mapreduce</a>]</p>

                </div>
                <a class="ui large button" href="/2017/06/28/lec01%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0">Read More</a>
                <h4 class="ui horizontal header divider">
                    <a href="#">è¿™æ˜¯åˆ†ç•Œçº¿å“¦~~</a>
                </h4>
                
                <h3 class="ui header">ä½¿ç”¨ç½‘é¡µæ‰“å¼€æœ¬åœ°ç¨‹åº</h3>
                <div class="postContent">
                    <p>æµè§ˆå™¨ä¸­ä½¿ç”¨window.open()æ‰“å¼€URLã€‚å½“URLä¸ºç‰¹å®šçš„å‰ç¼€çš„æ—¶å€™ï¼ˆURI Schemeï¼‰ï¼Œå°±ä¼šè°ƒç”¨æ³¨å†Œè¡¨ä¸­å¯¹åº”çš„æŒ‡ä»¤ã€‚</p>

<h2>å†™å…¥æ³¨å†Œè¡¨</h2>

<p>å‚è€ƒ <a href="https://msdn.microsoft.com/en-us/library/aa767914(VS.85).aspx">https://msdn.microsoft.com/en-us/library/aa767914(VS.85).aspx</a>
å…¶ä¸­çš„å…³é”®æ˜¯åœ¨æ³¨å†Œè¡¨ä¸­å†™å…¥å¦‚ä¸‹çš„æ³¨å†Œè¡¨é¡¹</p>

<pre><code>HKEY_CLASSES_ROOT
   alert
      (Default) = &#34;URL:Alert Protocol&#34;
      URL Protocol = &#34;&#34;
      DefaultIcon
         (Default) = &#34;alert.exe,1&#34;
      shell
         open
            command
               (Default) = &#34;C:\Program Files\Alert\alert.exe&#34; &#34;%1
</code></pre>

<p>ä½¿ç”¨goæ“ä½œæ³¨å†Œè¡¨.pathä¸ºç¨‹åºçš„åœ°å€ã€‚uriä¸ºè°ƒç”¨ç¨‹åºçš„URI Schemeã€‚
ä½¿ç”¨jsè°ƒç”¨window.open(â€œuri://â€œ)å°±å¯ä»¥æ‰“å¼€ç¨‹åºã€‚</p>

<pre><span class="kwd">func</span> <span class="pln">regKey</span><span class="pun">(</span><span class="pln">path</span> <span class="pln">string</span><span class="pun">,</span><span class="pln">uri</span> <span class="pln">string</span><span class="pun">)</span> <span class="pln">error</span> <span class="pun">{</span>
	<span class="pln">vconsoleKey</span><span class="pun">,</span> <span class="pln">ok</span><span class="pun">,</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">registry</span><span class="pun">.</span><span class="typ">CreateKey</span><span class="pun">(</span><span class="pln">registry</span><span class="pun">.</span><span class="typ">CLASSES_ROOT</span><span class="pun">,</span> <span class="pln">uri</span><span class="pun">,</span> <span class="pln">registry</span><span class="pun">.</span><span class="typ">CREATE_SUB_KEY</span><span class="pun">|</span><span class="pln">registry</span><span class="pun">.</span><span class="typ">SET_VALUE</span><span class="pun">)</span>
	<span class="kwd">if</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
		<span class="pln">logger</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;CreateKey console err :%v\n&#34;</span><span class="pun">,</span> <span class="pln">err</span><span class="pun">)</span>
		<span class="kwd">return</span> <span class="pln">err</span>
	<span class="pun">}</span>
	<span class="kwd">if</span> <span class="pln">ok</span> <span class="pun">{</span>
		<span class="kwd">return</span> <span class="pln">err</span>
	<span class="pun">}</span>
	<span class="pln">defer</span> <span class="pln">vconsoleKey</span><span class="pun">.</span><span class="typ">Close</span><span class="pun">(</span><span class="pun">)</span>
	<span class="pln">vconsoleKey</span><span class="pun">.</span><span class="typ">SetStringValue</span><span class="pun">(</span><span class="str">&#34;URL Protocol&#34;</span><span class="pun">,</span> <span class="str">&#34;&#34;</span><span class="pun">)</span>
	<span class="pln">vconsoleKey</span><span class="pun">.</span><span class="typ">SetStringValue</span><span class="pun">(</span><span class="str">&#34;DefaultIcon&#34;</span><span class="pun">,</span> <span class="pln">path</span><span class="pun">)</span>
	<span class="pln">shellKey</span><span class="pun">,</span> <span class="pln">_</span><span class="pun">,</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">registry</span><span class="pun">.</span><span class="typ">CreateKey</span><span class="pun">(</span><span class="pln">vconsoleKey</span><span class="pun">,</span> <span class="str">`shell`</span><span class="pun">,</span> <span class="pln">registry</span><span class="pun">.</span><span class="typ">CREATE_SUB_KEY</span><span class="pun">)</span>
	<span class="kwd">if</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
		<span class="pln">logger</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;CreateKey shell err :%v\n&#34;</span><span class="pun">,</span> <span class="pln">err</span><span class="pun">)</span>
		<span class="kwd">return</span> <span class="pln">err</span>
	<span class="pun">}</span>
	<span class="pln">openKey</span><span class="pun">,</span> <span class="pln">_</span><span class="pun">,</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">registry</span><span class="pun">.</span><span class="typ">CreateKey</span><span class="pun">(</span><span class="pln">shellKey</span><span class="pun">,</span> <span class="str">`open`</span><span class="pun">,</span> <span class="pln">registry</span><span class="pun">.</span><span class="typ">CREATE_SUB_KEY</span><span class="pun">)</span>
	<span class="kwd">if</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
		<span class="pln">logger</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;CreateKey open err :%v\n&#34;</span><span class="pun">,</span> <span class="pln">err</span><span class="pun">)</span>
		<span class="kwd">return</span> <span class="pln">err</span>
	<span class="pun">}</span>
	<span class="pln">commandKey</span><span class="pun">,</span> <span class="pln">_</span><span class="pun">,</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">registry</span><span class="pun">.</span><span class="typ">CreateKey</span><span class="pun">(</span><span class="pln">openKey</span><span class="pun">,</span> <span class="str">`command`</span><span class="pun">,</span> <span class="pln">registry</span><span class="pun">.</span><span class="typ">CREATE_SUB_KEY</span><span class="pun">|</span><span class="pln">registry</span><span class="pun">.</span><span class="typ">SET_VALUE</span><span class="pun">)</span>
	<span class="kwd">if</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
		<span class="pln">logger</span><span class="pun">.</span><span class="typ">Printf</span><span class="pun">(</span><span class="str">&#34;CreateKey err :%v\n&#34;</span><span class="pun">,</span> <span class="pln">err</span><span class="pun">)</span>
		<span class="kwd">return</span> <span class="pln">err</span>
	<span class="pun">}</span>
	<span class="pln">commandKey</span><span class="pun">.</span><span class="typ">SetStringValue</span><span class="pun">(</span><span class="str">&#34;&#34;</span><span class="pun">,</span> <span class="pln">path</span><span class="pun">)</span>

	<span class="kwd">return</span> <span class="kwd">nil</span>
<span class="pun">}</span>
</pre>

<h2>è·å–ç®¡ç†å‘˜æƒé™</h2>

<p>åœ¨æ³¨å†Œè¡¨ä¸­å†™å…¥æ³¨å†Œè¡¨é¡¹éœ€è¦ç®¡ç†å‘˜æƒé™ã€‚
- go get github.com/akavel/rsrc
- æŠŠnac.manifestæ–‡ä»¶æ‹·è´åˆ°å½“å‰windowsé¡¹ç›®æ ¹ç›®å½•
- rsrc -manifest nac.manifest -o nac.syso
- go build</p>

<p>nac.mainfestçš„å†…å®¹ä¸ºï¼š</p>

<pre><span class="pun">&lt;</span><span class="pun">?</span><span class="pln">xml</span> <span class="pln">version</span><span class="pun">=</span><span class="str">&#34;1.0&#34;</span> <span class="pln">encoding</span><span class="pun">=</span><span class="str">&#34;UTF-8&#34;</span> <span class="pln">standalone</span><span class="pun">=</span><span class="str">&#34;yes&#34;</span><span class="pun">?</span><span class="pun">&gt;</span>
<span class="pun">&lt;</span><span class="pln">assembly</span> <span class="pln">xmlns</span><span class="pun">=</span><span class="str">&#34;urn:schemas-microsoft-com:asm.v1&#34;</span> <span class="pln">manifestVersion</span><span class="pun">=</span><span class="str">&#34;1.0&#34;</span><span class="pun">&gt;</span>
<span class="pun">&lt;</span><span class="pln">trustInfo</span> <span class="pln">xmlns</span><span class="pun">=</span><span class="str">&#34;urn:schemas-microsoft-com:asm.v3&#34;</span><span class="pun">&gt;</span>
<span class="pun">&lt;</span><span class="pln">security</span><span class="pun">&gt;</span>
<span class="pun">&lt;</span><span class="pln">requestedPrivileges</span><span class="pun">&gt;</span>
<span class="pun">&lt;</span><span class="pln">requestedExecutionLevel</span> <span class="pln">level</span><span class="pun">=</span><span class="str">&#34;requireAdministrator&#34;</span><span class="pun">/</span><span class="pun">&gt;</span>
<span class="pun">&lt;</span><span class="pun">/</span><span class="pln">requestedPrivileges</span><span class="pun">&gt;</span>
<span class="pun">&lt;</span><span class="pun">/</span><span class="pln">security</span><span class="pun">&gt;</span>
<span class="pun">&lt;</span><span class="pun">/</span><span class="pln">trustInfo</span><span class="pun">&gt;</span>
<span class="pun">&lt;</span><span class="pun">/</span><span class="pln">assembly</span><span class="pun">&gt;</span>
<span class="str">``</span><span class="str">`leges&gt;
&lt;requestedExecutionLevel level=&#34;requireAdministrator&#34;/&gt;
&lt;/requestedPrivileges&gt;
&lt;/security&gt;
&lt;/trustInfo&gt;
&lt;/assembly&gt;
</span></pre>

                </div>
                <a class="ui large button" href="/2017/06/21/%e4%bd%bf%e7%94%a8%e7%bd%91%e9%a1%b5%e6%89%93%e5%bc%80%e6%9c%ac%e5%9c%b0%e7%a8%8b%e5%ba%8f">Read More</a>
                <h4 class="ui horizontal header divider">
                    <a href="#">è¿™æ˜¯åˆ†ç•Œçº¿å“¦~~</a>
                </h4>
                
                <h3 class="ui header">ï¼ˆç¿»è¯‘ï¼‰BitTorrent-Protocolåè®®è§„èŒƒ</h3>
                <div class="postContent">
                    <p>æœ¬æ–‡ç¿»è¯‘åŸæ–‡ï¼š<a href="http://www.bittorrent.org/beps/bep_0003.html">http://www.bittorrent.org/beps/bep_0003.html</a>
BitTorrentæ˜¯ä¸€ä¸ªåˆ†å‘æ–‡ä»¶çš„åè®®ã€‚å®ƒé€šè¿‡URLè¯†åˆ«å†…å®¹ï¼Œæ—¨åœ¨ä¸ç½‘ç»œæ— ç¼é›†æˆã€‚å®ƒå’Œä¸€èˆ¬çš„HTTPç›¸æ¯”çš„ä¼˜åŠ¿åœ¨äºï¼Œå½“åŒä¸€ä¸ªæ–‡ä»¶çš„å¤šä¸ªä¸‹è½½åŒæ—¶å‘ç”Ÿæ—¶ï¼Œä¸‹è½½è€…ç›¸äº’ä¸Šä¼ ï¼Œä½¿å¾—æ–‡ä»¶æºå¯ä»¥æ”¯æŒéå¸¸å¤§é‡ä¸‹è½½ï¼Œè€Œå…¶è´Ÿè½½å¢åŠ å¾ˆå°ã€‚</p>

<h2>BitTorrentæ–‡ä»¶åˆ†å‘æœ‰è¿™äº›éƒ¨åˆ†ç»„æˆï¼š</h2>

<ul>
<li>ä¸€ä¸ªæ™®é€šçš„webæœåŠ¡å™¨</li>
<li>é™æ€â€œå…ƒä¿¡æ¯ï¼ˆmetainfoï¼‰â€æ–‡ä»¶</li>
<li>BitTorrentè·Ÿè¸ªå™¨ï¼ˆtrackerï¼‰</li>
<li>â€œåŸå§‹â€ä¸‹è½½å™¨</li>
<li>ç”¨æˆ·webæµè§ˆå™¨ç«¯</li>
<li>ç”¨æˆ·ä¸‹è½½å™¨ç«¯</li>
</ul>

<p>ç†æƒ³æƒ…å†µä¸‹å¤šç«¯ç”¨æˆ·ç°åœ¨åŒä¸€ä¸ªæ–‡ä»¶</p>

<h2>è¦å¼€å§‹æœåŠ¡ï¼Œä¸»æœºå°†æ‰§è¡Œä»¥ä¸‹æ­¥éª¤</h2>

<ol>
<li>å¼€å¯ä¸€ä¸ªè·Ÿè¸ªå™¨ï¼ˆtrackerï¼‰</li>
<li>å¼€å¯ä¸€ä¸ªæ™®é€šçš„webæœåŠ¡å™¨ï¼Œä¾‹å¦‚Apache</li>
<li>åœ¨ä»–ä»¬çš„WebæœåŠ¡å™¨ä¸Šï¼Œå°†æ‰©å±•å.torrentä¸mimetypeåº”ç”¨ç¨‹åº/ x-bittorrentç›¸å…³è”ã€‚</li>
<li>ä½¿ç”¨æä¾›çš„å®Œæ•´çš„æ–‡ä»¶å’Œè·Ÿè¸ªå™¨URLï¼Œç”Ÿæˆä¸€ä¸ªå…ƒæ•°æ®ï¼ˆmetainfoï¼‰çš„(.torrent) æ–‡ä»¶</li>
<li>å°†å…ƒä¿¡æ¯(.torrent)æ–‡ä»¶æ”¾åœ¨webæœåŠ¡å™¨ä¸Š</li>
<li>é“¾æ¥æ¥è‡ªå…¶å®ƒç½‘é¡µçš„(.torrent)å…ƒæ•°æ®æ–‡ä»¶</li>
</ol>

<h2>bencoding</h2>

<ul>
<li>åè¿›åˆ¶çš„å­—ç¬¦ä¸²é•¿åº¦ï¼Œåé¢è·Ÿç€å†’å·å’Œå­—ç¬¦ä¸²ã€‚ä¾‹å¦‚4:spamå¯¹åº”äºâ€œspanâ€</li>
<li>æ•´æ•°ç”¨ä¸€ä¸ªâ€™iâ€™æ¥è¡¨ç¤ºï¼Œåè·Ÿä¸€ä¸ªåè¿›åˆ¶çš„æ•°å­—ï¼Œå†åé¢è·Ÿç€ä¸€ä¸ªâ€™eâ€™ã€‚ä¾‹å¦‚ï¼ši3eå¯¹åº”3ï¼Œi-3eä»£è¡¨-3ã€‚æ•´æ•°æ²¡æœ‰å¤§å°é™åˆ¶ï¼Œi-0eæ˜¯æ— æ•ˆçš„ã€‚æ‰€æœ‰å…·æœ‰å‰å¯¼0çš„ç¼–ç ï¼Œä¾‹å¦‚i03eï¼Œéƒ½æ˜¯æ— æ•ˆçš„ï¼Œé™¤äº†i0eï¼Œå…¶æ¯«æ— ç–‘é—®å¯¹åº”0ã€‚</li>
<li>åˆ—è¡¨è¢«ç¼–ç æˆâ€˜lâ€™ï¼Œåé¢æ˜¯ä»–ä»¬çš„å…ƒç´ ï¼ˆä¹Ÿæ˜¯bencodeï¼‰ï¼Œåœ¨æ¥ç€æ˜¯â€˜eâ€™.ä¾‹å¦‚ï¼šl4ï¼šspam4ï¼šeggså¯¹åº”ï¼š[â€˜spamâ€™,â€˜eggsâ€™].</li>
<li>å­—å…¸è¢«ç¼–ç æˆâ€™dâ€™ï¼Œåé¢è·Ÿç€ä¸€ä¸ªäº¤æ›¿çš„å»ºå’Œå¯¹åº”çš„åˆ—è¡¨ï¼Œåè·Ÿä¸€ä¸ªâ€™eâ€™ã€‚ä¾‹å¦‚ï¼Œd3:cow3:moo4:spam4:eggse å¯¹åº”{â€˜cowâ€™: â€˜mooâ€™, â€˜spamâ€™: â€˜eggsâ€™}ï¼Œ d4:spaml1:a1:beeå¯¹åº”{â€˜spamâ€™: [â€˜aâ€™, â€˜bâ€™]}ã€‚é”®å¿…é¡»æ˜¯å­—ç¬¦ä¸²å¹¶æŒ‰æ’åºé¡ºåºæ˜¾ç¤ºï¼ˆæŒ‰åŸå§‹å­—ç¬¦ä¸²æ’åºï¼Œè€Œä¸æ˜¯å­—æ¯æ•°å­—ï¼‰ã€‚</li>
</ul>

<h2>metainfo files(å…ƒä¿¡æ¯æ–‡ä»¶)</h2>

<p>å…ƒä¿¡æ¯æ–‡ä»¶ï¼ˆä¹Ÿè¢«è®¤ä½œ.torrentæ–‡ä»¶ï¼‰ä½¿ç”¨ä»¥ä¸‹é”®ç¼–ç¨‹æˆbencodedå­—å…¸ï¼š
- announceï¼š è·Ÿè¸ªå™¨ï¼ˆtrackerï¼‰çš„URL
- infoï¼š æ˜ å°„åˆ°å­—å…¸ï¼Œå…·æœ‰å¦‚ä¸‹æ‰€è¿°çš„é”®ã€‚</p>

<p>æ‰€æœ‰åœ¨.torrentæ–‡ä»¶ä¸­åŒ…å«çš„å­—ç¬¦ä¸²å¿…é¡»æ˜¯UTF-8ç¼–ç çš„</p>

<h3>ä¿¡æ¯å­—å…¸</h3>

<p>æ˜ å°„UTFç¼–ç çš„å­—ç¬¦ä¸²çš„å…³é”®å­—ï¼Œæ˜¯ç”¨æ¥ä¿å­˜æ–‡ä»¶çš„é»˜è®¤åå­—ã€‚å®ƒä»…ä»…ç”¨æ¥å’¨è¯¢ã€‚
ç‰‡æ®µï¼ˆpieceï¼‰é•¿åº¦å¯¹åº”åˆ°æ–‡ä»¶è¢«åˆ†å‰²æˆçš„æ¯ä¸ªç‰‡æ®µä¸­çš„å­—èŠ‚æ•°ã€‚ä¸ºäº†ä¼ è¾“çš„ç›®çš„ï¼Œæ–‡ä»¶è¢«æ‹†åˆ†æˆå›ºå®šå¤§å°çš„å—ï¼Œå®ƒä»¬å…·æœ‰ç›¸åŒçš„é•¿åº¦ï¼Œé™¤äº†å¯èƒ½è¢«æˆªæ–­çš„æœ€åä¸€ä¸ªä¹‹å¤–ã€‚
ç‰‡ï¼ˆpieceï¼‰é•¿åº¦å‡ ä¹æ€»æ˜¯2çš„å¹‚ï¼Œæœ€å¸¸è§çš„2 18 = 256 Kï¼ˆBitTorrentåœ¨ç‰ˆæœ¬3.2ä¹‹å‰ä½¿ç”¨2 20 = 1 Mä½œä¸ºé»˜è®¤å€¼ï¼‰ã€‚
å®ƒè¢«ç»†åˆ†ä¸ºé•¿åº¦ä¸º20çš„å­—ç¬¦ä¸²ï¼Œæ¯ä¸ªå­—ç¬¦ä¸²æ˜¯ç›¸åº”ç´¢å¼•å¤„çš„ç‰‡æ®µçš„SHA1å“ˆå¸Œã€‚
è¿˜æœ‰ä¸€ä¸ªå¯†é’¥é•¿åº¦æˆ–ä¸€ä¸ªå¯†é’¥æ–‡ä»¶ï¼Œä½†ä¸èƒ½åŒæ—¶å­˜åœ¨æˆ–åŒæ—¶ä¸å­˜åœ¨ã€‚å¦‚æœé•¿åº¦å­˜åœ¨ï¼Œåˆ™ä¸‹è½½è¡¨ç¤ºå•ä¸ªæ–‡ä»¶ï¼Œå¦åˆ™å®ƒè¡¨ç¤ºè¿›å…¥ç›®å½•ç»“æ„çš„ä¸€ç»„æ–‡ä»¶ã€‚
åœ¨å•ä¸ªæ–‡ä»¶çš„æƒ…å†µä¸‹ï¼Œé•¿åº¦æ˜ å°„åˆ°æ–‡ä»¶çš„é•¿åº¦ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚
ä¸ºäº†å…¶ä»–é”®çš„ç›®çš„ï¼Œå¤šæ–‡ä»¶æƒ…å†µè¢«è§†ä¸ºåªæœ‰ä¸€ä¸ªæ–‡ä»¶ï¼Œé€šè¿‡æŒ‰ç…§å®ƒä»¬å‡ºç°åœ¨æ–‡ä»¶åˆ—è¡¨ä¸­çš„é¡ºåºè¿æ¥æ–‡ä»¶ã€‚æ–‡ä»¶åˆ—è¡¨æ˜¯æ–‡ä»¶æ˜ å°„åˆ°çš„å€¼ï¼Œæ˜¯åŒ…å«ä»¥ä¸‹é”®çš„å­—å…¸åˆ—è¡¨ï¼š
- lengthï¼šæ–‡ä»¶çš„é•¿åº¦ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚
- path ä¸å­ç›®å½•åç§°å¯¹åº”çš„UTF-8ç¼–ç å­—ç¬¦ä¸²çš„åˆ—è¡¨ï¼Œæœ€åä¸€ä¸ªæ˜¯å®é™…æ–‡ä»¶åï¼ˆé›¶é•¿åº¦åˆ—è¡¨æ˜¯ä¸€ä¸ªé”™è¯¯å¤§å°å†™ï¼‰ã€‚
åœ¨å•æ–‡ä»¶çš„æƒ…å†µä¸‹ï¼Œåç§°é”®æ˜¯æ–‡ä»¶çš„åç§°ï¼Œåœ¨å¤šæ–‡ä»¶çš„æƒ…å†µä¸‹ï¼Œå®ƒæ˜¯ç›®å½•çš„åç§°ã€‚</p>

<h2>è·Ÿè¸ªå™¨ï¼ˆtrackerï¼‰</h2>

<p>è·Ÿè¸ªå™¨è¯·æ±‚åŒ…å«ä»¥ä¸‹å…³é”®å­—ï¼ˆkeyï¼‰ï¼š
- info_hash
    æ¥è‡ªmetainfoæ–‡ä»¶çš„infoå€¼çš„bencodedå½¢å¼çš„20å­—èŠ‚sha1æ•£åˆ—ã€‚æ³¨æ„ï¼Œè¿™æ˜¯metainfoæ–‡ä»¶çš„å­å­—ç¬¦ä¸²ã€‚ info_hashå¿…é¡»æ˜¯åœ¨.torrentæ–‡ä»¶ä¸­æ‰¾åˆ°çš„ç¼–ç å½¢å¼çš„å“ˆå¸Œï¼Œè€Œä¸ç®¡å®ƒæ˜¯æ— æ•ˆçš„ã€‚è¿™ä¸ªå€¼è‚¯å®šå¿…é¡»è¢«è½¬¬¦ä¸²ã€‚ info_hashå¿…é¡»æ˜¯åœ¨.torrentæ–‡ä»¶ä¸­æ‰¾åˆ°çš„ç¼–ç å½¢å¼çš„å“ˆå¸Œï¼Œè€Œä¸ç®¡å®ƒæ˜¯æ— æ•ˆçš„ã€‚è¿™ä¸ªå€¼è‚¯å®šå¿…é¡»è¢«è½¬ä¹‰ã€‚
- peer_id
    æ˜¯é•¿åº¦ä¸º20çš„å­—ç¬¦ä¸²ï¼Œè¢«ä¸‹è½½ç¨‹åºç”¨ä½œå…¶idã€‚æ¯ä¸ªä¸‹è½½ç¨‹åºåœ¨æ–°ä¸‹è½½å¼€å§‹æ—¶éšæœºç”Ÿæˆè‡ªå·±çš„IDã€‚è¿™ä¸ªå€¼ä¹Ÿå¿…é¡»è¢«è½¬ä¹‰ã€‚
- ip
    æ˜¯æ­¤peeræ‰€åœ¨çš„IPï¼ˆæˆ–dnsåç§°ï¼‰çš„å¯é€‰å‚æ•°ã€‚
- port
    æ˜¯peeræ­£åœ¨ä¾¦å¬çš„ç«¯å£å·ã€‚å¸¸è§çš„åšæ³•æ˜¯ä¸‹è½½å™¨å°è¯•ä¾¦å¬ç«¯å£6881ï¼Œå¦‚æœè¯¥ç«¯å£è¢«å ç”¨ï¼Œåˆ™å°è¯•6882ï¼Œæ¥ç€6883ç­‰ï¼Œåœ¨å°è¯•6889ç«¯å£åè‹¥ä»ä¸æˆåŠŸï¼Œåˆ™æ”¾å¼ƒ.
- upload
    ç›®å‰ä¸ºæ­¢æ‰€æœ‰çš„ä¸Šä¼ é‡ï¼Œç¼–ç æˆåè¿›åˆ¶asciiç ã€‚
- downloaded
    åˆ°ç›®å‰ä¸ºæ­¢å·²ä¸‹è½½çš„æ€»é‡ï¼Œç¼–ç æˆåè¿›åˆ¶asciiç ã€‚
- left
    peerçš„å‰©ä½™ä¸‹è½½é‡ï¼Œä»¥åè¿›åˆ¶asciiç¼–ç ã€‚è¯·æ³¨æ„ï¼Œè¿™ä¸èƒ½ä»å·²ä¸‹è½½çš„é‡å’Œæ–‡ä»¶é•¿åº¦è®¡ç®—ï¼Œå› ä¸ºå®ƒå¯èƒ½åªæ˜¯ä¸€ä¸ªæ‘˜è¦ï¼Œå¹¶ä¸”æœ‰å¯èƒ½æ˜¯ï¼Œéƒ¨åˆ†å·²ä¸‹è½½çš„æ•°æ®çš„å®Œæ•´æ€§æ£€æŸ¥å¤±è´¥ï¼Œå¿…é¡»é‡æ–°ä¸‹è½½ã€‚
- event
    è¿™æ˜¯ä¸€ä¸ªå¯¹åº”startedï¼Œcompletedæˆ–stopped çš„å¯é€‰é”®ï¼ˆæˆ–emptyï¼Œä»£è¡¨ä¸å­˜åœ¨ï¼‰ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™å®šæ—¶å‘å‡ºå…¬å‘Šã€‚å½“ä¸‹è½½å¼€å§‹æ—¶ï¼Œå‘é€startedçš„é€šçŸ¥ï¼Œå¹¶ä¸”å½“ä¸‹è½½å®Œæˆæ—¶å‘é€completedã€‚å¦‚æœæ–‡ä»¶åœ¨å¯åŠ¨æ—¶å·²å®Œæˆï¼Œåˆ™ä¸ä¼šå‘é€completedã€‚ä¸‹è½½å™¨åœ¨åœæ­¢ä¸‹è½½æ—¶å‘é€stoppedå…¬å‘Šã€‚</p>

<p>è·Ÿè¸ªå™¨ï¼ˆTrackerï¼‰çš„å“åº”æ˜¯ç»è¿‡bencodedç¼–ç çš„å­—å…¸ã€‚å¦‚æœè·Ÿè¸ªå™¨å“åº”å…·æœ‰å…³é”®å€¼çš„å¤±è´¥åŸå› ï¼Œåˆ™å¯¹åº”åˆ°äººç±»å¯è¯»çš„å­—ç¬¦ä¸²ï¼Œè§£é‡Šäº†ä¸ºä»€ä¹ˆæŸ¥è¯¢å¤±è´¥ï¼Œå¹¶ä¸”ä¸éœ€è¦å…³å…¶ä»–é”®å­—ï¼ˆkeysï¼‰ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå¿…é¡»æœ‰ä¸¤ä¸ªå…³é”®å­—ï¼šintervalï¼Œå¯¹åº”ä¸‹è½½å™¨åœ¨å®šæœŸé‡æ–°è¯·æ±‚æ—¶åº”è¯¥ç­‰å¾…å¤šå°‘ç§’ã€‚peersï¼Œå¯¹åº”peersç›¸åº”çš„å­—å…¸åˆ—è¡¨ï¼Œæ¯ä¸€ä¸ªéƒ½åŒ…å«peer idï¼Œipå’Œportï¼Œpeer idæŒ‡çš„æ˜¯peerè‡ªé€‰IDï¼ŒipæŒ‡çš„æ˜¯IPåœ°å€æˆ–è€…dnsåå­—ï¼ŒportæŒ‡çš„æ˜¯ç«¯å£æ•°ã€‚æ³¨æ„ï¼Œå¦‚æœæœ‰äº‹ä»¶å‘ç”Ÿï¼Œæˆ–è€…éœ€è¦æ›´å¤šçš„peerï¼Œä¸‹è½½å™¨å¯ä»¥åœ¨æœªè°ƒåº¦çš„æ—¶é—´é‡æ–°è¯·æ±‚ã€‚
æ›´å¸¸è§çš„æ˜¯è·Ÿè¸ªå™¨è¿”å›peeråˆ—è¡¨çš„å‹ç¼©è¡¨ç¤ºï¼Œå‚è§<a href="http://www.bittorrent.org/beps/bep_0023.html">BEP 23</a>ã€‚
é€šå¸¸ä¹Ÿé€šè¿‡UDPè·Ÿè¸ªå™¨åè®®æ¥é€šå‘Šã€‚</p>

<h2>å¯¹ç­‰åè®®ï¼ˆpeer protocalï¼‰</h2>

<p>BitTorrentçš„å¯¹ç­‰åè®®é€šè¿‡TCPæˆ–uTPè¿›è¡Œæ“ä½œã€‚
peerçš„è¿æ¥æ˜¯å¯¹ç§°çš„ã€‚åœ¨ä¸¤ä¸ªæ–¹å‘ä¸Šå‘é€çš„æ¶ˆæ¯çœ‹èµ·æ¥æ˜¯ç›¸åŒçš„ï¼Œå¹¶ä¸”æ•°æ®å¯ä»¥åœ¨ä»»ä¸€æ–¹å‘ä¸ŠæµåŠ¨ã€‚</p>

<p>å¯¹ç­‰åè®®æŒ‡çš„æ˜¯ï¼Œåœ¨å…ƒä¿¡æ¯æ–‡ä»¶ä¸­æè¿°çš„ç´¢å¼•é›¶çš„æ–‡ä»¶ç‰‡æ®µã€‚å½“peerä¸‹è½½å®Œä¸€ä¸ªå—ï¼ˆpieceï¼‰å¹¶ä¸”è¯¥æ•£åˆ—åŒ¹é…æ—¶ï¼Œå®ƒå‘å…¶ä»–æ‰€æœ‰çš„peerå®£å‘Šå®ƒå…·æœ‰äº†é‚£ä¸ªå—ã€‚
è¿æ¥åœ¨ä»»ä¸€ç«¯éƒ½åŒ…å«ä¸¤ä½çŠ¶æ€ï¼šé˜»å¡ï¼ˆchokedï¼‰æˆ–è€…éé˜»å¡ï¼Œæ„Ÿå…´è¶£ï¼ˆinterestedï¼‰æˆ–è€…ä¸æ„Ÿå…´è¶£ã€‚é˜»å¡è¡¨ç¤ºåœ¨éé˜»å¡å‘ç”Ÿå‰ï¼Œä¸ä¼šæœ‰æ•°æ®å‘é€ã€‚æ–‡æ¡£åé¢å°†è§£é‡Šé˜»å¡çš„æ¨è®ºå’Œé€šç”¨æŠ€æœ¯ã€‚</p>

<p>åªè¦ä¸€æ–¹æ„Ÿå…´è¶£ï¼Œå¦ä¸€æ–¹æ²¡æœ‰é˜»å¡ï¼Œå°±è¿›è¡Œæ•°æ®ä¼ è¾“ã€‚å¿…é¡»éšæ—¶ä¿æŒæœ€æ–°æ„Ÿå…´è¶£çŠ¶æ€ - æ¯å½“ä¸‹è½½è€…å½“å‰æ²¡æœ‰æŸäº›èµ„æºæ—¶ï¼Œå°†ä¼šå‘ä¸€ä¸ªpeerè¯¢é—®æ˜¯å¦å¤„äºéé˜»å¡çŠ¶æ€ï¼Œå³ä½¿è¢«é˜»å¡ã€‚ä»–ä»¬ä¹Ÿå¿…é¡»è¡¨ç¤ºä¸æ„Ÿå…´è¶£ã€‚æ­£ç¡®çš„å®ç°è¿™ä¸ªå¾ˆåˆºæ‰‹ï¼Œä½†æ˜¯è¿™å¯ä»¥ä¸‹è½½è€…çŸ¥é“ï¼Œå¦‚æœä¸é˜»å¡ï¼Œå“ªä¸€ä¸ªpeerå°†ä¼šå¼€å§‹ä¸‹è½½ã€‚</p>

<p>è¿æ¥å¼€å§‹ï¼Œå°±å°†çŠ¶æ€å˜ä¸ºè¢«é˜»å¡å’Œä¸æ„Ÿå…´è¶£ã€‚</p>

<p>å½“æ•°æ®è¢«ä¼ è¾“æ—¶ï¼Œä¸‹è½½å™¨åº”è¯¥å°†å¤šä¸ªå—æ”¾åœ¨é˜Ÿåˆ—ä¸­ä¸€å¹¶è¯·æ±‚ï¼Œä»¥è·å–æ›´å¥½çš„TCPæ€§èƒ½ï¼ˆè¿™å«åšæµæ°´çº¿ï¼‰ã€‚å¦ä¸€æ–¹é¢ï¼Œä¸èƒ½ç«‹å³å†™å…¥TCPç¼“å†²å™¨çš„è¯·æ±‚åº”å½“åœ¨å­˜å‚¨å™¨ä¸­æ’é˜Ÿï¼Œè€Œä¸æ˜¯ä¿ç•™åœ¨åº”ç”¨çº§ç½‘ç»œç¼“å†²å™¨ä¸­ï¼Œå› æ­¤å½“å‘ç”Ÿé˜»å¡æ—¶ï¼Œå®ƒä»¬éƒ½å¯ä»¥è¢«æŠ›å¼ƒã€‚</p>

<p>å¯¹ç­‰çº¿åè®®ç”±æ¡æ‰‹å’ŒåŒ…å«é•¿åº¦å‰ç¼€æ¶ˆæ¯çš„ä¸é—´æ–­æµç»„æˆã€‚æ¡æ‰‹çš„å¼€å¤´æ˜¯å­—ç¬¦19ï¼ˆåè¿›ä½çš„ï¼‰ï¼Œç„¶åæ˜¯å­—ç¬¦ä¸²BitTorrent protocolã€‚å‰å¯¼å­—ç¬¦æ˜¯ä¸€ä¸ªé•¿åº¦å‰ç¼€ï¼Œæ”¾åœ¨é‚£é‡Œï¼Œå¸Œæœ›å…¶ä»–æ–°åè®®ä¹Ÿè¿™æ ·ï¼Œå¯ä»¥å½¼æ­¤åŒºåˆ†ã€‚</p>

<p>åœ¨åè®®ä¸­å‘é€çš„æ‰€æœ‰åé¢å‡ºç°çš„æ•´æ•°è¢«ç¼–ç ä¸ºå››å­—èŠ‚ï¼ˆå¤§ç«¯æ’åºï¼‰ã€‚
åœ¨å›ºå®šçš„æŠ¥å¤´ä¹‹åæœ‰å…«ä¸ªä¿ç•™å­—èŠ‚ï¼Œåœ¨æ‰€æœ‰å½“å‰å®ç°ä¸­å®ƒä»¬éƒ½ä¸ºé›¶ã€‚å¦‚æœæ‚¨å¸Œæœ›ä½¿ç”¨è¿™äº›å­—èŠ‚æ‰©å±•åè®®ï¼Œè¯·ä¸Bram Cohenåè°ƒï¼Œä»¥ç¡®ä¿æ‰€æœ‰æ‰©å±•éƒ½å…¼å®¹ã€‚</p>

<p>æ¥ä¸‹æ¥æ˜¯æ¥è‡ªmetainfoæ–‡ä»¶çš„infoå€¼çš„bencodedå½¢å¼çš„20å­—èŠ‚sha1æ•£åˆ—ã€‚ï¼ˆè¿™ä¸ªå’Œå‘é€ç»™trackerçš„info_hashæ˜¯ä¸€æ ·çš„å€¼ï¼Œåªåœ¨è¿™é‡Œå®ƒæ˜¯åŸå§‹çš„ï¼Œè€Œä¸æ˜¯å¼•ç”¨ï¼‰ã€‚å¦‚æœåŒæ–¹éƒ½ä¸å‘é€ç›¸åŒçš„å€¼ï¼Œå®ƒä»¬å°†æ–­å¼€è¿æ¥ã€‚ä¸€ä¸ªå¯èƒ½å‡ºç°çš„æƒ…å†µæ˜¯å¦‚æœä¸‹è½½è€…æƒ³é€šè¿‡å•ä¸ªç«¯å£è¿›è¡Œå¤šæ¬¡ä¸‹è½½ï¼Œä»–ä»¬ä¼šç­‰å¾…ä¼ å…¥çš„è¿æ¥ï¼Œå¹¶é¦–å…ˆç»™å‡ºä¸€ä¸ªä¸‹è½½å“ˆå¸Œï¼Œå¹¶ä¸”å¦‚æœå®ƒåœ¨å®ƒä»¬çš„åˆ—è¡¨ä¸­ï¼Œåˆ™ç”¨åŒä¸€ä¸ªå“ˆå¸Œè¿›è¡Œå“åº”ã€‚</p>

<p>åœ¨ä¸‹è½½å“ˆå¸Œå€¼ä¹‹åï¼Œ20ä¸ªå­—èŠ‚çš„å¯¹ç­‰ä½“IDåœ¨è·Ÿè¸ªå™¨è¯·æ±‚ä¸­æŠ¥å‘Šå¹¶ä¸”åŒ…å«åœ¨è·Ÿè¸ªå™¨å“åº”ä¸­çš„å¯¹ç­‰ä½“åˆ—è¡¨ä¸­ã€‚å¦‚æœæ¥æ”¶æ–¹çš„å¯¹ç­‰ä½“IDä¸å‘èµ·æ–¹æœŸæœ›çš„ä¸åŒ¹é…ï¼Œåˆ™å®ƒåˆ‡æ–­è¿æ¥ã€‚</p>

<p>è¿™æ˜¯æ¡æ‰‹ï¼Œæ¥ä¸‹æ¥æ˜¯ä¸€ä¸ªäº¤æ›¿çš„é•¿åº¦å‰ç¼€å’Œæ¶ˆæ¯çš„æµã€‚é•¿åº¦ä¸ºé›¶çš„æ¶ˆæ¯æ˜¯ä¿æŒæ´»åŠ¨ï¼Œå¹¶è¢«å¿½ç•¥ã€‚ Keepaliveé€šå¸¸æ¯ä¸¤åˆ†é’Ÿå‘é€ä¸€æ¬¡ï¼Œä½†è¯·æ³¨æ„ï¼Œå½“é¢„æœŸæ•°æ®æ—¶ï¼Œè¶…æ—¶å¯ä»¥æ›´å¿«åœ°å®Œæˆã€‚</p>

                </div>
                <a class="ui large button" href="/2016/12/26/%ef%bc%88%e7%bf%bb%e8%af%91%ef%bc%89BitTorrent-Protocol%e5%8d%8f%e8%ae%ae%e8%a7%84%e8%8c%83">Read More</a>
                <h4 class="ui horizontal header divider">
                    <a href="#">è¿™æ˜¯åˆ†ç•Œçº¿å“¦~~</a>
                </h4>
                
                <div class="ui large buttons">
                    <button class="ui button"  disabled><a href="/">ä¸Šä¸€é¡µ</a></button>
                    <div class="or"></div>
                    <button class="ui button" ><a href="/page/2">ä¸‹ä¸€é¡µ</a></button>
                </div>
            </div>
        </div>


        <div class="ui inverted vertical footer segment">
            <div class="ui container">
                <div class="ui stackable inverted divided equal height stackable grid">
                    <div class="three wide column">
                        <h4 class="ui inverted header">About</h4>
                        <div class="ui inverted link list">
                            <a href="#" class="item">Sitemap</a>
                            <a href="#" class="item">Contact Us</a>
                            <a href="#" class="item">Religious Ceremonies</a>
                            <a href="#" class="item">Gazebo Plans</a>
                        </div>
                    </div>
                    <div class="three wide column">
                        <h4 class="ui inverted header">Services</h4>
                        <div class="ui inverted link list">
                            <a href="#" class="item">Banana Pre-Order</a>
                            <a href="#" class="item">DNA FAQ</a>
                            <a href="#" class="item">How To Access</a>
                            <a href="#" class="item">Favorite X-Men</a>
                        </div>
                    </div>
                    <div class="seven wide column">
                        <h4 class="ui inverted header">Footer Header</h4>
                        <p>Extra space for a call to action inside the footer that could help re-engage users.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>


</body>

</html>