<html>

<head>
    <title>Error handling and Go (ç¿»è¯‘)</title>
</head>

<body>
    <div>Error handling and Go (ç¿»è¯‘)</div>
    <div>2016-12-05 19:32:38</div>
    <div><p>æœ¬ç¯‡æ–‡ç« æ¥è‡ªã€ŠThe Go Blogã€‹ã€‚æ–‡ç« åœ°å€ä¸º<a href="https://blog.golang.org/error-handling-and-go">https://blog.golang.org/error-handling-and-go</a>
ä¸‹é¢æ˜¯åœ¨ä¸‹çš„ç¿»è¯‘ã€‚å› ä¸ºçœ‹è‹±æ–‡çœ‹å®Œå°±å¿˜ï¼Œæ‰€ä»¥ç¿»è¯‘ç¿»è¯‘ï¼ŒèŠä»¥è‡ªæ…°ã€‚</p>

<h2>é”™è¯¯å¤„ç†å’ŒGo</h2>

<p>2011å¹´7æœˆ12æ—¥</p>

<h3>å¼•è¨€</h3>

<p>å¦‚æœä½ å†™è¿‡Goçš„ä»£ç ï¼Œä½ å¯èƒ½å·²ç»é‡åˆ°äº†å†…ç½®çš„errorç±»å‹ã€‚Goçš„ä»£ç ä½¿ç”¨errorè¡¨ç¤ºå¼‚å¸¸çŠ¶æ€ã€‚ä¾‹å¦‚os.Openå‡½æ•°æ‰“å¼€æ–‡ä»¶å¤±è´¥çš„æ—¶å€™ï¼Œè¿”å›ä¸€ä¸ªä¸ä¸ºnilçš„errorå€¼ã€‚</p>

<pre><span class="kwd">func</span> <span class="typ">Open</span><span class="pun">(</span><span class="pln">name</span> <span class="pln">string</span><span class="pun">)</span> <span class="pun">(</span><span class="pln">file</span> <span class="pun">*</span><span class="typ">File</span><span class="pun">,</span> <span class="pln">err</span> <span class="pln">error</span><span class="pun">)</span>
</pre>

<p>ä¸‹é¢çš„ä»£ç ä½¿ç”¨os.Openæ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ã€‚å¦‚æœå‡ºç°ä¸€ä¸ªerror,å®ƒä¼šè°ƒç”¨log.Fatalæ¥æ‰“å°å‡ºé”™è¯¯ç»“æŸã€‚</p>

<pre><span class="pln">f</span><span class="pun">,</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">os</span><span class="pun">.</span><span class="typ">Open</span><span class="pun">(</span><span class="str">&#34;filename.ext&#34;</span><span class="pun">)</span>
<span class="kwd">if</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
    <span class="pln">log</span><span class="pun">.</span><span class="typ">Fatal</span><span class="pun">(</span><span class="pln">err</span><span class="pun">)</span>
<span class="pun">}</span>
<span class="com">// do something with the open *File f</span>
</pre>

<p>åœ¨Goä¸­ï¼Œä½ ä»…éœ€è¦çŸ¥é“è¿™äº›å…³äºerrorç±»å‹çš„çŸ¥è¯†ï¼Œå°±èƒ½åšå¾ˆå¤šäº‹æƒ…äº†ï¼Œä½†æ˜¯åœ¨è¿™ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬å°†ä»”ç»†ç ”ç©¶errorï¼Œå¹¶è®¨è®ºåœ¨Goä¸­çš„ä¸€äº›å¥½çš„é”™è¯¯å¤„ç†çš„å®ä¾‹
<!-- more --></p>

<h3>error ç±»å‹</h3>

<p>errorç±»å‹æ˜¯ä¸€ä¸ªæ¥å£(interface)ç±»å‹ã€‚ä¸€ä¸ªerrorå˜é‡ä»£è¡¨ä»»æ„ä¸€ä¸ªèƒ½å°†è‡ªå·±æç»˜æˆå­—ç¬¦ä¸²çš„å€¼ã€‚
è¿™ä¸ªæ˜¯æ¥å£çš„å®šä¹‰</p>

<pre><span class="kwd">type</span> <span class="pln">error</span> <span class="kwd">interface</span> <span class="pun">{</span>
    <span class="typ">Error</span><span class="pun">(</span><span class="pun">)</span> <span class="pln">string</span>
<span class="pun">}</span>
</pre>

<p>errorç±»å‹å¦‚åŒå…¶ä»–æ‰€æœ‰å†…ç½®ç±»å‹æ˜¯åœ¨universe block(<a href="https://golang.org/ref/spec#Blocks">The universe block encompasses all Go source text.</a>)ä¸­é¢„å£°æ˜ï¼ˆ<a href="https://golang.org/ref/spec#Predeclared_identifiers">predeclare</a>ï¼‰çš„ã€‚
æœ€å¸¸ä½¿ç”¨çš„errorå®ä¾‹æ˜¯erroråŒ…ä¸­æœªå¯¼å‡ºï¼ˆexportï¼‰çš„errorStringç±»å‹ã€‚</p>

<pre><span class="com">// errorString is a trivial implementation of error.</span>
<span class="kwd">type</span> <span class="pln">errorString</span> <span class="kwd">struct</span> <span class="pun">{</span>
    <span class="pln">s</span> <span class="pln">string</span>
<span class="pun">}</span>

<span class="kwd">func</span> <span class="pun">(</span><span class="pln">e</span> <span class="pun">*</span><span class="pln">errorString</span><span class="pun">)</span> <span class="typ">Error</span><span class="pun">(</span><span class="pun">)</span> <span class="pln">string</span> <span class="pun">{</span>
    <span class="kwd">return</span> <span class="pln">e</span><span class="pun">.</span><span class="pln">s</span>
<span class="pun">}</span>
</pre>

<p>ä½ å¯ä»¥ä½¿ç”¨errors.Newå‡½æ•°æ¥æ„å»ºä¸€ä¸ªè¿™æ ·çš„å€¼ã€‚å®ƒæ¥å—ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå°†ä¹‹è½¬æˆerrors.errorStringï¼Œå¹¶è¿”å›errorå€¼</p>

<pre><span class="com">// New returns an error that formats as the given text.</span>
<span class="kwd">func</span> <span class="typ">New</span><span class="pun">(</span><span class="pln">text</span> <span class="pln">string</span><span class="pun">)</span> <span class="pln">error</span> <span class="pun">{</span>
    <span class="kwd">return</span> <span class="pun">&amp;</span><span class="pln">errorString</span><span class="pun">{</span><span class="pln">text</span><span class="pun">}</span>
<span class="pun">}</span>
</pre>

<p>è¿™æ˜¯ä½ å¯èƒ½ä¼šä½¿ç”¨çš„errors.Newçš„æƒ…å†µï¼š</p>

<pre><span class="kwd">func</span> <span class="typ">Sqrt</span><span class="pun">(</span><span class="pln">f</span> <span class="kwd">float64</span><span class="pun">)</span> <span class="pun">(</span><span class="kwd">float64</span><span class="pun">,</span> <span class="pln">error</span><span class="pun">)</span> <span class="pun">{</span>
    <span class="kwd">if</span> <span class="pln">f</span> <span class="pun">&lt;</span> <span class="dec">0</span> <span class="pun">{</span>
        <span class="kwd">return</span> <span class="dec">0</span><span class="pun">,</span> <span class="pln">errors</span><span class="pun">.</span><span class="typ">New</span><span class="pun">(</span><span class="str">&#34;math: square root of negative number&#34;</span><span class="pun">)</span>
    <span class="pun">}</span>
    <span class="com">// implementation</span>
<span class="pun">}</span>
</pre>

<p>ä½¿ç”¨ä¸€ä¸ªè´Ÿæ•°å‚æ•°æ¥è°ƒç”¨Sqrtï¼Œä¼šå¾—åˆ°ä¸€ä¸ªénilçš„errorå€¼ï¼ˆå…·ä½“çš„è¡¨ç¤ºæ˜¯ä¸€ä¸ªerrors.errorStringå€¼ï¼‰ã€‚è°ƒç”¨è€…èƒ½é€šè¿‡<code>error</code>ç±»å‹çš„Erroræ–¹æ³•è·å–é”™è¯¯å­—ç¬¦ä¸²(â€œmath: square root ofâ€¦â€œ)ï¼Œæˆ–è€…å°±ç›´æ¥è¾“å‡ºå®ƒï¼š</p>

<pre><span class="pln">f</span><span class="pun">,</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="typ">Sqrt</span><span class="pun">(</span><span class="pun">-</span><span class="dec">1</span><span class="pun">)</span>
<span class="kwd">if</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
    <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Println</span><span class="pun">(</span><span class="pln">err</span><span class="pun">)</span>
<span class="pun">}</span>
</pre>

<p>fmtåŒ…é€šè¿‡è°ƒç”¨å®ƒçš„Error()æ–¹æ³•æ ¼å¼åŒ–errorç±»å‹çš„å€¼ã€‚
è¿™ä¸ªæ˜¯é”™è¯¯çš„å®ç°æ€»ç»“ä¸Šä¸‹æ–‡çš„æ–¹æ³•ã€‚é”™è¯¯åº”è¯¥ç”±os.Openæ ¼å¼åŒ–è¿”å›ä¸ºâ€open /etc/passwd: permission denied,â€ ,è€Œä¸ä»…ä»…æ˜¯â€permission denied.â€œç”±Sqrtè¿”å›çš„é”™è¯¯ç¼ºå°‘äº†å…³äºæ— æ•ˆå‚æ•°çš„ä¿¡æ¯ã€‚
åœ¨fmtåŒ…ä¸­æœ‰ä¸ªæœ‰ç”¨çš„å‡½æ•°Errorf,ç”¨äºå¢åŠ è¿™ä¸ªä¿¡æ¯ã€‚å®ƒæ ¹æ® <code>Printf</code>è§„åˆ™æ¥æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œå¹¶è¿”å›ä¸€ä¸ªç”±errors.Newåˆ›å»ºçš„errorç±»å‹ã€‚</p>

<pre><span class="kwd">if</span> <span class="pln">f</span> <span class="pun">&lt;</span> <span class="dec">0</span> <span class="pun">{</span>
    <span class="kwd">return</span> <span class="dec">0</span><span class="pun">,</span> <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Errorf</span><span class="pun">(</span><span class="str">&#34;math: square root of negative number %g&#34;</span><span class="pun">,</span> <span class="pln">f</span><span class="pun">)</span>
<span class="pun">}</span>
</pre>

<p>åœ¨è®¸å¤šæƒ…å†µä¸‹fmt.Errorfå·²ç»è¶³å¤Ÿ ï¼Œä½†æ˜¯æ—¢ç„¶erroræ˜¯ä¸€ä¸ªinterfaceï¼Œä½ å¯ä»¥ä½¿ç”¨ä»»æ„çš„æ•°æ®ç»“æ„ä½œä¸ºerrorï¼Œè®©è°ƒç”¨è€…æ¥æ£€æŸ¥é”™è¯¯çš„è¯¦ç»†ä¿¡æ¯ã€‚
ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å‡æƒ³çš„è°ƒç”¨ä¹Ÿè®¸æƒ³é‡æ–°ä½¿ç”¨è¿™ä¸ªæ— æ•ˆå‚æ•°æ¥è°ƒç”¨Sqrtã€‚æˆ‘ä»¬èƒ½é€šè¿‡å®šä¹‰ä¸€ä¸ªæ–°çš„errorçš„å®ç°å®Œæˆè¿™ä¸ªç›®æ ‡ï¼Œè€Œä¸æ˜¯ä½¿ç”¨errors.errorStringï¼š</p>

<pre><span class="kwd">type</span> <span class="typ">NegativeSqrtError</span> <span class="kwd">float64</span>

<span class="kwd">func</span> <span class="pun">(</span><span class="pln">f</span> <span class="typ">NegativeSqrtError</span><span class="pun">)</span> <span class="typ">Error</span><span class="pun">(</span><span class="pun">)</span> <span class="pln">string</span> <span class="pun">{</span>
    <span class="kwd">return</span> <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Sprintf</span><span class="pun">(</span><span class="str">&#34;math: square root of negative number %g&#34;</span><span class="pun">,</span> <span class="kwd">float64</span><span class="pun">(</span><span class="pln">f</span><span class="pun">)</span><span class="pun">)</span>
<span class="pun">}</span>
</pre>

<p>å¤æ‚çš„è°ƒç”¨å¯ä»¥ä½¿ç”¨ç±»å‹æ–­è¨€ï¼ˆ<a href="https://golang.org/ref/spec#Type_assertions">type assertion</a>ï¼‰æ¥æ£€æŸ¥NegativeSqrtErrorå¹¶ç‰¹åˆ«å¤„ç†ï¼Œå½“è°ƒç”¨è€…å°†errorä¼ é€’ç»™fmt.Printlnæˆ–è€…log.Fatalçš„æ—¶å€™ï¼Œä¸ä¼šæœ‰ä»»ä½•è¡Œä¸ºä¸Šçš„å˜åŒ–ã€‚
å†ä¸¾ä¸ªä¾‹å­ï¼Œå½“json.Decodeå‡½æ•°è§£æä¸€ä¸ªJSON blobé‡åˆ°è¯­æ³•é”™è¯¯æ—¶ï¼Œè¿”å›ä¸€ä¸ªjsonåŒ…ä¸­‰ä»»ä½•è¡Œä¸ºä¸Šçš„å˜åŒ–ã€‚
å†ä¸¾ä¸ªä¾‹å­ï¼Œå½“json.Decodeå‡½æ•°è§£æä¸€ä¸ªJSON blobé‡åˆ°è¯­æ³•é”™è¯¯æ—¶ï¼Œè¿”å›ä¸€ä¸ªjsonåŒ…ä¸­æŒ‡å®šçš„SyntaxErrorç±»å‹ã€‚</p>

<pre><span class="kwd">type</span> <span class="typ">SyntaxError</span> <span class="kwd">struct</span> <span class="pun">{</span>
    <span class="pln">msg</span>    <span class="pln">string</span> <span class="com">// description of error</span>
    <span class="typ">Offset</span> <span class="kwd">int64</span>  <span class="com">// error occurred after reading Offset bytes</span>
<span class="pun">}</span>

<span class="kwd">func</span> <span class="pun">(</span><span class="pln">e</span> <span class="pun">*</span><span class="typ">SyntaxError</span><span class="pun">)</span> <span class="typ">Error</span><span class="pun">(</span><span class="pun">)</span> <span class="pln">string</span> <span class="pun">{</span> <span class="kwd">return</span> <span class="pln">e</span><span class="pun">.</span><span class="pln">msg</span> <span class="pun">}</span>
</pre>

<p>Offsetå­—æ®µç”šè‡³ä¸ä¼šåœ¨erroré»˜è®¤çš„æ ¼å¼åŒ–ä¸­å‡ºç°ï¼Œä½†æ˜¯è°ƒç”¨è€…å¯ä»¥ä½¿ç”¨å®ƒï¼Œæ·»åŠ æ–‡ä»¶å’Œè¡Œä¿¡æ¯åˆ°åˆ°erroræ¶ˆæ¯ä¸­ã€‚</p>

<pre><span class="kwd">if</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">dec</span><span class="pun">.</span><span class="typ">Decode</span><span class="pun">(</span><span class="pun">&amp;</span><span class="pln">val</span><span class="pun">)</span><span class="pun">;</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
    <span class="kwd">if</span> <span class="pln">serr</span><span class="pun">,</span> <span class="pln">ok</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">err</span><span class="pun">.</span><span class="pun">(</span><span class="pun">*</span><span class="pln">json</span><span class="pun">.</span><span class="typ">SyntaxError</span><span class="pun">)</span><span class="pun">;</span> <span class="pln">ok</span> <span class="pun">{</span>
        <span class="pln">line</span><span class="pun">,</span> <span class="pln">col</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">findLine</span><span class="pun">(</span><span class="pln">f</span><span class="pun">,</span> <span class="pln">serr</span><span class="pun">.</span><span class="typ">Offset</span><span class="pun">)</span>
        <span class="kwd">return</span> <span class="pln">fmt</span><span class="pun">.</span><span class="typ">Errorf</span><span class="pun">(</span><span class="str">&#34;%s:%d:%d: %v&#34;</span><span class="pun">,</span> <span class="pln">f</span><span class="pun">.</span><span class="typ">Name</span><span class="pun">(</span><span class="pun">)</span><span class="pun">,</span> <span class="pln">line</span><span class="pun">,</span> <span class="pln">col</span><span class="pun">,</span> <span class="pln">err</span><span class="pun">)</span>
    <span class="pun">}</span>
    <span class="kwd">return</span> <span class="pln">err</span>
<span class="pun">}</span>
</pre>

<p>ï¼ˆè¿™æ˜¯æ¥è‡ªCamlistoreé¡¹ç›®çš„çœŸå®ä»£ç çš„çœç•¥çš„ç®€åŒ–ç‰ˆæœ¬ï¼‰
erroræ¥å£ä»…ä»…éœ€è¦Erroræ–¹æ³•ï¼›ç‰¹æ®Šçš„errorå®ç°å¯èƒ½éœ€è¦å…¶ä»–çš„æ–¹æ³•ã€‚ä¾‹å¦‚ï¼ŒnetåŒ…ä¸­è¿”å›errorç±»å‹çš„é”™è¯¯ï¼Œéµå¾ªäº†é€šå¸¸çš„æƒ¯ä¾‹ï¼Œä½†æ˜¯ä¸€äº›errorçš„å®ç°é€šè¿‡net.Erroræ¥å£å®šä¹‰äº†å…¶ä»–æ–¹æ³•ï¼š</p>

<pre><span class="kwd">package</span> <span class="pln">net</span>

<span class="kwd">type</span> <span class="typ">Error</span> <span class="kwd">interface</span> <span class="pun">{</span>
    <span class="pln">error</span>
    <span class="typ">Timeout</span><span class="pun">(</span><span class="pun">)</span> <span class="kwd">bool</span>   <span class="com">// Is the error a timeout?</span>
    <span class="typ">Temporary</span><span class="pun">(</span><span class="pun">)</span> <span class="kwd">bool</span> <span class="com">// Is the error temporary?</span>
<span class="pun">}</span>
</pre>

<p>å®¢æˆ·ç«¯ä»£ç å¯ä»¥ä½¿ç”¨ç±»å‹æ–­è¨€ï¼ˆtype assertionï¼‰æ¥æµ‹è¯•ï¼Œç„¶åä»æ°¸ä¹…æ€§é”™è¯¯ä¸­åŒºåˆ†çŸ­æš‚çš„çš„ç½‘ç»œé”™è¯¯ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªç½‘ç»œçˆ¬è™«ä¹Ÿè®¸ä¼šä¼‘çœ å¹¶é‡è¯•å½“å®ƒé‡åˆ°ä¸€ä¸ªé›¶æ—¶æ€§é”™è¯¯å¹¶æ”¾å¼ƒå…¶ä»–çš„ã€‚</p>

<pre><span class="kwd">if</span> <span class="pln">nerr</span><span class="pun">,</span> <span class="pln">ok</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">err</span><span class="pun">.</span><span class="pun">(</span><span class="pln">net</span><span class="pun">.</span><span class="typ">Error</span><span class="pun">)</span><span class="pun">;</span> <span class="pln">ok</span> <span class="pun">&amp;</span><span class="pun">&amp;</span> <span class="pln">nerr</span><span class="pun">.</span><span class="typ">Temporary</span><span class="pun">(</span><span class="pun">)</span> <span class="pun">{</span>
    <span class="pln">time</span><span class="pun">.</span><span class="typ">Sleep</span><span class="pun">(</span><span class="dec">1e9</span><span class="pun">)</span>
    <span class="kwd">continue</span>
<span class="pun">}</span>
<span class="kwd">if</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
    <span class="pln">log</span><span class="pun">.</span><span class="typ">Fatal</span><span class="pun">(</span><span class="pln">err</span><span class="pun">)</span>
<span class="pun">}</span>
</pre>

<h3>ç®€åŒ–é‡å¤çš„é”™è¯¯å¤„ç†</h3>

<p>åœ¨Goä¸­ï¼Œé”™è¯¯å¤„ç†éå¸¸é‡è¦ã€‚è¯­è¨€çš„è®¾è®¡å’Œçº¦å®šé¼“åŠ±ä½ åœ¨å‘ç”Ÿé”™è¯¯çš„æ—¶å€™æ˜ç¡®æ£€æŸ¥é”™è¯¯ï¼ˆå’Œå…¶ä»–è¯­è¨€ä½¿ç”¨æŠ›å‡ºé”™è¯¯å¹¶è·å–é”™è¯¯ï¼ˆ throwing exceptions and sometimes catching them ï¼‰çš„æƒ¯ä¾‹ä¸ä¸€æ ·ï¼‰ã€‚åœ¨æœ‰äº›æƒ…å†µä¸‹ï¼Œè¿™ä½¿ä½ çš„Goä»£ç å†—ä½™ï¼Œä½†æ˜¯å¹¸è¿çš„æ˜¯ï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸€äº›æŠ€å·§æ¥æœ€å°‘çš„é‡å¤é”™è¯¯å¤„ç†ã€‚
æ€è€ƒä¸€ä¸ªä½¿ç”¨HTTPå¤„ç†å™¨çš„App Engineåº”ç”¨ï¼Œä»æ•°æ®åº“ä¸­æ£€ç´¢ä¸€æ¡è®°å½•å¹¶ä½¿ç”¨æ¨¡æ¿æ ¼å¼åŒ–ã€‚</p>

<pre><span class="kwd">func</span> <span class="pln">init</span><span class="pun">(</span><span class="pun">)</span> <span class="pun">{</span>
    <span class="pln">http</span><span class="pun">.</span><span class="typ">HandleFunc</span><span class="pun">(</span><span class="str">&#34;/view&#34;</span><span class="pun">,</span> <span class="pln">viewRecord</span><span class="pun">)</span>
<span class="pun">}</span>

<span class="kwd">func</span> <span class="pln">viewRecord</span><span class="pun">(</span><span class="pln">w</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">ResponseWriter</span><span class="pun">,</span> <span class="pln">r</span> <span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">)</span> <span class="pun">{</span>
    <span class="pln">c</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">appengine</span><span class="pun">.</span><span class="typ">NewContext</span><span class="pun">(</span><span class="pln">r</span><span class="pun">)</span>
    <span class="pln">key</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">datastore</span><span class="pun">.</span><span class="typ">NewKey</span><span class="pun">(</span><span class="pln">c</span><span class="pun">,</span> <span class="str">&#34;Record&#34;</span><span class="pun">,</span> <span class="pln">r</span><span class="pun">.</span><span class="typ">FormValue</span><span class="pun">(</span><span class="str">&#34;id&#34;</span><span class="pun">)</span><span class="pun">,</span> <span class="dec">0</span><span class="pun">,</span> <span class="kwd">nil</span><span class="pun">)</span>
    <span class="pln">record</span> <span class="pun">:</span><span class="pun">=</span> <span class="kwd">new</span><span class="pun">(</span><span class="typ">Record</span><span class="pun">)</span>
    <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">datastore</span><span class="pun">.</span><span class="typ">Get</span><span class="pun">(</span><span class="pln">c</span><span class="pun">,</span> <span class="pln">key</span><span class="pun">,</span> <span class="pln">record</span><span class="pun">)</span><span class="pun">;</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
        <span class="pln">http</span><span class="pun">.</span><span class="typ">Error</span><span class="pun">(</span><span class="pln">w</span><span class="pun">,</span> <span class="pln">err</span><span class="pun">.</span><span class="typ">Error</span><span class="pun">(</span><span class="pun">)</span><span class="pun">,</span> <span class="dec">500</span><span class="pun">)</span>
        <span class="kwd">return</span>
    <span class="pun">}</span>
    <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">viewTemplate</span><span class="pun">.</span><span class="typ">Execute</span><span class="pun">(</span><span class="pln">w</span><span class="pun">,</span> <span class="pln">record</span><span class="pun">)</span><span class="pun">;</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
        <span class="pln">http</span><span class="pun">.</span><span class="typ">Error</span><span class="pun">(</span><span class="pln">w</span><span class="pun">,</span> <span class="pln">err</span><span class="pun">.</span><span class="typ">Error</span><span class="pun">(</span><span class="pun">)</span><span class="pun">,</span> <span class="dec">500</span><span class="pun">)</span>
    <span class="pun">}</span>
<span class="pun">}</span>
</pre>

<p>è¿™ä¸ªå‡½æ•°å¤„ç†ç”±datastore.Getå‡½æ•°å’Œ<code>viewTemplate</code>çš„Executeæ–¹æ³•äº§ç”Ÿçš„é”™è¯¯ã€‚åœ¨è¿™ä¸¤ä¸ªé”™è¯¯ä¸­ï¼Œå®ƒç”¨HTTPçŠ¶æ€ç 500(â€œInternal Server Errorâ€)æ¥å‘ç”¨æˆ·å±•ç°ä¸€ä¸ªç®€å•çš„é”™è¯¯ä¿¡æ¯ã€‚è¿™æ®µä»£ç çœ‹èµ·æ¥æ˜¯å¯ç®¡ç†çš„ï¼Œä½†æ˜¯æ·»åŠ äº†å¤šä½™çš„HTTPå¤„ç†å™¨ï¼Œå¹¶ä»¥è®¸å¤šç›¸åŒçš„é”™è¯¯å¤„ç†ä»£ç ç»“æŸã€‚
ä¸ºäº†å‡å°‘é‡å¤ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰æˆ‘ä»¬è‡ªå·±çš„HTTP appHandlerç±»å‹æ¥åŒ…å«errorå¹¶è¿”å›å€¼ã€‚</p>

<pre><span class="kwd">type</span> <span class="pln">appHandler</span> <span class="kwd">func</span><span class="pun">(</span><span class="pln">http</span><span class="pun">.</span><span class="typ">ResponseWriter</span><span class="pun">,</span> <span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">)</span> <span class="pln">error</span>
</pre>

<p>ç„¶åï¼Œæˆ‘ä»¬ä¿®æ”¹æˆ‘ä»¬çš„viewRecord å‡½æ•°æ¥è¿”å›é”™è¯¯ï¼š</p>

<pre><span class="kwd">func</span> <span class="pln">viewRecord</span><span class="pun">(</span><span class="pln">w</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">ResponseWriter</span><span class="pun">,</span> <span class="pln">r</span> <span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">)</span> <span class="pln">error</span> <span class="pun">{</span>
    <span class="pln">c</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">appengine</span><span class="pun">.</span><span class="typ">NewContext</span><span class="pun">(</span><span class="pln">r</span><span class="pun">)</span>
    <span class="pln">key</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">datastore</span><span class="pun">.</span><span class="typ">NewKey</span><span class="pun">(</span><span class="pln">c</span><span class="pun">,</span> <span class="str">&#34;Record&#34;</span><span class="pun">,</span> <span class="pln">r</span><span class="pun">.</span><span class="typ">FormValue</span><span class="pun">(</span><span class="str">&#34;id&#34;</span><span class="pun">)</span><span class="pun">,</span> <span class="dec">0</span><span class="pun">,</span> <span class="kwd">nil</span><span class="pun">)</span>
    <span class="pln">record</span> <span class="pun">:</span><span class="pun">=</span> <span class="kwd">new</span><span class="pun">(</span><span class="typ">Record</span><span class="pun">)</span>
    <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">datastore</span><span class="pun">.</span><span class="typ">Get</span><span class="pun">(</span><span class="pln">c</span><span class="pun">,</span> <span class="pln">key</span><span class="pun">,</span> <span class="pln">record</span><span class="pun">)</span><span class="pun">;</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
        <span class="kwd">return</span> <span class="pln">err</span>
    <span class="pun">}</span>
    <span class="kwd">return</span> <span class="pln">viewTemplate</span><span class="pun">.</span><span class="typ">Execute</span><span class="pun">(</span><span class="pln">w</span><span class="pun">,</span> <span class="pln">record</span><span class="pun">)</span>
<span class="pun">}</span>
</pre>

<p>è¿™å’ŒåŸå§‹çš„ç‰ˆæœ¬ç›¸ä¼¼ï¼Œä½†æ˜¯httpåŒ…ä¸èƒ½ç†è§£è¿”å›errorçš„å‡½æ•°ã€‚ä¸ºäº†ä¿®æ­£ï¼Œæˆ‘ä»¬åœ¨appHandlerä¸Šå®ç°äº†http.Handleræ¥å£çš„ServeHTTPæ–¹æ³•ï¼š</p>

<pre><span class="kwd">func</span> <span class="pun">(</span><span class="pln">fn</span> <span class="pln">appHandler</span><span class="pun">)</span> <span class="typ">ServeHTTP</span><span class="pun">(</span><span class="pln">w</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">ResponseWriter</span><span class="pun">,</span> <span class="pln">r</span> <span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">)</span> <span class="pun">{</span>
    <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">fn</span><span class="pun">(</span><span class="pln">w</span><span class="pun">,</span> <span class="pln">r</span><span class="pun">)</span><span class="pun">;</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
        <span class="pln">http</span><span class="pun">.</span><span class="typ">Error</span><span class="pun">(</span><span class="pln">w</span><span class="pun">,</span> <span class="pln">err</span><span class="pun">.</span><span class="typ">Error</span><span class="pun">(</span><span class="pun">)</span><span class="pun">,</span> <span class="dec">500</span><span class="pun">)</span>
    <span class="pun">}</span>
<span class="pun">}</span>
</pre>

<p>ServeHTTPæ–¹æ³•è°ƒç”¨appHandlerå‡½æ•°å¹¶ä¸”å‘ç”¨æˆ·æ˜¾ç¤ºé”™è¯¯ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ã€‚æ³¨æ„è¿™ä¸ªæ–¹æ³•çš„æ¥æ”¶è€…ï¼Œfnï¼Œæ˜¯ä¸€ä¸ªå‡½æ•°ã€‚ï¼ˆGoå¯ä»¥è¿™æ ·åšï¼ï¼‰æ–¹æ³•è°ƒç”¨å‡½æ•°é€šè¿‡è°ƒç”¨è¡¨è¾¾å¼fn(w, r)ä¸­çš„æ¥æ”¶è€…ã€‚
ç°åœ¨ï¼Œå½“ä½¿ç”¨httpåŒ…æ³¨å†ŒviewRecordçš„æ—¶å€™ï¼Œæˆ‘ä»¬ä½¿ç”¨Handleå‡½æ•°ï¼ˆè€Œä¸æ˜¯HandleFuncï¼‰appHandlerä½œä¸ºhttp.Handlerï¼ˆè€Œä¸æ˜¯http.HandlerFuncï¼‰</p>

<pre><span class="kwd">func</span> <span class="pln">init</span><span class="pun">(</span><span class="pun">)</span> <span class="pun">{</span>
    <span class="pln">http</span><span class="pun">.</span><span class="typ">Handle</span><span class="pun">(</span><span class="str">&#34;/view&#34;</span><span class="pun">,</span> <span class="pln">appHandler</span><span class="pun">(</span><span class="pln">viewRecord</span><span class="pun">)</span><span class="pun">)</span>
<span class="pun">}</span>
</pre>

<p>é€šè¿‡åŸºæœ¬æ¶æ„ä¸­çš„é”™è¯¯å¤„ç†ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿å®ƒæ›´åŠ çš„ç”¨æˆ·å‹å¥½ã€‚ç›¸æ¯”ä»…ä»…å±•ç¤ºé”™è¯¯çš„å­—ç¬¦ä¸²ï¼Œæ›´å¥½çš„æ–¹æ³•æ˜¯ç»™ç”¨æˆ·ç®€å•çš„é”™è¯¯æ¶ˆæ¯å¹¶é™„åŠ é€‚åˆçš„HTTPçŠ¶æ€ç ï¼ŒåŒæ—¶åœ¨App Engineå¼€å‘è€…æ§åˆ¶å°è®°å½•å®Œæ•´çš„é”™è¯¯ç”¨äºè°ƒè¯•ã€‚
ä¸ºäº†åšåˆ°è¿™ç‚¹ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªappError ç»“æ„ä½“ï¼ŒåŒ…å«ä¸€ä¸ªerrorç±»å‹å’Œä¸€äº›å…¶ä»–å­—æ®µ</p>

<pre><span class="kwd">type</span> <span class="pln">appError</span> <span class="kwd">struct</span> <span class="pun">{</span>
    <span class="typ">Error</span>   <span class="pln">error</span>
    <span class="typ">Message</span> <span class="pln">string</span>
    <span class="typ">Code</span>    <span class="kwd">int</span>
<span class="pun">}</span>
</pre>

<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¿®æ”¹appHandlerç±»å‹ä»¥ä¾¿è¿”å›*appErrorå€¼ï¼š</p>

<pre><span class="kwd">type</span> <span class="pln">appHandler</span> <span class="kwd">func</span><span class="pun">(</span><span class="pln">http</span><span class="pun">.</span><span class="typ">ResponseWriter</span><span class="pun">,</span> <span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">)</span> <span class="pun">*</span><span class="pln">appError</span>
</pre>

<p>ï¼ˆé€šå¸¸ï¼Œä¸ä½¿ç”¨errorï¼Œè€Œæ˜¯ä½¿ç”¨å…·ä½“çš„errorç±»å‹è¿›è¡Œä¼ é€’çš„åšæ³•æ˜¯é”™è¯¯çš„ï¼ŒåŸå› ä¼šåœ¨<a href="https://golang.org/doc/faq#nil_error">Go FAQ</a>ä¸­è®¨è®ºï¼Œä¸è¿‡åœ¨è¿™é‡Œæ˜¯æ­£ç¡®çš„ï¼Œå› ä¸ºServeHTTPæ˜¯å”¯ä¸€çœ‹åˆ°è¿™ä¸ªå€¼å¹¶ä¸”ä½¿ç”¨å…¶å†…å®¹çš„åœ°æ–¹ã€‚ï¼‰
 ä¸ºäº†ä½¿<code>appHandler</code>çš„ServeHTTPæ–¹æ³•å‘ç”¨æˆ·æ˜¾ç¤º<code>appError</code>çš„æ¶ˆæ¯å’Œæ­£ç¡®çš„HTTPçŠ¶æ€ç ï¼Œå¹¶å‘å¼€å‘è€…è®°å½•å®Œæ•´çš„Errorï¼š</p>

<pre> <span class="kwd">func</span> <span class="pun">(</span><span class="pln">fn</span> <span class="pln">appHandler</span><span class="pun">)</span> <span class="typ">ServeHTTP</span><span class="pun">(</span><span class="pln">w</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">ResponseWriter</span><span class="pun">,</span> <span class="pln">r</span> <span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">)</span> <span class="pun">{</span>
    <span class="kwd">if</span> <span class="pln">e</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">fn</span><span class="pun">(</span><span class="pln">w</span><span class="pun">,</span> <span class="pln">r</span><span class="pun">)</span><span class="pun">;</span> <span class="pln">e</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span> <span class="com">// e is *appError, not os.Error.</span>
        <span class="pln">c</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">appengine</span><span class="pun">.</span><span class="typ">NewContext</span><span class="pun">(</span><span class="pln">r</span><span class="pun">)</span>
        <span class="pln">c</span><span class="pun">.</span><span class="typ">Errorf</span><span class="pun">(</span><span class="str">&#34;%v&#34;</span><span class="pun">,</span> <span class="pln">e</span><span class="pun">.</span><span class="typ">Error</span><span class="pun">)</span>
        <span class="pln">http</span><span class="pun">.</span><span class="typ">Error</span><span class="pun">(</span><span class="pln">w</span><span class="pun">,</span> <span class="pln">e</span><span class="pun">.</span><span class="typ">Message</span><span class="pun">,</span> <span class="pln">e</span><span class="pun">.</span><span class="typ">Code</span><span class="pun">)</span>
    <span class="pun">}</span>
<span class="pun">}</span>
</pre>

<p>æœ€åï¼Œæˆ‘ä»¬æ›´æ–°viewRecordå‡½æ•°ï¼Œå¹¶ä½¿å®ƒé‡åˆ°é”™è¯¯çš„æ—¶å€™è¿”å›æ›´å¤šçš„ä¸Šä¸‹æ–‡ï¼š</p>

<pre> <span class="kwd">func</span> <span class="pln">viewRecord</span><span class="pun">(</span><span class="pln">w</span> <span class="pln">http</span><span class="pun">.</span><span class="typ">ResponseWriter</span><span class="pun">,</span> <span class="pln">r</span> <span class="pun">*</span><span class="pln">http</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">)</span> <span class="pun">*</span><span class="pln">appError</span> <span class="pun">{</span>
    <span class="pln">c</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">appengine</span><span class="pun">.</span><span class="typ">NewContext</span><span class="pun">(</span><span class="pln">r</span><span class="pun">)</span>
    <span class="pln">key</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">datastore</span><span class="pun">.</span><span class="typ">NewKey</span><span class="pun">(</span><span class="pln">c</span><span class="pun">,</span> <span class="str">&#34;Record&#34;</span><span class="pun">,</span> <span class="pln">r</span><span class="pun">.</span><span class="typ">FormValue</span><span class="pun">(</span><span class="str">&#34;id&#34;</span><span class="pun">)</span><span class="pun">,</span> <span class="dec">0</span><span class="pun">,</span> <span class="kwd">nil</span><span class="pun">)</span>
    <span class="pln">record</span> <span class="pun">:</span><span class="pun">=</span> <span class="kwd">new</span><span class="pun">(</span><span class="typ">Record</span><span class="pun">)</span>
    <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">datastore</span><span class="pun">.</span><span class="typ">Get</span><span class="pun">(</span><span class="pln">c</span><span class="pun">,</span> <span class="pln">key</span><span class="pun">,</span> <span class="pln">record</span><span class="pun">)</span><span class="pun">;</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
        <span class="kwd">return</span> <span class="pun">&amp;</span><span class="pln">appError</span><span class="pun">{</span><span class="pln">err</span><span class="pun">,</span> <span class="str">&#34;Record not found&#34;</span><span class="pun">,</span> <span class="dec">404</span><span class="pun">}</span>
    <span class="pun">}</span>
    <span class="kwd">if</span> <span class="pln">err</span> <span class="pun">:</span><span class="pun">=</span> <span class="pln">viewTemplate</span><span class="pun">.</span><span class="typ">Execute</span><span class="pun">(</span><span class="pln">w</span><span class="pun">,</span> <span class="pln">record</span><span class="pun">)</span><span class="pun">;</span> <span class="pln">err</span> <span class="pun">!</span><span class="pun">=</span> <span class="kwd">nil</span> <span class="pun">{</span>
        <span class="kwd">return</span> <span class="pun">&amp;</span><span class="pln">appError</span><span class="pun">{</span><span class="pln">err</span><span class="pun">,</span> <span class="str">&#34;Can&#39;t display record&#34;</span><span class="pun">,</span> <span class="dec">500</span><span class="pun">}</span>
    <span class="pun">}</span>
    <span class="kwd">return</span> <span class="kwd">nil</span>
<span class="pun">}</span>
</pre>

<p>è¿™ä¸ªç‰ˆæœ¬çš„viewRecordå’ŒåŸå§‹ç‰ˆæœ¬çš„ç¨‹åº¦ç›¸åŒï¼Œä½†æ˜¯ç°åœ¨æ¯ä¸€è¡Œéƒ½æœ‰ç‰¹åˆ«çš„æ„æ€ï¼Œå¹¶ä¸”ï¼Œæˆ‘ä»¬æä¾›æ›´åŠ å‹å¥½çš„ç”¨æˆ·ä½“éªŒã€‚
 è¿™è¿˜æ²¡ç»“æŸï¼›æˆ‘ä»¬å°†ä¼šåœ¨æˆ‘ä»¬çš„åº”ç”¨ä¸­ä¼˜åŒ–é”™è¯¯å¤„ç†ã€‚ä¸€äº›æƒ³æ³•ï¼š
 - ç»™äºˆæ¯ä¸ªé”™è¯¯å¤„ç†ä¸€ä¸ªæ¼‚äº®çš„HTMLæ¨¡æ¿
 - å½“ç”¨æˆ·æ˜¯ç®¡ç†å‘˜æ—¶ï¼Œå°†stack traceå†™åˆ°HTTPå›åº”ä¸­ï¼Œä½¿debugæ›´åŠ ç®€å•
 - ä¸ºappErrorå†™ä¸€ä¸ªæ„å»ºå‡½æ•°ï¼Œç”¨äºå­˜å‚¨stack traceï¼Œä»¥ä¾¿è°ƒè¯•
 - åœ¨appHandlerä¸­å‘ç”Ÿpanicæ—¶recoverï¼Œå°†é”™è¯¯ä½œä¸ºâ€œå±é™©â€å†™å…¥å¼€å‘è€…æ§åˆ¶å°ï¼Œå¹¶ç”¨æˆ·â€œå‘ç”Ÿäº†ä¸€ä¸ªä¸¥é‡çš„é”™è¯¯â€ã€‚ è¿™æ˜¯é¿å…å‘ç”¨æˆ·æš´éœ²ç”±äºç¼–ç¨‹é”™è¯¯å¼•èµ·çš„ä¸å¯é¢„æµ‹çš„é”™è¯¯çš„ä¿¡æ¯çš„ä¸€ä¸ªå¾ˆå¥½çš„æƒ³æ³•ã€‚å‚çœ‹<a href="http://golang.org/doc/articles/defer_panic_recover.html">Defer, Panic, and Recover</a> æ–‡ç« è·å–æ›´å¤šç»†èŠ‚ã€‚</p>

<h3>æ€»ç»“</h3>

<p>é€‚åˆçš„é”™è¯¯å¤„ç†æ˜¯ä¸€ä¸ªå¥½çš„è½¯ä»¶çš„åŸºæœ¬éœ€æ±‚ã€‚æ ¹æ®æœ¬æ–‡æ‰€è®¨è®ºçš„æŠ€æœ¯ï¼Œä½ åº”è¯¥èƒ½å¤Ÿå†™å‡ºæ›´å¯é ä¸”æ›´ç®€æ´çš„Goä»£ç </p>

<p>Andrew Gerrand è‘—</p>
</div>
</body>

</html>