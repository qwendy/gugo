<html>

<head>
    <title>MongoDB-Shardingå¸¸ç”¨å‘½ä»¤</title>
</head>

<body>
    <div>MongoDB-Shardingå¸¸ç”¨å‘½ä»¤</div>
    <div>2016-12-22 20:08:07</div>
    <div><p>èµ„æ–™æ¥æºï¼š <a href="https://docs.mongodb.com/v3.2/tutorial/administer-shard-tags/">https://docs.mongodb.com/v3.2/tutorial/administer-shard-tags/</a>
è¯¦ç»†å‘½ä»¤å‚è€ƒï¼š <a href="https://docs.mongodb.com/v3.2/reference/sharding/">https://docs.mongodb.com/v3.2/reference/sharding/</a></p>

<h1>åˆ†ç‰‡å¸¸ç”¨</h1>

<h2>é…ç½®Sharding</h2>

<ul>
<li><p>è¿æ¥è·¯ç”±æœåŠ¡å™¨</p>

<pre><code>.\bin\mongo.exe admin --port 40000
</code></pre></li>

<li><p>è®¾ç½®åˆ†ç‰‡æœåŠ¡å™¨</p>

<pre><code>db.runCommand({ addshard:&#34;127.0.0.1:27100&#34; })
db.runCommand({ addshard:&#34;127.0.0.1:27101&#34; })
db.runCommand({ addshard:&#34;127.0.0.1:27017&#34; })
æˆ–è€…
sh.addShard(&#34;127.0.0.1:27100&#34;)
</code></pre></li>

<li><p>è®¾ç½®è¦åˆ†ç‰‡çš„æ•°æ®åº“</p>

<pre><code>db.runCommand({ enablesharding:&#34;qdgame&#34; })
æˆ–è€…ï¼š
sh.enableSharding(&#34;qdgame&#34;)
</code></pre></li>

<li><p>å…³é—­balancing</p>

<pre><code>sh.disableBalancing(&#34;qdgame.backpack&#34;)
</code></pre>

<!-- more --></li>

<li><p>è®¾ç½®è¦åˆ†ç‰‡çš„collection</p>

<pre><code>db.runCommand({ shardcollection: &#34;qdgame.backpack&#34;, key: { _id:1}})
æˆ–è€…
sh.shardCollection(&#34;qdgame.backpack&#34;,{usrid:1, id:1})
</code></pre></li>

<li><p>å¼€å¯balancing</p>

<pre><code>sh.enableBalancing(&#34;qdgame.backpack&#34;)
</code></pre></li>
</ul>

<p>æ³¨æ„ï¼šè®¾ç½®ä¸€å®šè¦åœ¨adminæ•°æ®åº“ä¸‹ã€‚</p>

<h2>ä½¿ç”¨hashåˆ†ç‰‡ä¸€ä¸ªcollection</h2>

<pre><code>sh.shardCollection( &#34;database.collection&#34;, { &lt;field&gt; : &#34;hashed&#34; } )
</code></pre>

<h2>æ”¹å˜chunkå¤§å°</h2>

<pre><code>db.settings.save( { _id:&#34;chunksize&#34;, value: &lt;size&gt; } )
</code></pre>

<h2>æ·»åŠ indexç´¢å¼•</h2>

<pre><code>db.collection.ensureIndex({a:1,b:-1})
</code></pre>

<h1>ç®¡ç†åˆ†ç‰‡æ ‡ç­¾</h1>

<h2>æ ‡è®°ä¸€ä¸ªåˆ†ç‰‡</h2>

<p>å½“è¿æ¥åˆ°mongoså®ä¾‹æ—¶ï¼Œä½¿ç”¨sh.addShardTagï¼ˆï¼‰æ–¹æ³•å°†æ ‡è®°ä¸ç‰¹å®šåˆ†ç‰‡å…³è”ã€‚å•ä¸ªåˆ†ç‰‡å¯ä»¥å…·æœ‰å¤šä¸ªæ ‡ç­¾ï¼Œå¹¶ä¸”å¤šä¸ªåˆ†ç‰‡ä¹Ÿå¯ä»¥å…·æœ‰ç›¸åŒçš„æ ‡ç­¾ã€‚</p>

<pre><code>sh.addShardTag(&#34;shard0000&#34;, &#34;NYC&#34;)
sh.addShardTag(&#34;shard0001&#34;, &#34;NYC&#34;)
sh.addShardTag(&#34;shard0002&#34;, &#34;SFO&#34;)
sh.addShardTag(&#34;shard0002&#34;, &#34;NRT&#34;)
</code></pre>

<p>åœ¨è¿æ¥åˆ°mongoså®ä¾‹æ—¶ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨sh.removeShardTagï¼ˆï¼‰æ–¹æ³•ä»ç‰¹å®šåˆ†ç‰‡ä¸­åˆ é™¤æ ‡ç­¾ï¼Œå¦‚ä»¥ä¸‹ç¤ºä¾‹æ‰€ç¤ºï¼Œè¯¥ç¤ºä¾‹ä»åˆ†ç‰‡ä¸­åˆ é™¤NRTæ ‡ç­¾ï¼š</p>

<pre><code>sh.removeShardTag(&#34;shard0002&#34;, &#34;NRT&#34;)
</code></pre>

<h2>æ ‡è®°shard keyèŒƒå›´</h2>

<p>åœ¨è¿æ¥åˆ°mongoså®ä¾‹æ—¶ä½¿ç”¨sh.addTagRangeï¼ˆï¼‰æ–¹æ³•æ¥ç»™æŸä¸ªèŒƒå›´çš„shard keyæ·»åŠ æ ‡ç­¾ã€‚ä»»ä½•ç»™å®šçš„åˆ†ç‰‡é”®èŒƒå›´éƒ½åªå…·æœ‰ä¸€ä¸ªåˆ†é…çš„æ ‡ç­¾ã€‚æ‚¨ä¸èƒ½é‡å å®šä¹‰çš„èŒƒå›´ï¼Œä¹Ÿä¸èƒ½å¤šæ¬¡æ ‡è®°åŒä¸€èŒƒå›´ã€‚</p>

<pre><code>sh.addTagRange(&#34;records.users&#34;, { zipcode: &#34;10001&#34; }, { zipcode: &#34;10281&#34; }, &#34;NYC&#34;)
sh.addTagRange(&#34;records.users&#34;, { zipcode: &#34;11201&#34; }, { zipcode: &#34;11240&#34; }, &#34;NYC&#34;)
sh.addTagRange(&#34;records.users&#34;, { zipcode: &#34;94102&#34; }, { zipcode: &#34;94135&#34; }, &#34;SFO&#34;)
</code></pre>

<h2>ä»shard keyèŒƒå›´ä¸­åˆ é™¤æ ‡è®°</h2>

<pre><code>use config
db.tags.remove({ _id: { ns: &#34;records.users&#34;, min: { zipcode: &#34;10001&#34; }}, tag: &#34;NYC&#34; })
</code></pre>

<h2>è®¿é—®æ ‡ç­¾</h2>

<p>sh.statusï¼ˆï¼‰åˆ—å‡ºä¸æ¯ä¸ªåˆ†ç‰‡ç›¸å…³è”çš„åˆ†ç‰‡ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰çš„æ ‡ç­¾ã€‚shardçš„æ ‡è®°å­˜åœ¨äºconfigæ•°æ®åº“çš„shards
é›†åˆä¸­çš„shardæ–‡æ¡£ä¸­ã€‚</p>

<pre><code>use config
db.shards.find({ tags: &#34;NYC&#34; })
</code></pre>

<p>æ‚¨å¯ä»¥åœ¨configæ•°æ®åº“çš„tagsé›†åˆä¸­æ‰¾åˆ°æ‰€æœ‰å‘½åç©ºé—´çš„æ ‡è®°èŒƒå›´ã€‚ sh.statusï¼ˆæ˜¾ç¤ºæ‰€æœ‰æ ‡ç­¾èŒƒå›´ã€‚è¦è¿”å›ç”¨NYCæ ‡è®°çš„æ‰€æœ‰shard keyèŒƒå›´ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹æ“ä½œï¼š</p>

<pre><code>use config
db.shards.find({ tags: &#34;NYC&#34; })
</code></pre>

<h1>ä¾‹å­ï¼šæ ¹æ®åœ°åŒºæ¥åˆ’åˆ†æ•°æ®</h1>

<h2>åœºæ™¯</h2>

<p>åœ¨messagesé›†åˆä¸­åˆ›å»ºæµ‹è¯•æ•°æ®å¦‚ä¸‹ï¼š</p>

<pre><code>{
  &#34;_id&#34; : ObjectId(&#34;56f08c447fe58b2e96f595fa&#34;),
  &#34;country&#34; : &#34;US&#34;,
  &#34;userid&#34; : 123,
  &#34;message&#34; : &#34;Hello there&#34;,
  ...,
}
{
  &#34;_id&#34; : ObjectId(&#34;56f08c447fe58b2e96f595fb&#34;),
  &#34;country&#34; : &#34;UK&#34;,
  &#34;userid&#34; : 456,
  &#34;message&#34; : &#34;Good Morning&#34;
  ...,
}
{
  &#34;_id&#34; : ObjectId(&#34;56f08c447fe58b2e96f595fc&#34;),
  &#34;country&#34; : &#34;DE&#34;,
  &#34;userid&#34; : 789,
  &#34;message&#34; : &#34;Guten Tag&#34;
  ...,
}
</code></pre>

<h3>shard key</h3>

<p>messagesé›†åˆä½¿ç”¨{ country : 1, userid : 1 }ç»„åˆç´¢å¼•ä½œä¸ºshard keyã€‚
æ¯ä¸ªæ–‡æ¡£ä¸­çš„country å­—æ®µå…è®¸åœ¨æ¯ä¸ªä¸åŒçš„countryå€¼ä¸Šåˆ›å»ºæ ‡ç­¾èŒƒå›´ã€‚
ç›¸å¯¹äºcountryï¼Œuseridå­—æ®µä¸ºshard keyæä¾›ä¸€ä¸ªé«˜åŸºæ•°ä½é¢‘ç‡çš„å…ƒç´ </p>

<h3>å†™æ“ä½œ</h3>

<p>åœ¨Tagç›¸å…³çš„åˆ†ç‰‡ä¸­ï¼Œmongoså°†åˆ°æ¥çš„æ–‡æ¡£å’Œé…ç½®çš„tagèŒƒå›´æ¯”è¾ƒã€‚å¦‚æœæ–‡æ¡£ç¬¦åˆé…ç½®æ ‡ç­¾çš„èŒƒå›´ï¼Œmongoså°†æ­¤æ–‡æ¡£è·¯ç”±åˆ°æ­¤æ ‡ç­¾çš„åˆ†ç‰‡ä¸­
è¿™æ’å…¥ç¯èŠ‚ï¼ŒMongoDBå¯ä»¥å°†ä¸åˆæ ¼ä»»ä½•tagèŒƒå›´çš„æ–‡æ¡£è·¯ç”½®æ ‡ç­¾çš„èŒƒå›´ï¼Œmongoså°†æ­¤æ–‡æ¡£è·¯ç”±åˆ°æ­¤æ ‡ç­¾çš„åˆ†ç‰‡ä¸­
è¿™æ’å…¥ç¯èŠ‚ï¼ŒMongoDBå¯ä»¥å°†ä¸åˆæ ¼ä»»ä½•tagèŒƒå›´çš„æ–‡æ¡£è·¯ç”±åˆ°éšæœºçš„åˆ†ç‰‡ä¸­ã€‚</p>

<h3>è¯»æ“ä½œ</h3>

<p>å¦‚æœè¿™ä¸ªè¯·æ±‚è‡³å°‘åŒ…å«countryå­—æ®µï¼ŒMongoDBå¯ä»¥è·¯ç”±è¯·æ±‚åˆ°ç‰¹å®šçš„åˆ†ç‰‡ä¸­ã€‚
ä¾‹å¦‚MongoDBå¯ä»¥å°è¯•å¯¹ä»¥ä¸‹æŸ¥è¯¢æ‰§è¡Œæœ‰é’ˆå¯¹æ€§çš„è¯»å–æ“ä½œï¼š</p>

<pre><code>chatDB = db.getSiblingDB(&#34;chat&#34;)
chatDB.messages.find( { &#34;country&#34; : &#34;UK&#34; , &#34;userid&#34; : &#34;123&#34; } )
</code></pre>

<h3>å‡è¡¡å™¨</h3>

<p>å‡è¡¡å™¨è¿ç§»å¸¦æœ‰tagçš„å—ï¼ˆChunkï¼‰åˆ°é€‚åˆçš„åˆ†ç‰‡ï¼ˆshardï¼‰ã€‚åœ¨è¿ç§»ä¹‹å‰ï¼Œåˆ†ç‰‡å¯èƒ½åŒ…å«è¿åé…ç½®çš„tagå’ŒtagèŒƒå›´çš„å—ã€‚ä¸€æ—¦å¹³è¡¡å®Œæˆï¼Œç¢ç‰‡åº”åªåŒ…å«ä¸è¿åå…¶åˆ†é…çš„æ ‡è®°å’Œæ ‡è®°èŒƒå›´çš„å—ã€‚
æ·»åŠ ä¸ªåˆ é™¤æ ‡ç­¾å¯ä»¥å—çš„è¿ç§»ã€‚è¿™å–å†³äºæ•°æ®é›†çš„å¤§å°å’Œæ ‡è®°èŒƒå›´å½±å“çš„å—æ•°é‡ï¼Œè¿™äº›è¿ç§»å¯èƒ½ä¼šå½±å“é›†ç¾¤çš„æ€§èƒ½ã€‚</p>

<h2>æ“ä½œ</h2>

<h3>å–æ¶ˆå‡è¡¡å™¨</h3>

<p>ä¸ºäº†é™ä½æ€§èƒ½å½±å“ï¼Œå¯ä»¥åœ¨é›†åˆä¸Šç¦ç”¨å¹³è¡¡å™¨ï¼Œä»¥ç¡®ä¿åœ¨é…ç½®æ–°æ ‡è®°æ—¶ä¸ä¼šå‘ç”Ÿè¿ç§»ã€‚è€ƒè™‘åœ¨ç‰¹å®šçš„è®¡åˆ’çª—å£ä¸­è¿è¡Œå‡è¡¡å™¨ã€‚</p>

<pre><code>sh.disableBalancing(&#34;chat.message&#34;)
</code></pre>

<p>ä½¿ç”¨sh.isBalancerRunning()æ¥æ£€æŸ¥å¹³è¡¡å™¨è¿›ç¨‹å½“å‰æ˜¯å¦æ­£åœ¨è¿è¡Œã€‚ç­‰å¾…ä»»ä½•å½“å‰å¹³è¡¡å›åˆå®Œæˆåå†ç»§ç»­ã€‚</p>

<h3>ä¸ºæ¯ä¸€ä¸ªåˆ†ç‰‡æ·»åŠ æ ‡ç­¾</h3>

<p>````
sh.addShardTag(<shard name="">, â€œNAâ€)</shard></p>

<pre><code>æ‚¨å¯ä»¥é€šè¿‡è¿è¡Œsh.statusï¼ˆï¼‰æ¥æŸ¥çœ‹åˆ†é…ç»™ç»™å®šåˆ†ç‰‡çš„æ ‡ç­¾ã€‚

### å®šä¹‰æ ‡ç­¾èŒƒå›´
ä½¿ç”¨sh.addTagRange()æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•éœ€è¦ï¼š
- å®Œæˆçš„ç›®æ ‡collectionçš„åå­—
- èŒƒå›´çš„ä¸‹é™
- èŒƒå›´çš„ä¸Šé™
- æ ‡ç­¾çš„åå­—

</code></pre>

<p>sh.addTagRange(
  â€œchat.messagesâ€,
  { â€œcountryâ€ : â€œUSâ€, â€œuseridâ€ : MinKey },
  { â€œcountryâ€ : â€œUSâ€, â€œuseridâ€ : MaxKey },
  â€œNAâ€
)</p>

<pre><code>### å¼€å¯å‡è¡¡å™¨
</code></pre>

<p>sh.enableBalancing(â€œchat.messageâ€)
```
ä½¿ç”¨sh.isBalancerRunning()æ¥æ£€æŸ¥å¹³è¡¡å™¨è¿›ç¨‹å½“å‰æ˜¯å¦æ­£åœ¨è¿è¡Œ</p>

<h3>æŸ¥çœ‹æ›´æ”¹</h3>

<p>æ‚¨å¯ä»¥ä½¿ç”¨sh.status()</p>
</div>
</body>

</html>